<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>PDL Cockpit</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="PDL Cockpit" />
  <meta name="theme-color" content="#1a1d27" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    html, body, #root { height:100%; }
    body { background:#0f1117; transition:background .3s; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom); }
    * { -webkit-tap-highlight-color:transparent; }
    input, select, textarea { font-family:inherit; font-size:16px!important; }
    button { touch-action:manipulation; }
    button:active { opacity:.75; transform:scale(0.97); }
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-thumb { background:#2e3148; border-radius:99px; }
    .nav-item { min-height:48px; }
    @media(max-width:900px) and (min-width:481px) {
      .sidebar { width:64px!important; }
      .sidebar-label { display:none!important; }
      .sidebar-title { display:none!important; }
      .nav-item { justify-content:center!important; padding:12px 0!important; }
      .content-pad { padding:20px 14px!important; }
    }
    @media(max-width:480px) {
      .sidebar { display:none!important; }
      .mobile-nav { display:flex!important; }
      .content-pad { padding:16px 12px 80px!important; }
    }
    @media(min-width:481px) { .mobile-nav { display:none!important; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useCallback, useRef } = React;


// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const uid = () => Math.random().toString(36).slice(2, 10);
const todayStr = () => new Date().toISOString().slice(0, 10);
const fmtDate = (d) => d ? new Date(d + "T12:00:00").toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" }) : "‚Äì";
const fmtTime = (iso) => iso ? new Date(iso).toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" }) : "";
const fmtDateTime = (iso) => iso ? new Date(iso).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit" }) + " " + fmtTime(iso) : "";
const addDays = (d, n) => { const x = new Date(d + "T12:00:00"); x.setDate(x.getDate() + n); return x.toISOString().slice(0, 10); };
const addMonths = (d, n) => { const x = new Date(d + "T12:00:00"); x.setMonth(x.getMonth() + n); return x.toISOString().slice(0, 10); };
const RECUR_LABELS = { none: "Einmalig", daily: "T√§glich", weekly: "W√∂chentlich", monthly: "Monatlich", quarterly: "Quartalsweise" };
const PFLEGEGRADE = ["PG 1", "PG 2", "PG 3", "PG 4", "PG 5"];
const QUALIFIKATIONEN = ["Pflegefachkraft", "Pflegehelfer/in", "Wohnbereichsleitung", "Pflegedienstleitung", "Sozialdienst", "Hauswirtschaft", "Praktikant/in"];
const SCHICHTEN = ["Fr√ºhdienst", "Sp√§tdienst", "Nachtdienst", "Tagdienst"];
const PRIO = { low: { label: "Niedrig", color: "#8892a4" }, normal: { label: "Normal", color: "#3b82f6" }, high: { label: "Hoch", color: "#f59e0b" }, urgent: { label: "Dringend", color: "#ef4444" } };

function nextDue(date, recur) {
  if (!date || recur === "none") return date;
  if (recur === "daily")     return addDays(date, 1);
  if (recur === "weekly")    return addDays(date, 7);
  if (recur === "monthly")   return addMonths(date, 1);
  if (recur === "quarterly") return addMonths(date, 3);
  return date;
}

// ‚îÄ‚îÄ‚îÄ Design System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const THEMES = {
  dark: {
    bg: "#0f1117", surface: "#1a1d27", surface2: "#222536", border: "#2e3148",
    text: "#e8eaf0", muted: "#8892a4",
    blue: "#3b82f6", blueDim: "#1d4ed822",
    green: "#22c55e", greenDim: "#15803d22",
    yellow: "#eab308", yellowDim: "#85490822",
    red: "#ef4444", redDim: "#7f1d1d22",
    orange: "#f97316", purple: "#a855f7", purpleDim: "#6b21a822", cyan: "#06b6d4",
    wb: ["#3b82f6", "#22c55e", "#f59e0b", "#a855f7"],
    isDark: true,
  },
  light: {
    bg: "#f0f4f8", surface: "#ffffff", surface2: "#f0f4f8", border: "#dde3ed",
    text: "#1a1d2e", muted: "#6b7280",
    blue: "#2563eb", blueDim: "#2563eb18",
    green: "#16a34a", greenDim: "#16a34a18",
    yellow: "#d97706", yellowDim: "#d9770618",
    red: "#dc2626", redDim: "#dc262618",
    orange: "#ea580c", purple: "#7c3aed", purpleDim: "#7c3aed18", cyan: "#0891b2",
    wb: ["#2563eb", "#16a34a", "#d97706", "#7c3aed"],
    isDark: false,
  },
};

// D wird zur Laufzeit durch ThemeProvider bef√ºllt ‚Äî globale Referenz
let D = { ...THEMES.dark };

const ThemeContext = React.createContext({ theme: "dark", setTheme: () => {} });

const mono = { fontFamily: "'JetBrains Mono', 'Fira Mono', monospace" };
const sora = { fontFamily: "Inter, Segoe UI, sans-serif" };
const surfaceStyle = (extra = {}) => ({ background: D.surface, border: `1px solid ${D.border}`, borderRadius: 10, ...extra });

// ‚îÄ‚îÄ‚îÄ Roles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// role: "pdl" | "wbl-{wbId}" | "sl-{wbId}"
const ROLE_PDL = "pdl";
const roleIsWBL = (r) => r?.startsWith("wbl-");
const roleSL    = (r) => r?.startsWith("sl-");
const roleWbId  = (r) => r?.split("-")[1];
const canSeeFortbildung = (role) => role === ROLE_PDL || roleIsWBL(role);

// ‚îÄ‚îÄ‚îÄ Default PINs (will be overridden by stored config) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_PINS = () => ({
  pdl: "1234",
  wbl: { wb2: "2222", wb3: "3333", wb4: "4444", wb5: "5555" },
  sl:  { wb2: "2200", wb3: "3300", wb4: "4400", wb5: "5500" },
});

// ‚îÄ‚îÄ‚îÄ Shared Storage Keys ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SK_STATE   = "pdl-v5-state";
const SK_PINS    = "pdl-v5-pins";
const SK_MSGS    = "pdl-v5-messages";
const SK_FB_ARC  = "pdl-v5-fb-archive";
const SK_LOG     = "pdl-v5-tasklog";
const SK_PROC    = "pdl-v5-prozesse";

const LOG_DAYS  = 90;  // Aufgaben-Verlauf: 90 Tage
const MSG_DAYS  = 30;  // Nachrichten: 30 Tage
const MSG_LIMIT = 200; // Max. Zeichen pro Nachricht

function pruneOlderThan(items, days, tsField = "ts") {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);
  return items.filter(i => new Date(i[tsField]) > cutoff);
}
function pruneMessages(allMsgs) {
  const result = {};
  for (const [ch, msgs] of Object.entries(allMsgs)) {
    result[ch] = pruneOlderThan(msgs, MSG_DAYS);
  }
  return result;
}
function estimateKB(obj) {
  return Math.round(JSON.stringify(obj).length / 1024);
}

// Storage: shared (window.storage) mit Fallback auf sessionStorage
const LS_PREFIX = "pdl_local_";
async function sharedGet(key) {
  try {
    if (window.storage) {
      const r = await window.storage.get(key, true);
      if (r && r.value) return JSON.parse(r.value);
    }
  } catch(e) {}
  try { const v = sessionStorage.getItem(LS_PREFIX + key); if (v) return JSON.parse(v); } catch(e) {}
  return null;
}
async function sharedSet(key, val) {
  const str = JSON.stringify(val);
  try { if (window.storage) await window.storage.set(key, str, true); } catch(e) {}
  try { sessionStorage.setItem(LS_PREFIX + key, str); } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ Base State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WB_IDS = ["wb2", "wb3", "wb4", "wb5"];
const WB_NAMES_DEFAULT = { wb2: "Wohnbereich 2", wb3: "Wohnbereich 3", wb4: "Wohnbereich 4", wb5: "Wohnbereich 5" };

const defaultState = () => ({
  wohnbereiche: WB_IDS.map((id, i) => ({ id, name: WB_NAMES_DEFAULT[id], color: D.wb[i] })),
  bewohner: [], mitarbeiter: [], tasks: [], delegations: [], taskLog: [], prozesse: [],
  fbData: [],
  einrichtungsname: "Seniorenresidenz Musterstadt",
  einrichtungsnummer: "2140",
});

// ‚îÄ‚îÄ‚îÄ UI Components ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Inp = ({ style, ...p }) => <input style={{ width: "100%", background: D.surface2, border: `1px solid ${D.border}`, borderRadius: 7, color: D.text, padding: "8px 11px", fontSize: 13, boxSizing: "border-box", outline: "none", fontFamily: "inherit", marginBottom: 10, transition: "border-color .15s", ...style }} {...p} />;
const Sel = ({ style, children, ...p }) => <select style={{ width: "100%", background: D.surface2, border: `1px solid ${D.border}`, borderRadius: 7, color: D.text, padding: "8px 11px", fontSize: 13, boxSizing: "border-box", outline: "none", fontFamily: "inherit", marginBottom: 10, cursor: "pointer", transition: "border-color .15s", ...style }} {...p}>{children}</select>;
const Lbl = ({ children }) => <div style={{ fontSize: 10, fontWeight: 600, color: D.muted, letterSpacing: 1, textTransform: "uppercase", marginBottom: 5, ...mono }}>{children}</div>;
const Btn = ({ variant = "primary", color, style, children, ...p }) => {
  const base = { border: "none", borderRadius: 7, padding: "8px 16px", fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit", display: "inline-flex", alignItems: "center", gap: 6, transition: "opacity .15s, transform .1s" };
  const vs = { primary: { ...base, background: color || D.blue, color: "#fff" }, secondary: { ...base, background: D.isDark ? "transparent" : D.surface2, color: D.muted, border: `1px solid ${D.border}` }, ghost: { ...base, background: "transparent", color: D.muted, padding: "4px 8px" }, danger: { ...base, background: D.redDim, color: D.red, border: `1px solid ${D.red}40` } };
  return <button style={{ ...vs[variant], ...style }} {...p}>{children}</button>;
};
const Tag = ({ color, children, small }) => <span style={{ background: color + "20", color, border: `1px solid ${color}35`, borderRadius: 4, padding: small ? "1px 6px" : "3px 8px", fontSize: small ? 10 : 11, fontWeight: 600, ...mono }}>{children}</span>;

function SectionTitle({ children }) {
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 14 }}>
      <span style={{ fontSize: 10, fontWeight: 600, color: D.muted, letterSpacing: 1.5, textTransform: "uppercase", ...mono, whiteSpace: "nowrap" }}>{children}</span>
      <div style={{ flex: 1, height: 1, background: D.border }} />
    </div>
  );
}

function ProgressBar({ items, height = 4 }) {
  if (!items?.length) return null;
  const done = items.filter(i => i.done).length;
  const pct = Math.round(done / items.length * 100);
  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", fontSize: 10, color: D.muted, marginBottom: 3, ...mono }}>
        <span>{done}/{items.length} erledigt</span>
        <span style={{ color: pct === 100 ? D.green : D.muted }}>{pct}%</span>
      </div>
      <div style={{ background: D.border, borderRadius: 99, height, overflow: "hidden" }}>
        <div style={{ width: `${pct}%`, height: "100%", background: pct === 100 ? D.green : D.blue, borderRadius: 99, transition: "width .3s" }} />
      </div>
    </div>
  );
}

function Modal({ title, onClose, children, wide }) {
  return (
    <div style={{ position: "fixed", inset: 0, background: "#00000088", zIndex: 200, display: "flex", alignItems: "flex-start", justifyContent: "center", padding: "40px 16px", overflowY: "auto" }} onClick={onClose}>
      <div style={{ ...surfaceStyle({ padding: 28, width: "100%", maxWidth: wide ? 680 : 500, boxShadow: "0 32px 80px #00000070" }) }} onClick={e => e.stopPropagation()}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 22 }}>
          <div style={{ fontSize: 16, fontWeight: 700, color: D.text, ...sora }}>{title}</div>
          <Btn variant="ghost" onClick={onClose} style={{ fontSize: 20, padding: "2px 8px" }}>√ó</Btn>
        </div>
        {children}
      </div>
    </div>
  );
}


// ‚îÄ‚îÄ‚îÄ TOAST NOTIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function useToast() {
  const [toasts, setToasts] = React.useState([]);
  const show = React.useCallback((msg, type = "success") => {
    const id = uid();
    setToasts(t => [...t, { id, msg, type }]);
    setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 3000);
  }, []);
  const ToastContainer = () => (
    <div style={{ position:"fixed", bottom:24, right:24, zIndex:9999, display:"flex", flexDirection:"column", gap:8, pointerEvents:"none" }}>
      {toasts.map(t => (
        <div key={t.id} style={{
          background: t.type === "error" ? D.red : t.type === "warning" ? D.yellow : D.green,
          color:"#fff", borderRadius:8, padding:"10px 16px", fontSize:13, fontWeight:600,
          boxShadow:"0 4px 20px #0006", display:"flex", alignItems:"center", gap:8,
          animation:"slideIn .2s ease-out",
        }}>
          <span>{t.type==="error"?"‚ùå":t.type==="warning"?"‚ö†Ô∏è":"‚úÖ"}</span>
          {t.msg}
        </div>
      ))}
    </div>
  );
  return { show, ToastContainer };
}

// ‚îÄ‚îÄ‚îÄ Checklisten Templates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TEMPLATES = [
  { id: "tpl-pflegevisite", cat: "Qualit√§t", title: "Pflegevisite", recur: "monthly", color: D.blue, icon: "ü©∫", desc: "Monatliche Pflegevisite nach DNQP",
    items: [
      { text: "Aktuelle Pflegeplanung und SIS gepr√ºft", group: "Dokumentation" },
      { text: "Pflegeziele mit Bewohner/in besprochen und dokumentiert", group: "Dokumentation" },
      { text: "Medikamentenplan aktuell (Arzt-Unterschrift vorhanden)", group: "Dokumentation" },
      { text: "Dekubitusrisiko neu eingesch√§tzt (Braden-Skala)", group: "Risikoeinsch√§tzung" },
      { text: "Sturzrisiko neu eingesch√§tzt", group: "Risikoeinsch√§tzung" },
      { text: "Ern√§hrungszustand bewertet (Gewicht, MNA)", group: "Risikoeinsch√§tzung" },
      { text: "Schmerzeinsch√§tzung durchgef√ºhrt (NRS/BESD)", group: "Risikoeinsch√§tzung" },
      { text: "Individuelle Besonderheiten Junge Pflege ber√ºcksichtigt", group: "Junge Pflege" },
      { text: "Kommunikationsbed√ºrfnisse und Hilfsmittelversorgung gepr√ºft", group: "Junge Pflege" },
      { text: "Wundsituation beurteilt und dokumentiert", group: "Haut & Wunde" },
      { text: "Prophylaxen √ºberpr√ºft und angepasst", group: "Haut & Wunde" },
      { text: "Bewohner/Angeh√∂rige in Visite einbezogen", group: "Partizipation" },
      { text: "Visitenprotokoll vollst√§ndig ausgef√ºllt", group: "Abschluss" },
    ]
  },
  { id: "tpl-hygiene", cat: "Hygiene", title: "Hygienebegehung", recur: "monthly", color: D.cyan, icon: "üßπ", desc: "Monatliche Hygienebegehung Wohnbereich",
    items: [
      { text: "Handdesinfektionsmittelspender gef√ºllt und funktionst√ºchtig", group: "H√§ndehygiene" },
      { text: "Einmalhandschuhe in allen Gr√∂√üen vorhanden", group: "H√§ndehygiene" },
      { text: "Schutzkleidung ausreichend vorhanden", group: "Schutzkleidung" },
      { text: "Medikamentenschrank sauber, geordnet, verschlossen", group: "Medikamente" },
      { text: "K√ºhlschrank Temperatur dokumentiert (2‚Äì8¬∞C)", group: "Medikamente" },
      { text: "Verbandmaterial geordnet und nicht abgelaufen", group: "Wundversorgung" },
      { text: "Pflegehilfsmittel sauber und gepflegt", group: "Hilfsmittel" },
      { text: "Rollst√ºhle, Rollatoren gereinigt", group: "Hilfsmittel" },
      { text: "Badezimmer: Oberfl√§chen gereinigt, keine Schimmelbildung", group: "R√§ume" },
      { text: "Flure frei von Hindernissen", group: "R√§ume" },
      { text: "Abfallentsorgung korrekt", group: "Entsorgung" },
      { text: "W√§schekreislauf eingehalten (rein/unrein getrennt)", group: "W√§sche" },
      { text: "Hygieneplan aush√§ngt und aktuell", group: "Dokumentation" },
    ]
  },
  { id: "tpl-wunddoku", cat: "Wundversorgung", title: "Wunddokumentation pr√ºfen", recur: "weekly", color: D.orange, icon: "ü©π", desc: "W√∂chentliche Wunddoku-Kontrolle",
    items: [
      { text: "Alle aktiven Wunden erfasst", group: "Vollst√§ndigkeit" },
      { text: "Wundfoto aktuell (max. 7 Tage alt)", group: "Vollst√§ndigkeit" },
      { text: "Wundgr√∂√üe eingetragen", group: "Wundbeurteilung" },
      { text: "Wundgrund beschrieben", group: "Wundbeurteilung" },
      { text: "Wundbehandlungsplan √§rztlich angeordnet und aktuell", group: "Anordnung" },
      { text: "Lagerungsplan aktuell und wird durchgef√ºhrt", group: "Dekubitus" },
      { text: "Arzt informiert bei Verschlechterung oder Infektzeichen", group: "Eskalation" },
    ]
  },
  { id: "tpl-mdk", cat: "MDK", title: "MDK-Vorbereitung", recur: "none", color: D.red, icon: "üìã", desc: "Vorbereitung MDK-Pr√ºfung nach QPR",
    items: [
      { text: "Aktuelle Bewohnerliste mit Pflegegraden vollst√§ndig", group: "Stammdaten" },
      { text: "Personalschl√ºssel und Dienstpl√§ne letzte 3 Monate bereit", group: "Stammdaten" },
      { text: "Nachweise Qualifikationen Mitarbeitende aktuell", group: "Stammdaten" },
      { text: "Hygieneplan aktuell und unterschrieben", group: "Qualit√§tsdokumente" },
      { text: "Einrichtungskonzept aktuell", group: "Qualit√§tsdokumente" },
      { text: "Expertenstandards implementiert und nachweisbar", group: "Expertenstandards" },
      { text: "Stichprobe 3 Pflegedokumentationen pr√ºfen", group: "Pflegedokumentation" },
      { text: "Ma√ünahmen FEM rechtssicher dokumentiert", group: "Rechtssicherheit" },
      { text: "BTM-Buch korrekt gef√ºhrt", group: "Arzneimittel" },
      { text: "Beschwerdemanagement-Nachweise vorhanden", group: "Qualit√§t" },
    ]
  },
  { id: "tpl-dekubitus", cat: "Expertenstandard", title: "Dekubitusprophylaxe", recur: "monthly", color: D.purple, icon: "üõ°", desc: "DNQP Expertenstandard",
    items: [
      { text: "Risikoeinsch√§tzung mit Braden-Skala durchgef√ºhrt", group: "Einsch√§tzung" },
      { text: "Risikoeinsch√§tzung bei Zustandsver√§nderung wiederholt", group: "Einsch√§tzung" },
      { text: "Druckentlastende Ma√ünahmen schriftlich geplant", group: "Planung" },
      { text: "Lagerungsintervall und -plan individuell festgelegt", group: "Planung" },
      { text: "Geeignete Hilfsmittel verordnet und vorhanden", group: "Hilfsmittel" },
      { text: "Hautinspektion t√§glich und dokumentiert", group: "√úberwachung" },
      { text: "Durchf√ºhrung Lagerung dokumentiert", group: "Durchf√ºhrung" },
      { text: "Bei Dekubitus: Arzt informiert, Wundbehandlung angeordnet", group: "Eskalation" },
    ]
  },
  { id: "tpl-sturz", cat: "Expertenstandard", title: "Sturzprophylaxe", recur: "monthly", color: D.yellow, icon: "‚ö†Ô∏è", desc: "DNQP Expertenstandard",
    items: [
      { text: "Sturzrisikoeinsch√§tzung bei Aufnahme dokumentiert", group: "Einsch√§tzung" },
      { text: "Sturzereignisse vollst√§ndig im Sturzprotokoll erfasst", group: "Dokumentation" },
      { text: "Sturzanalyse nach jedem Sturz durchgef√ºhrt", group: "Dokumentation" },
      { text: "Individueller Ma√ünahmenplan erstellt und aktuell", group: "Ma√ünahmen" },
      { text: "H√ºftprotektoren bei Indikation vorhanden und getragen", group: "Hilfsmittel" },
      { text: "Bewohnerumgebung auf Stolperfallen gepr√ºft", group: "Umgebung" },
      { text: "Bewohner und Angeh√∂rige √ºber Sturzrisiko informiert", group: "Information" },
    ]
  },
  { id: "tpl-schmerz", cat: "Expertenstandard", title: "Schmerzmanagement", recur: "monthly", color: "#ec4899", icon: "üíä", desc: "DNQP Expertenstandard",
    items: [
      { text: "Schmerzeinsch√§tzung bei Aufnahme (NRS / BESD)", group: "Einsch√§tzung" },
      { text: "Schmerzlokalisation und -charakteristik dokumentiert", group: "Einsch√§tzung" },
      { text: "Schmerzbehandlungsplan √§rztlich angeordnet und aktuell", group: "Behandlung" },
      { text: "Wirksamkeit Schmerzbehandlung regelm√§√üig evaluiert", group: "Evaluation" },
      { text: "Nichtmedikament√∂se Ma√ünahmen durchgef√ºhrt", group: "Ma√ünahmen" },
    ]
  },
  { id: "tpl-ernaehrung", cat: "Expertenstandard", title: "Ern√§hrungsmanagement", recur: "monthly", color: D.green, icon: "ü•ó", desc: "DNQP Expertenstandard",
    items: [
      { text: "Ern√§hrungsscreening bei Aufnahme und monatlich (MNA)", group: "Screening" },
      { text: "Gewicht w√∂chentlich erfasst und dokumentiert", group: "Monitoring" },
      { text: "Gewichtsverlauf ausgewertet", group: "Monitoring" },
      { text: "Individuelle Kostform √§rztlich verordnet", group: "Versorgung" },
      { text: "Schluckst√∂rung eingesch√§tzt, Anpassung dokumentiert", group: "Versorgung" },
    ]
  },
];

// ‚îÄ‚îÄ‚îÄ Fortbildung helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FB_COLORS = ['#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#84cc16','#a855f7'];
const QUAL_GRUPPE = {
  // ‚îÄ‚îÄ Pflegefachkr√§fte ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Pflegedienstleitung':'Pflegefachkr√§fte',
  'PDL':'Pflegefachkr√§fte',
  'Pflegedienstleiterin':'Pflegefachkr√§fte',
  'Wohnbereichsleitung':'Pflegefachkr√§fte',
  'Wohnbereichsleiterin':'Pflegefachkr√§fte',
  'WBL':'Pflegefachkr√§fte',
  'Pflegefachkraft':'Pflegefachkr√§fte',
  'Pflegefachfrau':'Pflegefachkr√§fte',
  'Pflegefachmann':'Pflegefachkr√§fte',
  'Gesundheits- und Krankenpfleger':'Pflegefachkr√§fte',
  'Gesundheits- und Krankenpflegerin':'Pflegefachkr√§fte',
  'Krankenpfleger':'Pflegefachkr√§fte',
  'Krankenschwester':'Pflegefachkr√§fte',
  'Altenpfleger':'Pflegefachkr√§fte',
  'Altenpflegerin':'Pflegefachkr√§fte',
  'Praxisanleiter':'Pflegefachkr√§fte',
  'Praxisanleiterin':'Pflegefachkr√§fte',
  'Stationsleitung':'Pflegefachkr√§fte',
  'Teamleitung Pflege':'Pflegefachkr√§fte',

  // ‚îÄ‚îÄ Pflegefachassistent ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Pflegefachassistent':'Pflegefachassistent',
  'Pflegefachassistentin':'Pflegefachassistent',
  'Altenpflegeassistent':'Pflegefachassistent',
  'Altenpflegeassistentin':'Pflegefachassistent',
  'Pflegeassistent':'Pflegefachassistent',
  'Pflegeassistentin':'Pflegefachassistent',

  // ‚îÄ‚îÄ Pflegehilfskraft ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Pflegehelfer/in':'Pflegehilfskraft',
  'Pflegehelfer':'Pflegehilfskraft',
  'Pflegehelferin':'Pflegehilfskraft',
  'Pflegehilfskraft':'Pflegehilfskraft',
  'Pflegehilfskr√§fte':'Pflegehilfskraft',
  'Pflegehilfe':'Pflegehilfskraft',
  'Pflegeunterst√ºtzungskraft':'Pflegehilfskraft',
  'Betreuungsassistent':'Pflegehilfskraft',
  'Betreuungsassistentin':'Pflegehilfskraft',
  'Alltagsbegleiter':'Pflegehilfskraft',
  'Alltagsbegleiterin':'Pflegehilfskraft',

  // ‚îÄ‚îÄ Soziale Betreuung ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Sozialdienst':'Soziale Betreuung',
  'Soziale Betreuung':'Soziale Betreuung',
  'Sozialbetreuung':'Soziale Betreuung',
  'Sozialbetreuer':'Soziale Betreuung',
  'Sozialbetreuerin':'Soziale Betreuung',
  'Betreuungskraft':'Soziale Betreuung',
  'Sozialarbeit':'Soziale Betreuung',
  'Sozialarbeiter':'Soziale Betreuung',
  'Sozialarbeiterin':'Soziale Betreuung',
  'Ergotherapeut':'Soziale Betreuung',
  'Ergotherapeutin':'Soziale Betreuung',

  // ‚îÄ‚îÄ Servicemitarbeiter Pflege / Hauswirtschaft ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Hauswirtschaft':'Servicemitarbeiter Pflege',
  'Hauswirtschafterin':'Servicemitarbeiter Pflege',
  'Hauswirtschaftskraft':'Servicemitarbeiter Pflege',
  'Hauswirtschaftsleitung':'Servicemitarbeiter Pflege',
  'Servicemitarbeiter':'Servicemitarbeiter Pflege',
  'Servicemitarbeiterin':'Servicemitarbeiter Pflege',
  'Servicekraft':'Servicemitarbeiter Pflege',
  'Pflegehilfsdienst':'Servicemitarbeiter Pflege',

  // ‚îÄ‚îÄ K√ºche ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'K√ºche':'K√ºche',
  'Koch':'K√ºche',
  'K√∂chin':'K√ºche',
  'K√ºchenleitung':'K√ºche',
  'K√ºchenhelfer':'K√ºche',
  'K√ºchenhelferin':'K√ºche',
  'K√ºchenangestellte':'K√ºche',
  'K√ºchenangestellter':'K√ºche',
  'K√ºchenassistent':'K√ºche',
  'K√ºchenassistentin':'K√ºche',
  'Hauswirtschaft/K√ºche':'K√ºche',
  'Di√§tassistent':'K√ºche',
  'Di√§tassistentin':'K√ºche',

  // ‚îÄ‚îÄ Reinigung ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Reinigung':'Reinigung',
  'Reinigungskraft':'Reinigung',
  'Reinigungsmitarbeiter':'Reinigung',
  'Reinigungsmitarbeiterin':'Reinigung',
  'Geb√§udereiniger':'Reinigung',
  'Geb√§udereinigerin':'Reinigung',
  'Geb√§udereinigung':'Reinigung',
  'Hausreinigung':'Reinigung',
  'Unterhaltsreinigung':'Reinigung',
  'Reinigungshelfer':'Reinigung',
  'Reinigungshelferin':'Reinigung',

  // ‚îÄ‚îÄ Haustechnik ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Haustechnik':'Haustechnik',
  'Haustechniker':'Haustechnik',
  'Haustechnikerin':'Haustechnik',
  'Hausmeister':'Haustechnik',
  'Hausmeisterin':'Haustechnik',
  'Technischer Dienst':'Haustechnik',
  'Technischer Mitarbeiter':'Haustechnik',
  'Technische Mitarbeiterin':'Haustechnik',
  'Facility Management':'Haustechnik',
  'Facility Manager':'Haustechnik',
  'Haustechnik/Hausmeister':'Haustechnik',

  // ‚îÄ‚îÄ Verwaltung ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Verwaltung':'Verwaltung',
  'Verwaltungskraft':'Verwaltung',
  'Verwaltungsmitarbeiter':'Verwaltung',
  'Verwaltungsmitarbeiterin':'Verwaltung',
  'Sekretariat':'Verwaltung',
  'Sekret√§rin':'Verwaltung',
  'B√ºroangestellte':'Verwaltung',
  'B√ºroangestellter':'Verwaltung',
  'Buchhalter':'Verwaltung',
  'Buchhalterin':'Verwaltung',
  'Heimleitung':'Verwaltung',
  'Einrichtungsleitung':'Verwaltung',

  // ‚îÄ‚îÄ Auszubildende ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'Praktikant/in':'Auszubildende',
  'Praktikant':'Auszubildende',
  'Praktikantin':'Auszubildende',
  'Auszubildende':'Auszubildende',
  'Auszubildender':'Auszubildende',
  'Azubi':'Auszubildende',
  'Sch√ºler':'Auszubildende',
  'Sch√ºlerin':'Auszubildende',
  'FSJ':'Auszubildende',
  'Freiwilliges Soziales Jahr':'Auszubildende',
  'BFD':'Auszubildende',
  'Bundesfreiwilligendienst':'Auszubildende',
};
function fbColor(name) { let h = 0; for (let c of name) h = (h * 31 + c.charCodeAt(0)) & 0xffff; return FB_COLORS[h % FB_COLORS.length]; }
function fbInitials(v, n) { return (n[0]||'').toUpperCase()+(v[0]||'').toUpperCase(); }
function fbPct(tr) { return tr.length ? Math.round(tr.filter(t=>t.status.toLowerCase().includes('bestanden')).length/tr.length*100) : 0; }
function fbPctColor(p) { return p >= 70 ? D.green : p >= 30 ? D.yellow : D.red; }

function parseCSV(text) {
  let lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  if (lines[0].toLowerCase().startsWith('sep=')) lines.shift();
  const header = lines.shift().split(';').map(h=>h.replace(/"/g,'').trim());
  const map = { nachname:['nachname'],vorname:['vorname'],titel:['trainingstitel','titel','kursname'],status:['status'],datum:['abgeschlossen am','abschlussdatum','datum'],qualifikation:['qualifikation','position','stelle'] };
  const ci = {};
  for (const [k,vs] of Object.entries(map)) ci[k]=header.findIndex(h=>vs.some(v=>h.toLowerCase().includes(v)));
  const rows = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(';').map(c=>c.replace(/^"|"$/g,'').trim());
    if (cols.length<3) continue;
    rows.push({ nachname:cols[ci.nachname]||'',vorname:cols[ci.vorname]||'',titel:cols[ci.titel]||'',status:cols[ci.status]||'',datum:cols[ci.datum]||'',qualifikation:ci.qualifikation>=0?cols[ci.qualifikation]||'':'' });
  }
  return rows;
}

function buildPersons(rows) {
  const p = {};
  for (const r of rows) { const k=r.nachname+'|'+r.vorname; if (!p[k]) p[k]={nachname:r.nachname,vorname:r.vorname,trainings:[]}; p[k].trainings.push(r); }
  for (const person of Object.values(p)) {
    person.qualifikation = person.trainings[0]?.qualifikation || '‚Äì';
    // Exakte Zuordnung
    let gruppe = QUAL_GRUPPE[person.qualifikation];
    // Unscharfe Zuordnung falls Bezeichnung leicht abweicht
    if (!gruppe && person.qualifikation !== '‚Äì') {
      const q = person.qualifikation.toLowerCase();
      if (q.includes('k√ºche') || q.includes('koch') || q.includes('k√∂ch') || q.includes('di√§tass')) gruppe = 'K√ºche';
      else if (q.includes('reinig') || q.includes('geb√§ude')) gruppe = 'Reinigung';
      else if (q.includes('haustech') || q.includes('hausmeist') || q.includes('facility')) gruppe = 'Haustechnik';
      else if (q.includes('pdl') || q.includes('pflegedienstleit') || q.includes('wohnbereichsleit') || q.includes('praxisanleit') || q.includes('stationsleitung')) gruppe = 'Pflegefachkr√§fte';
      else if (q.includes('fachassist') || q.includes('pflegeassist')) gruppe = 'Pflegefachassistent';
      else if (q.includes('pflegehilf') || q.includes('pflegehelfer') || q.includes('betreuungsassist') || q.includes('alltagsbegleit')) gruppe = 'Pflegehilfskraft';
      else if (q.includes('pflege') && (q.includes('fach') || q.includes('kraft') || q.includes('mann') || q.includes('frau') || q.includes('altenpfleg') || q.includes('kranken'))) gruppe = 'Pflegefachkr√§fte';
      else if (q.includes('sozial') || q.includes('betreuung') || q.includes('ergother')) gruppe = 'Soziale Betreuung';
      else if (q.includes('hauswirt') || q.includes('service')) gruppe = 'Servicemitarbeiter Pflege';
      else if (q.includes('verwalt') || q.includes('sekret') || q.includes('b√ºro') || q.includes('buchhal') || q.includes('heimleit') || q.includes('einrichtungsleit')) gruppe = 'Verwaltung';
      else if (q.includes('azubi') || q.includes('auszubild') || q.includes('praktik') || q.includes('sch√ºler') || q.includes('fsj') || q.includes('bfd')) gruppe = 'Auszubildende';
      else gruppe = 'Sonstige';
    }
    person.gruppe = gruppe || 'Sonstige';
  }
  return p;
}

// ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function LoginScreen({ onLogin, wbNames, pins = DEFAULT_PINS() }) {
  const [pin, setPin] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const tryLogin = async () => {
    if (!pin) return;
    setLoading(true);
    const stored = await sharedGet(SK_PINS) || DEFAULT_PINS();
    // Check PDL
    if (pin === stored.pdl) { onLogin(ROLE_PDL); return; }
    // Check WBL & SL
    for (const wbId of WB_IDS) {
      if (pin === stored.wbl[wbId]) { onLogin(`wbl-${wbId}`); return; }
      if (pin === stored.sl[wbId])  { onLogin(`sl-${wbId}`);  return; }
    }
    setError("PIN nicht erkannt. Bitte nochmal versuchen.");
    setPin("");
    setLoading(false);
  };

  return (
    <div style={{ minHeight: "100vh", background: D.bg, display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "Inter, Segoe UI, sans-serif" }}>
      <div style={{ ...surfaceStyle({ padding: "40px 36px", maxWidth: 380, width: "100%" }) }}>
        <div style={{ textAlign: "center", marginBottom: 32 }}>
          <div style={{ fontSize: 36, marginBottom: 12 }}>üè•</div>
          <div style={{ fontSize: 20, fontWeight: 700, color: D.text }}>PDL Cockpit</div>
          <div style={{ fontSize: 11, color: D.muted, marginTop: 4, ...mono }}>Digitales Cockpit f√ºr die Pflege</div>
        </div>
        <Lbl>PIN eingeben</Lbl>
        <input
          type="password" value={pin} onChange={e => { setPin(e.target.value); setError(""); }}
          onKeyDown={e => e.key === "Enter" && tryLogin()}
          placeholder="¬∑¬∑¬∑¬∑" maxLength={8}
          style={{ width: "100%", background: D.surface2, border: `1px solid ${error ? D.red : D.border}`, borderRadius: 7, color: D.text, padding: "12px 14px", fontSize: 20, boxSizing: "border-box", outline: "none", fontFamily: "'JetBrains Mono','Fira Mono',monospace", marginBottom: 8, letterSpacing: 6, textAlign: "center" }}
          autoFocus
        />
        {error && <div style={{ fontSize: 12, color: D.red, marginBottom: 10, textAlign: "center" }}>{error}</div>}
        <Btn onClick={tryLogin} style={{ width: "100%", justifyContent: "center", padding: "11px", fontSize: 14, marginTop: 4 }}>
          {loading ? "‚Ä¶" : "Anmelden"}
        </Btn>
        <div style={{ marginTop: 28, paddingTop: 20, borderTop: `1px solid ${D.border}` }}>
          <div style={{ fontSize: 10, color: D.muted, textAlign: "center", ...mono, marginBottom: 12 }}>Demo-Zug√§nge</div>
          <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"7px 10px", background:D.surface2, borderRadius:7 }}>
              <span style={{ fontSize: 12, color: D.text, fontWeight:600 }}>üë©‚Äçüíº PDL</span>
              <div style={{ display:"flex", gap:6 }}>
                <span onClick={() => { setPin(pins.pdl); setError(""); }} style={{ ...mono, fontSize: 13, color: D.blue, background: D.blueDim, padding:"2px 10px", borderRadius:5, cursor:"pointer", fontWeight:700 }}>{pins.pdl}</span>
              </div>
            </div>
            {WB_IDS.map((id, i) => (
              <div key={id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"7px 10px", background:D.surface2, borderRadius:7 }}>
                <span style={{ fontSize: 12, color: D.text }}>{wbNames[id] || `Wohnbereich ${i+2}`}</span>
                <div style={{ display:"flex", gap:6 }}>
                  <span onClick={() => { setPin(pins.wbl[id]); setError(""); }} style={{ ...mono, fontSize: 11, color: D.green, background: D.greenDim, padding:"2px 8px", borderRadius:5, cursor:"pointer" }}>WBL {pins.wbl[id]}</span>
                  <span onClick={() => { setPin(pins.sl[id]); setError(""); }} style={{ ...mono, fontSize: 11, color: D.muted, background: D.surface, border:`1px solid ${D.border}`, padding:"2px 8px", borderRadius:5, cursor:"pointer" }}>SL {pins.sl[id]}</span>
                </div>
              </div>
            ))}
          </div>
          <div style={{ fontSize: 10, color: D.muted, textAlign:"center", marginTop:10, ...mono }}>Tipp: PIN antippen zum automatischen Einf√ºgen</div>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ CHAT VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ChatView({ role, wbId, wbName, wbColor, allMessages, onSend, taskContext, onClearTaskContext }) {
  const [text, setText] = useState("");
  const bottomRef = useRef(null);

  // Filter messages for this channel
  const channelId = wbId;
  const msgs = (allMessages[channelId] || []);

  useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: "smooth" }); }, [msgs.length]);

  const send = () => {
    if (!text.trim()) return;
    const msg = {
      id: uid(), channelId, text: text.trim(),
      author: role === ROLE_PDL ? "PDL" : roleIsWBL(role) ? "WBL" : "Schichtleitung",
      role, ts: new Date().toISOString(),
      taskRef: taskContext || null,
    };
    onSend(msg);
    setText("");
    if (taskContext) onClearTaskContext();
  };

  return (
    <div style={{ display: "flex", flexDirection: "column", height: "100%" }}>
      {/* Header */}
      <div style={{ padding: "0 0 16px 0", borderBottom: `1px solid ${D.border}`, marginBottom: 16 }}>
        <div style={{ fontSize: 15, fontWeight: 700, color: wbColor || D.text }}>{wbName}</div>
        <div style={{ fontSize: 11, color: D.muted, ...mono, marginTop: 2 }}>Nachrichten ¬∑ PDL ‚Üî Wohnbereich</div>
      </div>

      {/* Task context banner */}
      {taskContext && (
        <div style={{ background: D.blueDim, border: `1px solid ${D.blue}40`, borderRadius: 7, padding: "8px 12px", marginBottom: 10, fontSize: 12, color: D.blue, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span>üìã R√ºckmeldung zu: <strong>{taskContext.title}</strong></span>
          <Btn variant="ghost" style={{ color: D.blue, padding: "0 4px" }} onClick={onClearTaskContext}>√ó</Btn>
        </div>
      )}

      {/* Messages */}
      <div style={{ flex: 1, overflowY: "auto", display: "flex", flexDirection: "column", gap: 8, paddingBottom: 8 }}>
        {msgs.length === 0 && (
          <div style={{ textAlign: "center", padding: "40px 0", color: D.muted, fontSize: 13 }}>
            Noch keine Nachrichten.<br/>Schreibe die erste Nachricht.
          </div>
        )}
        {msgs.map(m => {
          const isMe = m.role === role;
          const isPDL = m.role === ROLE_PDL;
          return (
            <div key={m.id} style={{ display: "flex", flexDirection: "column", alignItems: isMe ? "flex-end" : "flex-start" }}>
              {m.taskRef && (
                <div style={{ fontSize: 10, color: D.muted, marginBottom: 3, ...mono }}>üìã {m.taskRef.title}</div>
              )}
              <div style={{ maxWidth: "80%", background: isMe ? D.blue + "30" : D.surface2, border: `1px solid ${isMe ? D.blue + "50" : D.border}`, borderRadius: 8, padding: "8px 12px" }}>
                <div style={{ fontSize: 12, color: isPDL ? D.blue : D.green, fontWeight: 600, marginBottom: 3, ...mono }}>{m.author}</div>
                <div style={{ fontSize: 13, color: D.text, lineHeight: 1.5 }}>{m.text}</div>
              </div>
              <div style={{ fontSize: 10, color: D.muted, marginTop: 2, ...mono }}>{fmtDateTime(m.ts)}</div>
            </div>
          );
        })}
        <div ref={bottomRef} />
      </div>

      {/* Post-It Input */}
      <div style={{ borderTop: `1px solid ${D.border}`, paddingTop: 12 }}>
        <div style={{ position: "relative" }}>
          <input value={text} onChange={e => setText(e.target.value.slice(0, MSG_LIMIT))} onKeyDown={e => e.key === "Enter" && !e.shiftKey && send()}
            placeholder="Kurze Notiz‚Ä¶ (max. 200 Zeichen, Enter senden)"
            style={{ width: "100%", background: D.surface2, border: `1px solid ${text.length > 180 ? D.yellow : D.border}`, borderRadius: 7, color: D.text, padding: "9px 12px", paddingRight: 50, fontSize: 13, outline: "none", fontFamily: "inherit", boxSizing: "border-box" }} />
          <span style={{ position: "absolute", right: 10, top: "50%", transform: "translateY(-50%)", fontSize: 10, color: text.length > 180 ? D.yellow : D.muted, ...mono }}>{text.length}/{MSG_LIMIT}</span>
        </div>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 6 }}>
          <span style={{ fontSize: 10, color: D.muted, ...mono }}>Nachrichten werden nach 30 Tagen automatisch gel√∂scht</span>
          <Btn onClick={send} color={wbColor || D.blue} style={{ padding: "6px 14px", fontSize: 12 }}>Senden</Btn>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ PDL NACHRICHTEN √úBERSICHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function PDLChatOverview({ state, allMessages, onSend, role }) {
  const [activeWbId, setActiveWbId] = useState(null);
  const [taskContext, setTaskContext] = useState(null);

  const wb = activeWbId ? state.wohnbereiche.find(w => w.id === activeWbId) : null;

  if (activeWbId && wb) return (
    <div style={{ display: "flex", flexDirection: "column", height: 600 }}>
      <Btn variant="ghost" onClick={() => setActiveWbId(null)} style={{ color: D.blue, padding: 0, marginBottom: 16, alignSelf: "flex-start" }}>‚Üê Alle Kan√§le</Btn>
      <ChatView role={role} wbId={activeWbId} wbName={wb.name} wbColor={wb.color}
        allMessages={allMessages} onSend={onSend} taskContext={taskContext} onClearTaskContext={() => setTaskContext(null)} />
    </div>
  );

  return (
    <div>
      <div style={{ fontSize: 18, fontWeight: 700, color: D.text, marginBottom: 6, ...sora }}>Nachrichten</div>
      <div style={{ fontSize: 12, color: D.muted, marginBottom: 20 }}>Alle Kan√§le zwischen dir und den Wohnbereichen.</div>
      {state.wohnbereiche.map(wb => {
        const msgs = allMessages[wb.id] || [];
        const last = msgs[msgs.length - 1];
        const unread = msgs.filter(m => m.role !== ROLE_PDL).length;
        return (
          <div key={wb.id} onClick={() => setActiveWbId(wb.id)}
            style={{ ...surfaceStyle({ padding: "14px 18px", marginBottom: 8, cursor: "pointer", borderLeft: `3px solid ${wb.color}` }) }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, color: wb.color }}>{wb.name}</div>
                {last
                  ? <div style={{ fontSize: 12, color: D.muted, marginTop: 3 }}><span style={{ ...mono, color: D.muted }}>{last.author}:</span> {last.text.slice(0, 60)}{last.text.length > 60 ? "‚Ä¶" : ""}</div>
                  : <div style={{ fontSize: 12, color: D.muted, marginTop: 3 }}>Noch keine Nachrichten</div>
                }
              </div>
              <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-end", gap: 4 }}>
                {last && <div style={{ fontSize: 10, color: D.muted, ...mono }}>{fmtDateTime(last.ts)}</div>}
                {unread > 0 && <div style={{ background: wb.color, color: "#fff", borderRadius: 99, fontSize: 10, fontWeight: 700, padding: "2px 7px", ...mono }}>{msgs.length}</div>}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ AUFGABEN VIEW (shared between roles) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ AUFGABEN SUBKOMPONENTEN (top-level to avoid hooks-in-closure bug) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TaskFormModal({ state, wbId, isPDL, now, saveTask, onClose }) {
  const [f, setF] = useState({ id: uid(), title: "", due: now, recur: "none", notes: "", status: "open", checklist: [], templateId: "", wbId: wbId || "", assignedTo: "" });
  const [newItem, setNewItem] = useState("");
  const loadTpl = (id) => { const t = TEMPLATES.find(x => x.id === id); if (t) setF(p => ({ ...p, title: t.title, recur: t.recur, templateId: id, checklist: t.items.map(i => ({ text: i.text, group: i.group, done: false })) })); };
  const addItem = () => { if (!newItem.trim()) return; setF(p => ({ ...p, checklist: [...p.checklist, { text: newItem.trim(), group: "Manuell", done: false }] })); setNewItem(""); };
  return (
    <Modal title="Neue Aufgabe" onClose={onClose} wide>
      <Lbl>Aus Vorlage laden</Lbl>
      <Sel value={f.templateId} onChange={e => loadTpl(e.target.value)}>
        <option value="">‚Äì Vorlage w√§hlen ‚Äì</option>
        {TEMPLATES.map(t => <option key={t.id} value={t.id}>{t.icon} {t.title}</option>)}
      </Sel>
      <Lbl>Titel *</Lbl><Inp value={f.title} onChange={e => setF(p => ({ ...p, title: e.target.value }))} placeholder="Aufgabenbezeichnung‚Ä¶" />
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
        <div><Lbl>F√§llig am</Lbl><Inp type="date" value={f.due} onChange={e => setF(p => ({ ...p, due: e.target.value }))} /></div>
        <div><Lbl>Wiederholung</Lbl><Sel value={f.recur} onChange={e => setF(p => ({ ...p, recur: e.target.value }))}>{Object.entries(RECUR_LABELS).map(([k,v]) => <option key={k} value={k}>{v}</option>)}</Sel></div>
      </div>
      {isPDL && (
        <>
          <Lbl>Zuweisen an Wohnbereich</Lbl>
          <Sel value={f.assignedTo} onChange={e => setF(p => ({ ...p, assignedTo: e.target.value }))}>
            <option value="">‚Äì Kein (allgemein) ‚Äì</option>
            {state.wohnbereiche.map(wb => <option key={wb.id} value={wb.id}>{wb.name}</option>)}
          </Sel>
        </>
      )}
      <Lbl>Notizen</Lbl>
      <textarea value={f.notes} onChange={e => setF(p => ({ ...p, notes: e.target.value }))} placeholder="Hinweise, Kontext‚Ä¶"
        style={{ width: "100%", background: D.surface2, border: `1px solid ${D.border}`, borderRadius: 7, color: D.text, padding: "8px 11px", fontSize: 13, boxSizing: "border-box", outline: "none", fontFamily: "inherit", marginBottom: 10, height: 60, resize: "vertical" }} />
      {f.checklist.length > 0 && (
        <div style={{ maxHeight: 160, overflowY: "auto", border: `1px solid ${D.border}`, borderRadius: 7, padding: "8px 12px", marginBottom: 10 }}>
          {f.checklist.map((item, idx) => (
            <div key={idx} style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "3px 0", color: D.muted }}>
              <span>‚òê {item.text}</span>
              <Btn variant="ghost" style={{ padding: "0 4px", color: D.border, fontSize: 14 }} onClick={() => setF(p => ({ ...p, checklist: p.checklist.filter((_,i)=>i!==idx) }))}>√ó</Btn>
            </div>
          ))}
        </div>
      )}
      <div style={{ display: "flex", gap: 8, marginBottom: 14 }}>
        <Inp style={{ marginBottom: 0, flex: 1 }} value={newItem} onChange={e => setNewItem(e.target.value)} onKeyDown={e => e.key === "Enter" && addItem()} placeholder="Checkpunkt hinzuf√ºgen‚Ä¶" />
        <Btn variant="secondary" onClick={addItem}>Ôºã</Btn>
      </div>
      <div style={{ display: "flex", gap: 10 }}>
        <Btn style={{ flex: 1 }} onClick={() => f.title && saveTask({ ...f, wbId: f.assignedTo || f.wbId || wbId || "" })}>Erstellen</Btn>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
      </div>
    </Modal>
  );
}

function TaskDetailModal({ task, state, now, isPDL, role, allMessages, onSend, updateTask, deleteTask, onClose }) {
  const [t, setT] = useState(task);
  const [showChat, setShowChat] = useState(false);
  const [taskContext, setTaskContext] = useState(null);
  const save = (u) => { setT(u); updateTask(u); };
  const grouped = {};
  t.checklist.forEach((item, idx) => { const g = item.group||"Allgemein"; if (!grouped[g]) grouped[g]=[]; grouped[g].push({...item,idx}); });
  const tpl = TEMPLATES.find(x => x.id === t.templateId);
  const isOv = t.due < now && t.status !== "done";
  const assignedWb = t.assignedTo ? state.wohnbereiche.find(w => w.id === t.assignedTo) : t.wbId ? state.wohnbereiche.find(w => w.id === t.wbId) : null;
  const chatWbId = t.assignedTo || t.wbId;
  return (
    <Modal title={t.title} onClose={onClose} wide>
      <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 14 }}>
        {tpl && <Tag color={tpl.color}>{tpl.icon} {tpl.title}</Tag>}
        {isOv && <Tag color={D.red}>‚ö† √úberf√§llig</Tag>}
        <Tag color={D.muted}>üìÖ {fmtDate(t.due)}</Tag>
        {t.recur !== "none" && <Tag color={D.blue}>üîÅ {RECUR_LABELS[t.recur]}</Tag>}
        {assignedWb && <Tag color={assignedWb.color}>üè• {assignedWb.name}</Tag>}
      </div>
      <div style={{ display: "flex", gap: 8, marginBottom: 14 }}>
        {[["open","Offen",D.yellow],["inprogress","In Arbeit",D.blue],["done","Erledigt",D.green]].map(([k,v,c]) => (
          <Btn key={k} variant="secondary" style={{ fontSize: 12, padding: "5px 12px", borderColor: c+"60", color: t.status===k?"#000":c, background: t.status===k?c:"transparent" }}
            onClick={() => save({...t,status:k})}>{v}</Btn>
        ))}
      </div>
      {t.notes && <div style={{ background: D.surface2, borderRadius: 7, padding: "10px 13px", fontSize: 12, color: D.muted, marginBottom: 14 }}>{t.notes}</div>}
      {t.checklist.length > 0 && (
        <>
          <ProgressBar items={t.checklist} height={6} />
          <div style={{ marginTop: 14 }}>
            {Object.entries(grouped).map(([group, items]) => (
              <div key={group} style={{ marginBottom: 12 }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: D.muted, letterSpacing: 1, textTransform: "uppercase", marginBottom: 6, paddingBottom: 4, borderBottom: `1px solid ${D.border}`, ...mono }}>{group}</div>
                {items.map(item => (
                  <label key={item.idx} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "6px 0", cursor: "pointer" }}>
                    <input type="checkbox" checked={item.done} onChange={() => {
                      const cl = t.checklist.map((x,i) => i===item.idx?{...x,done:!x.done}:x);
                      save({...t,checklist:cl,status:cl.every(i=>i.done)?"done":t.status});
                    }} style={{ accentColor: D.blue, marginTop: 2 }} />
                    <span style={{ fontSize: 13, color: item.done?D.muted:D.text, textDecoration: item.done?"line-through":"none" }}>{item.text}</span>
                  </label>
                ))}
              </div>
            ))}
          </div>
        </>
      )}
      {chatWbId && (
        <div style={{ marginTop: 16, borderTop: `1px solid ${D.border}`, paddingTop: 14 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
            <div style={{ fontSize: 12, fontWeight: 600, color: D.muted, ...mono }}>R√úCKMELDUNGEN</div>
            <Btn variant="secondary" style={{ fontSize: 11, padding: "4px 10px" }}
              onClick={() => { setTaskContext({ id: t.id, title: t.title }); setShowChat(!showChat); }}>
              üí¨ R√ºckmeldung schreiben
            </Btn>
          </div>
          {(allMessages[chatWbId]||[]).filter(m=>m.taskRef?.id===t.id).slice(-3).map(m => (
            <div key={m.id} style={{ background: D.surface2, borderRadius: 6, padding: "7px 10px", marginBottom: 5, fontSize: 12 }}>
              <span style={{ color: m.role===ROLE_PDL?D.blue:D.green, fontWeight: 600, ...mono }}>{m.author}:</span>
              <span style={{ color: D.text, marginLeft: 6 }}>{m.text}</span>
              <span style={{ color: D.muted, fontSize: 10, ...mono, marginLeft: 8 }}>{fmtDateTime(m.ts)}</span>
            </div>
          ))}
          {showChat && (
            <div style={{ marginTop: 8 }}>
              <ChatView role={role} wbId={chatWbId} wbName={assignedWb?.name||"Wohnbereich"} wbColor={assignedWb?.color}
                allMessages={allMessages} onSend={onSend} taskContext={taskContext} onClearTaskContext={() => setTaskContext(null)} />
            </div>
          )}
        </div>
      )}
      <div style={{ display: "flex", justifyContent: "flex-end", marginTop: 16 }}>
        {isPDL && <Btn variant="danger" onClick={() => deleteTask(t.id)}>üóë L√∂schen</Btn>}
      </div>
    </Modal>
  );
}

function LibraryTab({ now, wbId, saveTask, setSubTab }) {
  const cats = [...new Set(TEMPLATES.map(t => t.cat))];
  const [cat, setCat] = useState("Alle");
  const tpls = cat === "Alle" ? TEMPLATES : TEMPLATES.filter(t => t.cat === cat);
  return (
    <div>
      <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
        {["Alle",...cats].map(c => <Btn key={c} variant={cat===c?"primary":"secondary"} style={{ padding: "5px 11px", fontSize: 11 }} onClick={() => setCat(c)}>{c}</Btn>)}
      </div>
      {tpls.map(t => (
        <div key={t.id} style={{ ...surfaceStyle({ padding: "14px 16px", marginBottom: 8, borderLeft: `3px solid ${t.color}` }) }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div style={{ display: "flex", gap: 10, flex: 1 }}>
              <span style={{ fontSize: 24 }}>{t.icon}</span>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, color: D.text }}>{t.title}</div>
                <div style={{ fontSize: 11, color: D.muted, marginTop: 2 }}>{t.desc}</div>
                <div style={{ display: "flex", gap: 6, marginTop: 6 }}>
                  <Tag color={t.color} small>{t.cat}</Tag>
                  <Tag color={D.muted} small>üîÅ {RECUR_LABELS[t.recur]}</Tag>
                  <Tag color={D.muted} small>{t.items.length} Punkte</Tag>
                </div>
              </div>
            </div>
            <Btn color={t.color} style={{ fontSize: 11, padding: "5px 12px", flexShrink: 0 }}
              onClick={() => {
                const task = { id:uid(), title:t.title, due:now, recur:t.recur, notes:"", status:"open", templateId:t.id, wbId:wbId||"", assignedTo:"", checklist:t.items.map(i=>({text:i.text,group:i.group,done:false})) };
                saveTask(task); setSubTab("tasks");
              }}>‚Üí Erstellen</Btn>
          </div>
        </div>
      ))}
    </div>
  );
}

function TaskCard({ t, state, now, allMessages, onOpen }) {
  const tpl = TEMPLATES.find(x=>x.id===t.templateId);
  const isOv = t.due<now&&t.status!=="done";
  const isToday = t.due===now&&t.status!=="done";
  const assignedWb = t.assignedTo ? state.wohnbereiche.find(w=>w.id===t.assignedTo) : null;
  const msgCount = (allMessages[t.assignedTo||t.wbId]||[]).filter(m=>m.taskRef?.id===t.id).length;
  return (
    <div onClick={() => onOpen(t)}
      style={{ ...surfaceStyle({ padding:"11px 16px", marginBottom:5, cursor:"pointer", borderLeft:`3px solid ${isOv?D.red:isToday?D.yellow:tpl?.color||D.border}` }) }}>
      <div style={{ display:"flex",justifyContent:"space-between",alignItems:"center",gap:10 }}>
        <div style={{ display:"flex",gap:10,alignItems:"center",flex:1 }}>
          <span style={{ fontSize:17 }}>{tpl?.icon||"üìã"}</span>
          <div style={{ flex:1, minWidth:0 }}>
            <div style={{ fontSize:13,fontWeight:600,color:D.text,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap" }}>{t.title}</div>
            <div style={{ fontSize:10,color:isOv?D.red:isToday?D.yellow:D.muted,marginTop:2,...mono }}>
              üìÖ {fmtDate(t.due)}{t.recur!=="none"?` ¬∑ üîÅ ${RECUR_LABELS[t.recur]}`:""}
              {assignedWb&&<span style={{ color:assignedWb.color }}> ¬∑ {assignedWb.name}</span>}
            </div>
          </div>
        </div>
        <div style={{ display:"flex",gap:6,alignItems:"center",flexShrink:0 }}>
          {msgCount>0&&<span style={{ fontSize:10,...mono,color:D.blue }}>üí¨{msgCount}</span>}
          {isOv&&<Tag color={D.red} small>√úberf√§llig</Tag>}
          {isToday&&!isOv&&<Tag color={D.yellow} small>Heute</Tag>}
        </div>
      </div>
      {t.checklist?.length>0&&<div style={{marginTop:8}}><ProgressBar items={t.checklist}/></div>}
    </div>
  );
}

function AufgabenView({ state, onUpdate, role, allMessages, onSend, wbColor, onTabChange }) {
  const { tasks } = state;
  const [subTab, setSubTab] = useState("tasks");
  const [detail, setDetail] = useState(null);
  const [showForm, setShowForm] = useState(false);
  const [filterStatus, setFilterStatus] = useState("open");
  const [groupBy, setGroupBy] = useState("kategorie");
  const [collapsed, setCollapsed] = useState({});
  const [allCollapsed, setAllCollapsed] = useState(false);
  const now = todayStr();

  const wbId = roleIsWBL(role) || roleSL(role) ? roleWbId(role) : null;
  const isPDL = role === ROLE_PDL;

  const myTasks = wbId ? tasks.filter(t => t.wbId === wbId || t.assignedTo === wbId) : tasks;

  const filtered = myTasks.filter(t => {
    if (filterStatus === "overdue") return t.due < now && t.status !== "done";
    if (filterStatus === "today")   return t.due === now && t.status !== "done";
    if (filterStatus === "open")    return t.status !== "done";
    if (filterStatus === "done")    return t.status === "done";
    return true;
  });

  // Gruppierung
  const grouped = (() => {
    if (groupBy === "keine") return [{ key: "alle", label: "Alle Aufgaben", icon: "üìã", color: D.blue, tasks: filtered }];
    if (groupBy === "wohnbereich") {
      const map = {};
      filtered.forEach(t => {
        const wb = t.assignedTo ? state.wohnbereiche.find(w => w.id === t.assignedTo)
                  : t.wbId      ? state.wohnbereiche.find(w => w.id === t.wbId) : null;
        const key = wb?.id || "allgemein";
        const label = wb?.name || "Allgemein";
        const color = wb?.color || D.muted;
        if (!map[key]) map[key] = { key, label, icon: "üè•", color, tasks: [] };
        map[key].tasks.push(t);
      });
      return Object.values(map).sort((a,b) => a.label.localeCompare(b.label));
    }
    // Gruppe nach Vorlage/Kategorie
    const map = {};
    filtered.forEach(t => {
      const tpl = TEMPLATES.find(x => x.id === t.templateId);
      const key = tpl?.cat || "Sonstige";
      const color = tpl?.color || D.muted;
      const icon = tpl?.icon || "üìã";
      if (!map[key]) map[key] = { key, label: key, icon, color, tasks: [] };
      map[key].tasks.push(t);
    });
    // Sortierung: √úberf√§llige Gruppen zuerst
    return Object.values(map).sort((a,b) => {
      const aOv = a.tasks.some(t => t.due < now && t.status !== "done");
      const bOv = b.tasks.some(t => t.due < now && t.status !== "done");
      if (aOv && !bOv) return -1;
      if (!aOv && bOv) return 1;
      return a.label.localeCompare(b.label);
    });
  })();

  const toggleCollapse = (key) => {
    setCollapsed(p => ({ ...p, [key]: p[key] === false ? true : false }));
  };
  const toggleAll = () => {
    if (allCollapsed) {
      setCollapsed({});
      setAllCollapsed(false);
    } else {
      const all = {};
      grouped.forEach(g => { all[g.key] = true; });
      setCollapsed(all);
      setAllCollapsed(true);
    }
  };

  const saveTask = (t) => { onUpdate({ ...state, tasks: [t, ...tasks] }); setShowForm(false); };
  const updateTask = (t) => {
    if (t.status === "done") {
      const logEntry = { ...t, doneAt: new Date().toISOString(), doneBy: role };
      const newLog = pruneOlderThan([logEntry, ...(state.taskLog || [])], LOG_DAYS, "doneAt");
      let updated = tasks.filter(x => x.id !== t.id);
      if (t.recur !== "none") {
        updated = [{ ...t, id: uid(), status: "open", due: nextDue(t.due, t.recur), checklist: t.checklist.map(i => ({ ...i, done: false })) }, ...updated];
      }
      onUpdate({ ...state, tasks: updated, taskLog: newLog });
      setDetail(null);
    } else {
      onUpdate({ ...state, tasks: tasks.map(x => x.id === t.id ? t : x) });
    }
  };
  const deleteTask = (id) => { onUpdate({ ...state, tasks: tasks.filter(t => t.id !== id) }); setDetail(null); };

  const taskLog = (state.taskLog || []).filter(t => !wbId || t.wbId === wbId || t.assignedTo === wbId);

  const filterOpts = [
    { k:"all",     l:"Alle",       n:myTasks.length },
    { k:"overdue", l:"√úberf√§llig", n:myTasks.filter(t=>t.due<now&&t.status!=="done").length },
    { k:"today",   l:"Heute",      n:myTasks.filter(t=>t.due===now&&t.status!=="done").length },
    { k:"open",    l:"Offen",      n:myTasks.filter(t=>t.status!=="done").length },
  ];

  // TaskCard ist als Top-Level-Komponente definiert (oberhalb AufgabenView)

  return (
    <div>
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
        <div style={{ display: "flex", gap: 0, borderBottom: `1px solid ${D.border}` }}>
          {[["tasks","Aufgaben"],["log",`Verlauf (${taskLog.length})`],["library","Checklisten"]].map(([k,l]) => (
            <button key={k} onClick={() => setSubTab(k)}
              style={{ padding: "9px 18px", fontSize: 13, fontWeight: 600, cursor: "pointer", border: "none", borderBottom: `2px solid ${subTab===k?D.blue:"transparent"}`, color: subTab===k?D.blue:D.muted, background: "transparent", marginBottom: -1, fontFamily: "inherit" }}>{l}</button>
          ))}
        </div>
        {subTab === "tasks" && <Btn onClick={() => setShowForm(true)}>Ôºã Neue Aufgabe</Btn>}
      </div>

      {subTab === "library" && <LibraryTab now={now} wbId={wbId} saveTask={saveTask} setSubTab={setSubTab} />}

      {/* Banner: Offene Prozesse in diesem WB */}
      {subTab === "tasks" && (() => {
        const offeneProzesse = (state.prozesse || []).filter(p =>
          p.status !== "abgeschlossen" &&
          (wbId ? p.wbId === wbId : true)
        );
        if (offeneProzesse.length === 0) return null;
        const typIcons = { neuaufnahme:"üè†", wiederaufnahme:"üè•", onboarding:"üë§", offboarding:"üëã" };
        return (
          <div onClick={() => onTabChange?.("prozesse")}
            style={{ background: D.surface, border: `1px solid ${D.blue}40`, borderRadius: 8, padding: "10px 14px", marginBottom: 14, cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 }}>
            <div style={{ display: "flex", gap: 10, alignItems: "center", flex: 1, flexWrap: "wrap" }}>
              <span style={{ fontSize: 13, fontWeight: 600, color: D.blue }}>
                üìã {offeneProzesse.length} offene{offeneProzesse.length === 1 ? "r Prozess" : " Prozesse"}
              </span>
              <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
                {offeneProzesse.slice(0, 3).map(p => (
                  <span key={p.id} style={{ fontSize: 11, color: D.muted, background: D.surface2, borderRadius: 5, padding: "2px 7px", ...mono }}>
                    {typIcons[p.typ] || "üìã"} {p.titel}
                  </span>
                ))}
                {offeneProzesse.length > 3 && (
                  <span style={{ fontSize: 11, color: D.muted, ...mono }}>+{offeneProzesse.length - 3} weitere</span>
                )}
              </div>
            </div>
            <span style={{ fontSize: 11, color: D.blue, ...mono, flexShrink: 0 }}>‚Üí Prozesse</span>
          </div>
        );
      })()}

      {subTab === "log" && (
        <div>
          {taskLog.length === 0
            ? <div style={{ textAlign:"center", padding:"48px 0", color:D.muted }}><div style={{fontSize:36}}>üìÇ</div><div style={{fontWeight:600,marginTop:8,color:D.text}}>Noch keine erledigten Aufgaben</div><div style={{fontSize:12,marginTop:4}}>Erledigte Aufgaben erscheinen hier f√ºr 90 Tage.</div></div>
            : taskLog.map(t => {
              const tpl = TEMPLATES.find(x => x.id === t.templateId);
              const assignedWb = t.assignedTo ? state.wohnbereiche.find(w => w.id === t.assignedTo) : t.wbId ? state.wohnbereiche.find(w => w.id === t.wbId) : null;
              const doneItems = t.checklist?.filter(i => i.done).length || 0;
              const totalItems = t.checklist?.length || 0;
              return (
                <div key={t.id} style={{ ...surfaceStyle({ padding:"11px 16px", marginBottom:6, borderLeft:`3px solid ${D.green}`, opacity: 0.85 }) }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", gap:10 }}>
                    <div style={{ display:"flex", gap:10, alignItems:"center", flex:1 }}>
                      <span style={{ fontSize:17 }}>{tpl?.icon || "‚úì"}</span>
                      <div>
                        <div style={{ fontSize:13, fontWeight:600, color:D.text }}>{t.title}</div>
                        <div style={{ fontSize:10, color:D.muted, marginTop:2, ...mono }}>
                          ‚úì Erledigt {fmtDateTime(t.doneAt)}
                          {assignedWb && <span style={{ color:assignedWb.color }}> ¬∑ {assignedWb.name}</span>}
                          {totalItems > 0 && <span> ¬∑ {doneItems}/{totalItems} Punkte</span>}
                        </div>
                      </div>
                    </div>
                    <Tag color={D.green} small>Erledigt</Tag>
                  </div>
                </div>
              );
            })
          }
          {taskLog.length > 0 && (
            <div style={{ fontSize:11, color:D.muted, textAlign:"center", marginTop:12, ...mono }}>
              Verlauf wird automatisch nach 90 Tagen bereinigt ¬∑ {taskLog.length} Eintr√§ge
            </div>
          )}
        </div>
      )}

      {subTab === "tasks" && (
        <>
          {/* Filter + Gruppierung */}
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12, flexWrap:"wrap", gap:8 }}>
            <div style={{ display:"flex", gap:5, flexWrap:"wrap" }}>
              {filterOpts.map(f => (
                <Btn key={f.k} variant={filterStatus===f.k?"primary":"secondary"} style={{ padding:"5px 11px", fontSize:11 }} onClick={() => setFilterStatus(f.k)}>
                  {f.l}{f.n>0&&<span style={{opacity:.6}}> ({f.n})</span>}
                </Btn>
              ))}
            </div>
            <div style={{ display:"flex", gap:4, alignItems:"center" }}>
              <span style={{ fontSize:10, color:D.muted, ...mono, marginRight:2 }}>Gruppe:</span>
              {[["kategorie","Kategorie"],["wohnbereich","WB"],["keine","Keine"]].map(([k,l]) => (
                <button key={k} onClick={() => { setGroupBy(k); setCollapsed({}); setAllCollapsed(false); }}
                  style={{ padding:"4px 10px", fontSize:10, borderRadius:6, border:`1px solid ${groupBy===k?D.blue:D.border}`, background:groupBy===k?D.blue+"20":"transparent", color:groupBy===k?D.blue:D.muted, cursor:"pointer", fontFamily:"inherit", fontWeight:600 }}>
                  {l}
                </button>
              ))}
              {groupBy !== "keine" && (
                <button onClick={toggleAll}
                  style={{ padding:"4px 10px", fontSize:10, borderRadius:6, border:`1px solid ${D.border}`, background:"transparent", color:D.muted, cursor:"pointer", fontFamily:"inherit", marginLeft:4 }}>
                  {allCollapsed ? "‚ñ∂ Alle" : "‚ñº Alle"}
                </button>
              )}
            </div>
          </div>

          {/* Gruppierte Aufgaben */}
          {filtered.length === 0
            ? <div style={{ textAlign:"center",padding:"48px 0",color:D.muted }}><div style={{fontSize:36}}>‚úì</div><div style={{fontWeight:600,marginTop:8,color:D.text}}>Keine Aufgaben hier</div></div>
            : grouped.map(g => {
              const isCollapsed = collapsed[g.key] === true;
              const ovCount = g.tasks.filter(t => t.due < now && t.status !== "done").length;
              return (
                <div key={g.key} style={{ marginBottom: groupBy === "keine" ? 0 : 14 }}>
                  {/* Gruppen-Header */}
                  {groupBy !== "keine" && (
                    <div onClick={() => toggleCollapse(g.key)}
                      style={{ display:"flex", alignItems:"center", gap:8, padding:"7px 12px", borderRadius:8, background:D.surface, border:`1px solid ${D.border}`, marginBottom:6, cursor:"pointer", userSelect:"none" }}>
                      <span style={{ fontSize:15 }}>{g.icon}</span>
                      <span style={{ fontSize:12, fontWeight:700, color:g.color, flex:1 }}>{g.label}</span>
                      {ovCount > 0 && <Tag color={D.red} small>‚ö† {ovCount} √ºberf√§llig</Tag>}
                      <span style={{ fontSize:11, color:D.muted, ...mono }}>{g.tasks.length} Aufgabe{g.tasks.length!==1?"n":""}</span>
                      <span style={{ fontSize:12, color:D.muted, marginLeft:4 }}>{isCollapsed?"‚ñ∂":"‚ñº"}</span>
                    </div>
                  )}
                  {/* Aufgaben */}
                  {!isCollapsed && g.tasks.map(t => <TaskCard key={t.id} t={t} state={state} now={now} allMessages={allMessages} onOpen={setDetail} />)}
                </div>
              );
            })
          }
        </>
      )}

      {showForm && <TaskFormModal state={state} wbId={wbId} isPDL={isPDL} now={now} saveTask={saveTask} onClose={() => setShowForm(false)} />}
      {detail && <TaskDetailModal task={detail} state={state} now={now} isPDL={isPDL} role={role} allMessages={allMessages} onSend={onSend} updateTask={updateTask} deleteTask={deleteTask} onClose={() => setDetail(null)} />}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ FORTBILDUNG VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function FortbildungView({ role, state, onUpdate, sharedFbData, onUpdateFbData, fbArchive, onUpdateArchive }) {
  const [filter, setFilter]         = useState('alle');
  const [qualFilter, setQualFilter] = useState('alle');
  const [search, setSearch]         = useState('');
  const [selectedKey, setSelectedKey] = useState(null);
  const [detailTab, setDetailTab]   = useState('alle');

  const isPDL = role === ROLE_PDL;
  const wbId = roleWbId(role);

  // Get mitarbeiter names for this WB to filter CSV
  const myMaNames = wbId
    ? state.mitarbeiter.filter(m => m.wohnbereichId === wbId).map(m => m.name.toLowerCase())
    : null;

  const allData = sharedFbData || [];
  const persons = buildPersons(allData);

  // Filter persons by WB if WBL
  const visiblePersons = myMaNames
    ? Object.fromEntries(Object.entries(persons).filter(([,p]) => {
        const fullName = (p.vorname + ' ' + p.nachname).toLowerCase();
        const nameReversed = (p.nachname + ', ' + p.vorname).toLowerCase();
        return myMaNames.some(n => fullName.includes(n) || nameReversed.includes(n) || n.includes(p.nachname.toLowerCase()));
      }))
    : persons;

  const [csvHinweise, setCsvHinweise] = useState([]);
  const [csvNeuVorschlaege, setCsvNeuVorschlaege] = useState([]);

  const handleFile = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const rows = parseCSV(ev.target.result);
      onUpdateFbData(rows);

      // Analyse: Wer ist in der CSV aber nicht / inaktiv im Tool?
      const persons = buildPersons(rows);
      const allMA = state.mitarbeiter || [];
      const hinweise = [];
      const neuVorschlaege = [];

      Object.values(persons).forEach(p => {
        const fullName = (p.vorname + " " + p.nachname).toLowerCase();
        const match = allMA.find(m => {
          const n = m.name.toLowerCase();
          return n.includes(p.nachname.toLowerCase()) || fullName.includes(n.split(" ").pop());
        });
        if (!match) {
          neuVorschlaege.push({ name: p.vorname + " " + p.nachname, qualifikation: p.gruppe || "" });
        } else if (match.status === "inaktiv") {
          hinweise.push({ type: "inaktiv", name: match.name });
        }
      });

      setCsvHinweise(hinweise);
      setCsvNeuVorschlaege(neuVorschlaege);
    };
    reader.readAsText(file, 'windows-1252');
    e.target.value = '';
  };

  const saveSnapshot = async () => {
    if (!allData.length) return;
    const total=allData.length, bestanden=allData.filter(r=>r.status.toLowerCase().includes('bestanden')).length;
    const snap={id:Date.now(),date:new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}),total,bestanden,persons:Object.keys(persons).length,pct:Math.round(bestanden/total*100)};
    onUpdateArchive([snap,...fbArchive].slice(0,24));
  };

  const QUAL_OPTS = [
    'alle',
    'Pflegefachkr√§fte', 'Pflegefachassistent', 'Pflegehilfskraft',
    'Soziale Betreuung', 'Verwaltung', 'Servicemitarbeiter Pflege',
    'K√ºche', 'Reinigung', 'Haustechnik',
    'Auszubildende',
  ];

  const getFiltered = () => {
    let entries = Object.entries(visiblePersons).map(([k,p])=>({key:k,...p}));
    if (search) entries = entries.filter(p => { const n=(p.vorname+' '+p.nachname).toLowerCase(); return n.includes(search.toLowerCase())||p.trainings.some(t=>t.titel.toLowerCase().includes(search.toLowerCase())); });
    if (qualFilter!=='alle') entries=entries.filter(p=>p.gruppe===qualFilter);
    if (filter!=='alle') entries=entries.filter(p=>p.trainings.some(t=>t.status.toLowerCase().includes(filter)));
    return entries.sort((a,b)=>fbPct(b.trainings)-fbPct(a.trainings));
  };

  const getTopIssues = () => {
    const fk = qualFilter==='alle'?Object.keys(visiblePersons):Object.entries(visiblePersons).filter(([,p])=>p.gruppe===qualFilter).map(([k])=>k);
    const counts={};
    for (const r of allData) { const k=r.nachname+'|'+r.vorname; if(!fk.includes(k)) continue; if(r.status.toLowerCase().includes('gebucht')||r.status.toLowerCase().includes('gestartet')) counts[r.titel]=(counts[r.titel]||0)+1; }
    return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  };

  const total=allData.length,bestanden=allData.filter(r=>r.status.toLowerCase().includes('bestanden')).length,gebucht=allData.filter(r=>r.status.toLowerCase().includes('gebucht')).length,gestartet=allData.filter(r=>r.status.toLowerCase().includes('gestartet')).length,pctAll=total?Math.round(bestanden/total*100):0;
  const selPerson=selectedKey?visiblePersons[selectedKey]:null;
  const topIssues=getTopIssues(); const maxIssue=topIssues[0]?.[1]||1;

  const getDetailTrainings = () => {
    if (!selPerson) return [];
    let t=[...selPerson.trainings];
    if (detailTab==='offen') t=t.filter(x=>!x.status.toLowerCase().includes('bestanden'));
    if (detailTab==='done') t=t.filter(x=>x.status.toLowerCase().includes('bestanden'));
    const order={bestanden:0,gestartet:1,gebucht:2};
    return t.sort((a,b)=>(order[Object.keys(order).find(k=>a.status.toLowerCase().includes(k))]??3)-(order[Object.keys(order).find(k=>b.status.toLowerCase().includes(k))]??3));
  };

  return (
    <div>
      <div style={{ fontSize:18,fontWeight:700,color:D.text,marginBottom:4,...sora }}>Fortbildungs-Dashboard</div>
      <div style={{ fontSize:11,color:D.muted,marginBottom:16,...mono }}>
        {isPDL ? `Alle Mitarbeitenden ¬∑ ${state.einrichtungsname || "Einrichtung"}` : `${state.wohnbereiche.find(w=>w.id===wbId)?.name || ""} ¬∑ Eigene Mitarbeitende`}
      </div>

      {isPDL && (
        <>
          <div style={{ display:"flex",alignItems:"center",gap:10,marginBottom:csvHinweise.length||csvNeuVorschlaege.length?8:20,flexWrap:"wrap" }}>
            <label style={{ background:D.blue,color:"#fff",padding:"7px 14px",borderRadius:7,fontSize:12,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6 }}>
              ‚¨Ü CSV importieren <input type="file" accept=".csv" onChange={handleFile} style={{display:"none"}} />
            </label>
            <span style={{ fontSize:11,color:D.muted }}>ISO-8859-1 ¬∑ Semikolon</span>
            {allData.length>0&&<Btn variant="secondary" style={{fontSize:11,padding:"6px 12px"}} onClick={saveSnapshot}>üíæ Snapshot</Btn>}
            <span style={{fontSize:11,color:D.muted,...mono,marginLeft:"auto"}}>Archiv: {fbArchive.length}</span>
          </div>
          {csvHinweise.length>0&&(
            <div style={{background:D.yellowDim,border:`1px solid ${D.yellow}40`,borderRadius:7,padding:"10px 14px",marginBottom:8,fontSize:12}}>
              <div style={{fontWeight:700,color:D.yellow,marginBottom:6}}>‚ö† Inaktive Mitarbeitende in CSV erkannt:</div>
              {csvHinweise.map((h,i)=><div key={i} style={{color:D.muted,marginBottom:2}}>¬∑ {h.name} ist im Tool als inaktiv markiert</div>)}
            </div>
          )}
          {csvNeuVorschlaege.length>0&&(
            <div style={{background:D.blueDim,border:`1px solid ${D.blue}40`,borderRadius:7,padding:"10px 14px",marginBottom:20,fontSize:12}}>
              <div style={{fontWeight:700,color:D.blue,marginBottom:6}}>üí° Unbekannte Mitarbeitende in CSV ‚Äì anlegen?</div>
              {csvNeuVorschlaege.map((v,i)=>(
                <div key={v.name} style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <span style={{color:D.muted}}>¬∑ {v.name}{v.qualifikation?" ("+v.qualifikation+")":""}</span>
                  <Btn variant="secondary" style={{fontSize:10,padding:"2px 8px"}} onClick={()=>{
                    // Sofort aus der Liste entfernen
                    setCsvNeuVorschlaege(prev => {
                      const next = prev.filter(x => x.name !== v.name);
                      // MA anlegen falls noch nicht vorhanden
                      const exists = (state.mitarbeiter||[]).some(m => m.name.toLowerCase() === v.name.toLowerCase());
                      if (!exists) {
                        const neuerMA = {id:uid(), name:v.name, qualifikation:v.qualifikation||"", schicht:"", wohnbereichId:"", eintrittsdatum:todayStr(), status:"aktiv", angelegtDurch:"csv"};
                        onUpdate({...state, mitarbeiter:[...(state.mitarbeiter||[]), neuerMA]});
                      }
                      return next;
                    });
                  }}>Anlegen</Btn>
                </div>
              ))}
              <Btn variant="ghost" style={{fontSize:10,color:D.muted,marginTop:4}} onClick={()=>setCsvNeuVorschlaege([])}>Alle ignorieren</Btn>
            </div>
          )}
        </>
      )}

      {/* Stats */}
      <div style={{ display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:1,background:D.border,borderRadius:10,overflow:"hidden",marginBottom:20 }}>
        {[
          {l:isPDL?"Mitarbeitende":"Meine MA", v:Object.keys(visiblePersons).length||"‚Äî", c:D.text},
          {l:"Bestanden",      v:total?bestanden:"‚Äî", c:D.green},
          {l:"Offen/Gebucht",  v:total?gebucht:"‚Äî",   c:D.yellow},
          {l:"Abschlussquote", v:total?pctAll+"%":"‚Äî", c:D.text},
        ].map(s=>(
          <div key={s.l} style={{background:D.surface,padding:"14px 14px"}}>
            <div style={{fontSize:10,textTransform:"uppercase",letterSpacing:1,color:D.muted,...mono,marginBottom:4}}>{s.l}</div>
            <div style={{fontSize:22,fontWeight:700,color:s.c,lineHeight:1,...mono}}>{s.v}</div>
          </div>
        ))}
      </div>

      {/* Main layout */}
      <div style={{ display:"grid",gridTemplateColumns:"1fr 280px",gap:12 }}>
        <div>
          {!allData.length
            ? <div style={{...surfaceStyle({padding:"60px 20px",textAlign:"center"})}}>
                <div style={{fontSize:40,marginBottom:12}}>üìã</div>
                <div style={{fontSize:15,fontWeight:600,color:D.text,marginBottom:6}}>
                  {isPDL ? "CSV-Datei importieren" : "Keine Daten verf√ºgbar"}
                </div>
                <div style={{fontSize:12,color:D.muted}}>
                  {isPDL ? "Exportiere die Lernhistorie aus dem Portal und lade sie oben hoch." : "Die PDL hat noch keine Fortbildungsdaten importiert."}
                </div>
              </div>
            : <>
                <div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:12}}>
                  <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Name oder Fortbildung‚Ä¶"
                    style={{flex:1,minWidth:140,background:D.surface2,border:`1px solid ${D.border}`,borderRadius:7,padding:"7px 11px",color:D.text,fontSize:12,outline:"none",fontFamily:"inherit"}} />
                  {isPDL&&<select value={qualFilter} onChange={e=>setQualFilter(e.target.value)}
                    style={{background:D.surface2,border:`1px solid ${D.border}`,borderRadius:7,padding:"7px 10px",color:D.text,fontSize:11,cursor:"pointer",outline:"none"}}>
                    {QUAL_OPTS.map(o=><option key={o} value={o}>{o==='alle'?'üë• Alle':o}</option>)}
                  </select>}
                  {[['alle','Alle'],['bestanden','‚úÖ'],['gebucht','üìö'],['gestartet','‚ñ∂']].map(([k,l])=>(
                    <Btn key={k} variant={filter===k?"primary":"secondary"} style={{padding:"6px 11px",fontSize:11}} onClick={()=>setFilter(k)}>{l}</Btn>
                  ))}
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(220px,1fr))",gap:8}}>
                  {getFiltered().map(p=>{
                    const pv=fbPct(p.trainings),col=fbColor(p.nachname);
                    const b=p.trainings.filter(t=>t.status.toLowerCase().includes('bestanden')).length;
                    const gb=p.trainings.filter(t=>t.status.toLowerCase().includes('gebucht')).length;
                    const gs=p.trainings.filter(t=>t.status.toLowerCase().includes('gestartet')).length;
                    return (
                      <div key={p.key} onClick={()=>{setSelectedKey(p.key);setDetailTab('alle');}}
                        style={{background:D.surface,border:`1px solid ${selectedKey===p.key?D.blue:D.border}`,borderRadius:9,padding:12,cursor:"pointer"}}>
                        <div style={{display:"flex",alignItems:"center",gap:9,marginBottom:8}}>
                          <div style={{width:32,height:32,borderRadius:"50%",background:col+"22",color:col,display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:700,...mono,flexShrink:0}}>{fbInitials(p.vorname,p.nachname)}</div>
                          <div>
                            <div style={{fontSize:13,fontWeight:600,color:D.text}}>{p.vorname} {p.nachname}</div>
                            <div style={{fontSize:10,color:D.muted,...mono,marginTop:1}}>{p.qualifikation} ¬∑ {pv}%</div>
                          </div>
                        </div>
                        <div style={{height:3,background:D.border,borderRadius:2,overflow:"hidden",marginBottom:7}}>
                          <div style={{width:`${pv}%`,height:"100%",background:fbPctColor(pv)}}/>
                        </div>
                        <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                          {b>0&&<span style={{fontSize:10,...mono,padding:"1px 5px",borderRadius:3,background:D.greenDim,color:D.green,border:`1px solid #166534`}}>‚úì {b}</span>}
                          {gs>0&&<span style={{fontSize:10,...mono,padding:"1px 5px",borderRadius:3,background:D.blueDim,color:D.blue,border:`1px solid #1e3a8a`}}>‚ñ∂ {gs}</span>}
                          {gb>0&&<span style={{fontSize:10,...mono,padding:"1px 5px",borderRadius:3,background:D.yellowDim,color:D.yellow,border:`1px solid #713f12`}}>‚óâ {gb}</span>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
          }
        </div>

        {/* Right panel */}
        <div style={{background:D.surface,borderRadius:10,border:`1px solid ${D.border}`,padding:14,alignSelf:"start"}}>
          {!selPerson?(
            <>
              <SectionTitle>Gr√∂√üte Baustellen</SectionTitle>
              {topIssues.length===0
                ? <div style={{fontSize:12,color:D.muted}}>Keine offenen Fortbildungen.</div>
                : topIssues.map(([name,count],i)=>(
                  <div key={name} style={{display:"flex",alignItems:"center",gap:7,padding:"7px 9px",background:D.surface2,borderRadius:6,border:`1px solid ${D.border}`,marginBottom:5}}>
                    <span style={{fontSize:10,color:D.muted,...mono,width:16}}>{i+1}</span>
                    <span style={{fontSize:11,flex:1,color:D.text,lineHeight:1.3}}>{name}</span>
                    <div style={{width:40,height:3,background:D.border,borderRadius:99}}><div style={{width:`${Math.round(count/maxIssue*100)}%`,height:"100%",background:D.red,borderRadius:99}}/></div>
                    <span style={{fontSize:11,...mono,color:D.red,fontWeight:500}}>{count}√ó</span>
                  </div>
                ))
              }
              {isPDL&&fbArchive.length>0&&(
                <><SectionTitle style={{marginTop:18}}>Verlauf</SectionTitle>
                {fbArchive.map(s=>(
                  <div key={s.id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"6px 9px",background:D.surface2,borderRadius:6,border:`1px solid ${D.border}`,marginBottom:4}}>
                    <span style={{fontSize:11,color:D.muted,...mono}}>{s.date}</span>
                    <span style={{fontSize:11,...mono,fontWeight:600,color:fbPctColor(s.pct)}}>{s.pct}%</span>
                    <button onClick={()=>onUpdateArchive(fbArchive.filter(x=>x.id!==s.id))} style={{background:"none",border:"none",color:D.muted,cursor:"pointer",fontSize:13}}>‚úï</button>
                  </div>
                ))}</>
              )}
            </>
          ):(
            <>
              <Btn variant="ghost" style={{color:D.blue,padding:0,marginBottom:12,fontSize:12}} onClick={()=>setSelectedKey(null)}>‚Üê Zur√ºck</Btn>
              <div style={{marginBottom:12}}>
                <div style={{fontSize:15,fontWeight:700,color:D.text}}>{selPerson.vorname} {selPerson.nachname}</div>
                <div style={{fontSize:11,color:D.muted,...mono,marginTop:2}}>{selPerson.qualifikation} ¬∑ {selPerson.trainings.filter(t=>t.status.toLowerCase().includes('bestanden')).length}/{selPerson.trainings.length}</div>
              </div>
              <div style={{fontSize:24,fontWeight:700,...mono,color:fbPctColor(fbPct(selPerson.trainings))}}>{fbPct(selPerson.trainings)}%</div>
              <div style={{height:6,background:D.border,borderRadius:4,overflow:"hidden",margin:"7px 0 14px"}}>
                <div style={{width:`${fbPct(selPerson.trainings)}%`,height:"100%",background:fbPctColor(fbPct(selPerson.trainings))}}/>
              </div>
              <div style={{display:"flex",borderBottom:`1px solid ${D.border}`,marginBottom:10}}>
                {[['alle','Alle'],['offen','Offen'],['done','Fertig']].map(([k,l])=>(
                  <button key={k} onClick={()=>setDetailTab(k)}
                    style={{padding:"5px 10px",fontSize:11,fontWeight:600,cursor:"pointer",border:"none",borderBottom:`2px solid ${detailTab===k?D.blue:"transparent"}`,color:detailTab===k?D.blue:D.muted,background:"transparent",marginBottom:-1,fontFamily:"inherit"}}>{l}</button>
                ))}
              </div>
              <div style={{display:"flex",flexDirection:"column",gap:4}}>
                {getDetailTrainings().map((t,i)=>{
                  const s=t.status.toLowerCase();
                  const dot=s.includes('bestanden')?D.green:s.includes('gestartet')?D.orange:D.yellow;
                  return(
                    <div key={i} style={{padding:"6px 9px",borderRadius:6,border:`1px solid ${D.border}`,background:D.surface2,fontSize:11,display:"flex",alignItems:"center",gap:8}}>
                      <div style={{width:6,height:6,borderRadius:"50%",background:dot,flexShrink:0}}/>
                      <span style={{flex:1,color:D.text,lineHeight:1.3}}>{t.titel}</span>
                      {t.datum&&t.datum!=='-'&&<span style={{...mono,color:D.muted,fontSize:10}}>{t.datum}</span>}
                    </div>
                  );
                })}
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

function AddBWForm({ wbId, wbColor, state, bewohner, onUpdate, onClose }) {
  const [f, setF] = useState({ id: uid(), name: "", zimmer: "", pflegegrad: "PG 2", geburtsjahr: "", wohnbereichId: wbId, besonderheiten: "" });
  return (
    <Modal title="Bewohner/in hinzuf√ºgen" onClose={onClose}>
      <Lbl>Name *</Lbl><Inp value={f.name} onChange={e=>setF(p=>({...p,name:e.target.value}))} placeholder="Nachname, Vorname" />
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
        <div><Lbl>Zimmer</Lbl><Inp value={f.zimmer} onChange={e=>setF(p=>({...p,zimmer:e.target.value}))} placeholder="12a" /></div>
        <div><Lbl>Pflegegrad</Lbl><Sel value={f.pflegegrad} onChange={e=>setF(p=>({...p,pflegegrad:e.target.value}))}>{PFLEGEGRADE.map(pg=><option key={pg}>{pg}</option>)}</Sel></div>
      </div>
      <Lbl>Geburtsjahr</Lbl><Inp value={f.geburtsjahr} onChange={e=>setF(p=>({...p,geburtsjahr:e.target.value}))} placeholder="1952" />
      <Lbl>Besonderheiten</Lbl>
      <textarea value={f.besonderheiten} onChange={e=>setF(p=>({...p,besonderheiten:e.target.value}))} placeholder="z.B. Junge Pflege, Demenz‚Ä¶"
        style={{width:"100%",background:D.surface2,border:`1px solid ${D.border}`,borderRadius:7,color:D.text,padding:"8px 11px",fontSize:13,boxSizing:"border-box",outline:"none",fontFamily:"inherit",marginBottom:14,height:60,resize:"vertical"}} />
      <div style={{display:"flex",gap:10}}>
        <Btn style={{flex:1}} color={wbColor} onClick={()=>{if(f.name){onUpdate({...state,bewohner:[...bewohner,f]});onClose();}}}>Hinzuf√ºgen</Btn>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
      </div>
    </Modal>
  );
}

function AddMAForm({ wbId, wbColor, state, mitarbeiter, onUpdate, onClose }) {
  const [f, setF] = useState({ id: uid(), name: "", qualifikation: "Pflegefachkraft", schicht: "Fr√ºhdienst", wohnbereichId: wbId, email: "" });
  return (
    <Modal title="Mitarbeiter/in hinzuf√ºgen" onClose={onClose}>
      <Lbl>Name *</Lbl><Inp value={f.name} onChange={e=>setF(p=>({...p,name:e.target.value}))} placeholder="Nachname, Vorname" />
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
        <div><Lbl>Qualifikation</Lbl><Sel value={f.qualifikation} onChange={e=>setF(p=>({...p,qualifikation:e.target.value}))}>{QUALIFIKATIONEN.map(q=><option key={q}>{q}</option>)}</Sel></div>
        <div><Lbl>Schicht</Lbl><Sel value={f.schicht} onChange={e=>setF(p=>({...p,schicht:e.target.value}))}>{SCHICHTEN.map(s=><option key={s}>{s}</option>)}</Sel></div>
      </div>
      <Lbl>E-Mail (optional)</Lbl><Inp type="email" value={f.email} onChange={e=>setF(p=>({...p,email:e.target.value}))} placeholder="m.mustermann@einrichtung.de" />
      <div style={{display:"flex",gap:10}}>
        <Btn style={{flex:1}} color={wbColor} onClick={()=>{if(f.name){onUpdate({...state,mitarbeiter:[...mitarbeiter,f]});onClose();}}}>Hinzuf√ºgen</Btn>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ MITARBEITER LISTE (extracted to avoid hooks-in-IIFE bug) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function MitarbeiterListe({ wbMA, isPDL, wbColor, state, mitarbeiter, onUpdate }) {
  const [showInaktiv, setShowInaktiv] = useState(false);
  const aktiv = wbMA.filter(m => m.status !== "inaktiv");
  const inaktiv = wbMA.filter(m => m.status === "inaktiv");
  const shown = showInaktiv ? wbMA : aktiv;
  return (
    <>
      {wbMA.length > 0 && inaktiv.length > 0 && (
        <div style={{display:"flex",gap:8,marginBottom:10}}>
          <Btn variant={!showInaktiv?"primary":"secondary"} style={{fontSize:11,padding:"3px 10px"}} onClick={()=>setShowInaktiv(false)}>Aktiv ({aktiv.length})</Btn>
          <Btn variant={showInaktiv?"primary":"secondary"} style={{fontSize:11,padding:"3px 10px",color:showInaktiv?D.text:D.muted}} onClick={()=>setShowInaktiv(true)}>Inaktiv ({inaktiv.length})</Btn>
        </div>
      )}
      {shown.length===0
        ? <div style={{fontSize:12,color:D.muted,textAlign:"center",padding:"12px 0"}}>{showInaktiv?"Keine inaktiven Mitarbeiter":"Noch keine Mitarbeiter"}</div>
        : shown.map(m=>(
          <div key={m.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 0",borderBottom:`1px solid ${D.border}`,opacity:m.status==="inaktiv"?0.6:1}}>
            <div>
              <div style={{display:"flex",alignItems:"center",gap:7}}>
                <div style={{fontSize:13,fontWeight:600,color:D.text}}>{m.name}</div>
                {m.status==="inaktiv"&&<Tag color={D.muted} small>Inaktiv</Tag>}
                {m.eintrittsdatum&&<Tag color={D.green} small>Seit {fmtDate(m.eintrittsdatum)}</Tag>}
              </div>
              <div style={{fontSize:10,color:D.muted,marginTop:2,...mono}}>{m.qualifikation}{m.schicht?" ¬∑ "+m.schicht:""}</div>
            </div>
            {isPDL&&(
              <div style={{display:"flex",gap:5,alignItems:"center"}}>
                <Btn variant="ghost" style={{fontSize:10,color:m.status==="inaktiv"?D.green:D.yellow,padding:"2px 7px",border:`1px solid ${D.border}`}}
                  onClick={()=>onUpdate({...state,mitarbeiter:mitarbeiter.map(x=>x.id===m.id?{...x,status:m.status==="inaktiv"?"aktiv":"inaktiv"}:x)})}>
                  {m.status==="inaktiv"?"Reaktivieren":"Deaktivieren"}
                </Btn>
                <Btn variant="ghost" style={{color:D.border,fontSize:18,padding:"0 4px"}} onClick={()=>onUpdate({...state,mitarbeiter:mitarbeiter.filter(x=>x.id!==m.id)})}>√ó</Btn>
              </div>
            )}
          </div>
        ))
      }
    </>
  );
}

// ‚îÄ‚îÄ‚îÄ MITARBEITER CSV PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseMitarbeiterCSV(text, wohnbereiche) {
  let lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  if (lines[0]?.toLowerCase().startsWith('sep=')) lines.shift();
  const raw = lines[0] || '';
  const sep = raw.includes(';') ? ';' : raw.includes('\t') ? '\t' : ',';
  const header = lines.shift().split(sep).map(h => h.replace(/"/g,'').trim().toLowerCase());

  const ci = {
    name:        header.findIndex(h => ['name','mitarbeiter','nachname'].some(k => h.includes(k))),
    qualifikation: header.findIndex(h => ['qualifikation','position','stelle','beruf'].some(k => h.includes(k))),
    schicht:     header.findIndex(h => ['schicht','dienst'].some(k => h.includes(k))),
    wohnbereich: header.findIndex(h => ['wohnbereich','wb','bereich','station'].some(k => h.includes(k))),
    email:       header.findIndex(h => ['email','mail','e-mail'].some(k => h.includes(k))),
  };

  const wbMap = {};
  wohnbereiche.forEach(w => {
    wbMap[w.name.toLowerCase()] = w.id;
    wbMap[w.id.toLowerCase()] = w.id;
    const num = w.id.replace('wb','');
    wbMap[num] = w.id;
    wbMap['wb'+num] = w.id;
    wbMap['wohnbereich '+num] = w.id;
    wbMap['bereich '+num] = w.id;
  });

  const rows = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(sep).map(c => c.replace(/^"|"$/g,'').trim());
    if (cols.length < 1) continue;
    const name = ci.name >= 0 ? cols[ci.name] : cols[0];
    if (!name) continue;
    const qualifikation = ci.qualifikation >= 0 ? cols[ci.qualifikation] || '' : '';
    const schicht       = ci.schicht >= 0 ? cols[ci.schicht] || '' : '';
    const email         = ci.email >= 0 ? cols[ci.email] || '' : '';
    const wbRaw         = ci.wohnbereich >= 0 ? cols[ci.wohnbereich]?.toLowerCase()?.trim() || '' : '';
    const wohnbereichId = wbMap[wbRaw] || null;
    rows.push({ name, qualifikation, schicht, email, wohnbereichId });
  }
  return rows;
}

// ‚îÄ‚îÄ‚îÄ MITARBEITER IMPORT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function MitarbeiterImportModal({ state, onUpdate, onClose }) {
  const [rows, setRows] = useState(null);
  const [decisions, setDecisions] = useState({});
  const [wbOverride, setWbOverride] = useState({});
  const { wohnbereiche, mitarbeiter } = state;

  const handleFile = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const parsed = parseMitarbeiterCSV(ev.target.result, wohnbereiche);
      setRows(parsed);
      setDecisions({});
      setWbOverride({});
    };
    reader.readAsText(file, 'windows-1252');
    e.target.value = '';
  };

  const normName = n => n?.toLowerCase().replace(/\s+/g,' ').trim();

  const categorized = rows ? rows.map((r, idx) => {
    const dup = mitarbeiter.find(m => normName(m.name) === normName(r.name));
    return { ...r, idx, dup };
  }) : [];

  const neuRows = categorized.filter(r => !r.dup);
  const dupRows = categorized.filter(r => r.dup);

  // Qualifikation ‚Üí Farbe
  const qualColor = (q) => {
    if (!q) return D.muted;
    const ql = q.toLowerCase();
    if (ql.includes('leitung') || ql.includes('pdl')) return D.blue;
    if (ql.includes('fachkraft') || ql.includes('fachassist')) return D.green;
    if (ql.includes('helfer') || ql.includes('hilfskraft')) return D.yellow;
    if (ql.includes('sozial')) return D.purple;
    if (ql.includes('verwalt')) return D.cyan;
    return D.muted;
  };

  const doImport = () => {
    let updated = [...mitarbeiter];
    // Duplikate behandeln
    for (const r of dupRows) {
      if ((decisions[r.idx] || 'skip') === 'update') {
        updated = updated.map(m => normName(m.name) === normName(r.name)
          ? { ...m,
              qualifikation: r.qualifikation || m.qualifikation,
              schicht: r.schicht || m.schicht,
              wohnbereichId: wbOverride[r.idx] || r.wohnbereichId || m.wohnbereichId,
              email: r.email || m.email }
          : m
        );
      }
    }
    // Neue anlegen
    for (const r of neuRows) {
      const wbId = wbOverride[r.idx] || r.wohnbereichId || '';
      updated.push({
        id: uid(), name: r.name, qualifikation: r.qualifikation,
        schicht: r.schicht, email: r.email, wohnbereichId: wbId,
        status: 'aktiv', eintrittsdatum: '', angelegtDurch: 'csv'
      });
    }
    onUpdate({ ...state, mitarbeiter: updated });
    onClose();
  };

  // Gruppierung der neuen MA nach Qualifikation f√ºr √úbersicht
  const neuGruppen = neuRows.reduce((acc, r) => {
    const k = r.qualifikation || 'Sonstige';
    acc[k] = (acc[k] || 0) + 1;
    return acc;
  }, {});

  return (
    <Modal title="üë• Mitarbeiter aus CSV importieren" onClose={onClose} wide>
      {!rows ? (
        <>
          <div style={{ background: D.surface2, borderRadius: 8, padding: "14px 16px", marginBottom: 16, fontSize: 12, color: D.muted, lineHeight: 1.7 }}>
            <div style={{ fontWeight: 700, color: D.text, marginBottom: 6 }}>Erwartetes CSV-Format</div>
            <div style={{ ...mono, color: D.cyan, marginBottom: 6 }}>Name;Qualifikation;Schicht;Wohnbereich</div>
            <div>‚Ä¢ <strong>Name</strong> ‚Äì Pflichtfeld<br/>
            ‚Ä¢ <strong>Qualifikation</strong> ‚Äì z.B. ‚ÄûPflegefachkraft", ‚ÄûPflegehelfer/in"<br/>
            ‚Ä¢ <strong>Schicht</strong> ‚Äì Fr√ºhdienst / Sp√§tdienst / Nachtdienst<br/>
            ‚Ä¢ <strong>Wohnbereich</strong> ‚Äì optional (z.B. ‚Äû2", ‚ÄûWB3") ‚Äì leer lassen f√ºr Verwaltung/SD</div>
          </div>
          <label style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8, background: D.blue, color: "#fff", padding: "11px", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
            üìÇ CSV-Datei ausw√§hlen
            <input type="file" accept=".csv,.txt" onChange={handleFile} style={{ display: "none" }} />
          </label>
        </>
      ) : (
        <>
          {/* Summary badges */}
          <div style={{ display: "flex", gap: 8, marginBottom: 16, flexWrap: "wrap" }}>
            <Tag color={D.green}>{neuRows.length} Neu</Tag>
            <Tag color={D.yellow}>{dupRows.length} Bereits vorhanden</Tag>
            <Tag color={D.muted}>{categorized.length} Gesamt</Tag>
          </div>

          {/* Qualifikations-√úbersicht der neuen MA */}
          {neuRows.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <SectionTitle>Neue Mitarbeiter ({neuRows.length})</SectionTitle>
              {/* Kompakte Gruppen√ºbersicht */}
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 10 }}>
                {Object.entries(neuGruppen).map(([qual, count]) => (
                  <span key={qual} style={{ background: qualColor(qual)+'18', color: qualColor(qual), border: `1px solid ${qualColor(qual)}35`, borderRadius: 5, padding: "2px 9px", fontSize: 11, ...mono }}>
                    {qual}: {count}
                  </span>
                ))}
              </div>
              {/* Liste */}
              <div style={{ maxHeight: 220, overflowY: "auto", display: "flex", flexDirection: "column", gap: 4 }}>
                {neuRows.map(r => (
                  <div key={r.idx} style={{ background: D.surface2, borderRadius: 7, padding: "8px 12px", border: `1px solid ${D.border}`, display: "flex", justifyContent: "space-between", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: D.text }}>{r.name}</div>
                      <div style={{ fontSize: 10, color: D.muted, ...mono, marginTop: 1 }}>
                        <span style={{ color: qualColor(r.qualifikation) }}>{r.qualifikation || '‚Äì'}</span>
                        {r.schicht && ` ¬∑ ${r.schicht}`}
                        {r.wohnbereichId
                          ? <span style={{ color: wohnbereiche.find(w=>w.id===r.wohnbereichId)?.color }}> ¬∑ {wohnbereiche.find(w=>w.id===r.wohnbereichId)?.name}</span>
                          : !r.wohnbereichId && <span style={{ color: D.muted }}> ¬∑ Kein WB (Verwaltung/SD)</span>
                        }
                      </div>
                    </div>
                    {/* WB manuell zuweisen falls fehlt und nicht Verwaltung/SD */}
                    {!r.wohnbereichId && r.qualifikation && !['verwaltung','sozialdienst','pdl','pflegedienstleitung'].some(k => r.qualifikation.toLowerCase().includes(k)) && (
                      <Sel style={{ width: 150, marginBottom: 0, fontSize: 11 }}
                        value={wbOverride[r.idx] || ''}
                        onChange={e => setWbOverride(p => ({ ...p, [r.idx]: e.target.value }))}>
                        <option value="">‚Äì WB zuweisen ‚Äì</option>
                        {wohnbereiche.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                      </Sel>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Duplikate */}
          {dupRows.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <SectionTitle>Bereits vorhanden ‚Äì was tun?</SectionTitle>
              <div style={{ maxHeight: 160, overflowY: "auto", display: "flex", flexDirection: "column", gap: 4 }}>
                {dupRows.map(r => {
                  const dec = decisions[r.idx] || 'skip';
                  const existWb = wohnbereiche.find(w => w.id === r.dup.wohnbereichId);
                  return (
                    <div key={r.idx} style={{ background: D.surface2, borderRadius: 7, padding: "9px 12px", border: `1px solid ${dec==='update'?D.yellow:D.border}` }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
                        <div>
                          <div style={{ fontSize: 13, fontWeight: 600, color: D.text }}>{r.name}</div>
                          <div style={{ fontSize: 10, color: D.muted, ...mono, marginTop: 1 }}>
                            {r.dup.qualifikation || '‚Äì'}
                            {existWb && <span style={{ color: existWb.color }}> ¬∑ {existWb.name}</span>}
                            {r.qualifikation && r.qualifikation !== r.dup.qualifikation && <span style={{ color: D.yellow }}> ‚Üí {r.qualifikation}</span>}
                          </div>
                        </div>
                        <div style={{ display: "flex", gap: 5 }}>
                          <Btn variant={dec==='skip'?"primary":"secondary"} style={{ fontSize: 10, padding: "3px 10px" }} onClick={() => setDecisions(p=>({...p,[r.idx]:'skip'}))}>√úberspringen</Btn>
                          <Btn variant={dec==='update'?"primary":"secondary"} color={D.yellow} style={{ fontSize: 10, padding: "3px 10px", color: dec==='update'?"#000":D.yellow }} onClick={() => setDecisions(p=>({...p,[r.idx]:'update'}))}>Aktualisieren</Btn>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          <div style={{ display: "flex", gap: 10, marginTop: 4 }}>
            <Btn style={{ flex: 1 }} color={D.green} onClick={doImport}>
              ‚úì {neuRows.length + dupRows.filter(r=>(decisions[r.idx]||'skip')==='update').length} Mitarbeiter importieren
            </Btn>
            <Btn variant="secondary" onClick={() => setRows(null)}>‚Üê Zur√ºck</Btn>
            <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
          </div>
        </>
      )}
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ BEWOHNER CSV PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseBewohnerCSV(text, wohnbereiche) {
  let lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  if (lines[0]?.toLowerCase().startsWith('sep=')) lines.shift();
  const raw = lines[0] || '';
  const sep = raw.includes(';') ? ';' : raw.includes('\t') ? '\t' : ',';
  const header = lines.shift().split(sep).map(h => h.replace(/"/g,'').trim().toLowerCase());

  // Flexible column mapping
  const ci = {
    name:       header.findIndex(h => ['name','bewohner','nachname','vorname'].some(k => h.includes(k))),
    zimmer:     header.findIndex(h => ['zimmer','zi','raum','room'].some(k => h.includes(k))),
    wohnbereich:header.findIndex(h => ['wohnbereich','wb','bereich','station'].some(k => h.includes(k))),
    pflegegrad: header.findIndex(h => ['pflegegrad','pg','grad'].some(k => h.includes(k))),
  };

  const wbMap = {};
  wohnbereiche.forEach(w => {
    wbMap[w.name.toLowerCase()] = w.id;
    wbMap[w.id.toLowerCase()] = w.id;
    // e.g. "2", "wb2", "wohnbereich 2"
    const num = w.id.replace('wb','');
    wbMap[num] = w.id;
    wbMap['wb'+num] = w.id;
    wbMap['wohnbereich '+num] = w.id;
    wbMap['bereich '+num] = w.id;
  });

  const rows = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(sep).map(c => c.replace(/^"|"$/g,'').trim());
    if (cols.length < 1) continue;
    const name = ci.name >= 0 ? cols[ci.name] : cols[0];
    if (!name) continue;
    const zimmer     = ci.zimmer >= 0 ? cols[ci.zimmer] || '' : '';
    const pflegegrad = ci.pflegegrad >= 0 ? cols[ci.pflegegrad] || '' : '';
    const wbRaw      = ci.wohnbereich >= 0 ? cols[ci.wohnbereich]?.toLowerCase()?.trim() || '' : '';
    const wohnbereichId = wbMap[wbRaw] || null;
    rows.push({ name, zimmer, pflegegrad, wohnbereichId });
  }
  return rows;
}

// ‚îÄ‚îÄ‚îÄ BEWOHNER IMPORT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function BewohnerImportModal({ state, onUpdate, onClose }) {
  const [rows, setRows] = useState(null);       // parsed CSV rows
  const [decisions, setDecisions] = useState({}); // id ‚Üí 'update'|'skip' for duplicates
  const [wbOverride, setWbOverride] = useState({}); // rowIdx ‚Üí wbId for rows without wb

  const { wohnbereiche, bewohner } = state;

  const handleFile = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const parsed = parseBewohnerCSV(ev.target.result, wohnbereiche);
      setRows(parsed);
      setDecisions({});
      setWbOverride({});
    };
    reader.readAsText(file, 'windows-1252');
    e.target.value = '';
  };

  const normName = n => n?.toLowerCase().replace(/\s+/g,' ').trim();

  const categorized = rows ? rows.map((r, idx) => {
    const dup = bewohner.find(b => normName(b.name) === normName(r.name));
    return { ...r, idx, dup };
  }) : [];

  const neuRows      = categorized.filter(r => !r.dup);
  const dupRows      = categorized.filter(r => r.dup);
  const noWbRows     = categorized.filter(r => !r.wohnbereichId && !r.dup);

  const doImport = () => {
    let updated = [...bewohner];

    // Handle duplicates
    for (const r of dupRows) {
      const dec = decisions[r.idx] || 'skip';
      if (dec === 'update') {
        updated = updated.map(b => normName(b.name) === normName(r.name)
          ? { ...b, zimmer: r.zimmer || b.zimmer, pflegegrad: r.pflegegrad || b.pflegegrad, wohnbereichId: (wbOverride[r.idx] || r.wohnbereichId || b.wohnbereichId) }
          : b
        );
      }
    }

    // Add new rows
    for (const r of neuRows) {
      const wbId = wbOverride[r.idx] || r.wohnbereichId;
      if (!wbId) continue; // skip if no WB assigned
      updated.push({ id: uid(), name: r.name, zimmer: r.zimmer, pflegegrad: r.pflegegrad || '', wohnbereichId: wbId, besonderheiten: '', geburtsjahr: '' });
    }

    onUpdate({ ...state, bewohner: updated });
    onClose();
  };

  const readyToImport = rows && neuRows.every(r => wbOverride[r.idx] || r.wohnbereichId);

  return (
    <Modal title="üìã Bewohner aus CSV importieren" onClose={onClose} wide>
      {!rows ? (
        <>
          <div style={{ background: D.surface2, borderRadius: 8, padding: "14px 16px", marginBottom: 16, fontSize: 12, color: D.muted, lineHeight: 1.7 }}>
            <div style={{ fontWeight: 700, color: D.text, marginBottom: 6 }}>Erwartetes CSV-Format</div>
            <div>Spalten (Semikolon oder Komma getrennt):</div>
            <div style={{ ...mono, color: D.cyan, marginTop: 4 }}>Name;Zimmer;Wohnbereich</div>
            <div style={{ marginTop: 6 }}>
              ‚Ä¢ <strong>Name</strong> ‚Äì Pflichtfeld (z.B. ‚ÄûMustermann, Maria")<br/>
              ‚Ä¢ <strong>Zimmer</strong> ‚Äì optional (z.B. ‚Äû12a")<br/>
              ‚Ä¢ <strong>Wohnbereich</strong> ‚Äì optional (z.B. ‚Äû2", ‚ÄûWB3", ‚ÄûWohnbereich 4")<br/>
            </div>
            <div style={{ marginTop: 8, color: D.yellow }}>‚ö† Keine sensiblen Daten wie Diagnosen oder Geburtsdaten eintragen.</div>
          </div>
          <label style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8, background: D.blue, color: "#fff", padding: "11px", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
            üìÇ CSV-Datei ausw√§hlen
            <input type="file" accept=".csv,.txt" onChange={handleFile} style={{ display: "none" }} />
          </label>
        </>
      ) : (
        <>
          {/* Summary */}
          <div style={{ display: "flex", gap: 8, marginBottom: 16, flexWrap: "wrap" }}>
            <Tag color={D.green}>{neuRows.length} Neu</Tag>
            <Tag color={D.yellow}>{dupRows.length} Bereits vorhanden</Tag>
            <Tag color={D.muted}>{categorized.length} Gesamt</Tag>
          </div>

          {/* Neue Bewohner */}
          {neuRows.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <SectionTitle>Neue Bewohner ({neuRows.length})</SectionTitle>
              {neuRows.map(r => (
                <div key={r.idx} style={{ background: D.surface2, borderRadius: 7, padding: "10px 13px", marginBottom: 6, border: `1px solid ${D.border}` }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: D.text }}>{r.name}</div>
                      <div style={{ fontSize: 11, color: D.muted, ...mono, marginTop: 2 }}>
                        {r.zimmer && `Zi. ${r.zimmer} ¬∑ `}
                        {r.pflegegrad && `${r.pflegegrad} ¬∑ `}
                        {r.wohnbereichId
                          ? <span style={{ color: wohnbereiche.find(w=>w.id===r.wohnbereichId)?.color }}>{wohnbereiche.find(w=>w.id===r.wohnbereichId)?.name}</span>
                          : <span style={{ color: D.red }}>‚ö† Kein Wohnbereich</span>
                        }
                      </div>
                    </div>
                    {!r.wohnbereichId && (
                      <Sel style={{ width: 160, marginBottom: 0, fontSize: 11 }}
                        value={wbOverride[r.idx] || ''}
                        onChange={e => setWbOverride(p => ({ ...p, [r.idx]: e.target.value }))}>
                        <option value="">‚Äì WB zuweisen ‚Äì</option>
                        {wohnbereiche.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                      </Sel>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Duplikate */}
          {dupRows.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <SectionTitle>Bereits vorhanden ‚Äì was tun?</SectionTitle>
              {dupRows.map(r => {
                const existWb = wohnbereiche.find(w => w.id === r.dup.wohnbereichId);
                const dec = decisions[r.idx] || 'skip';
                return (
                  <div key={r.idx} style={{ background: D.surface2, borderRadius: 7, padding: "10px 13px", marginBottom: 6, border: `1px solid ${dec==='update'?D.yellow:D.border}` }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: D.text, marginBottom: 6 }}>{r.name}</div>
                    <div style={{ fontSize: 11, color: D.muted, ...mono, marginBottom: 8 }}>
                      Aktuell: Zi. {r.dup.zimmer||'‚Äì'} ¬∑ {existWb ? <span style={{ color: existWb.color }}>{existWb.name}</span> : '‚Äì'}
                      {r.zimmer && r.zimmer !== r.dup.zimmer && <span style={{ color: D.yellow }}> ‚Üí neu: Zi. {r.zimmer}</span>}
                      {r.wohnbereichId && r.wohnbereichId !== r.dup.wohnbereichId && (
                        <span style={{ color: D.yellow }}> ‚Üí neu: {wohnbereiche.find(w=>w.id===r.wohnbereichId)?.name}</span>
                      )}
                    </div>
                    <div style={{ display: "flex", gap: 6 }}>
                      <Btn variant={dec==='skip'?"primary":"secondary"} style={{ fontSize: 11, padding: "4px 12px" }} onClick={() => setDecisions(p=>({...p,[r.idx]:'skip'}))}>√úberspringen</Btn>
                      <Btn variant={dec==='update'?"primary":"secondary"} color={D.yellow} style={{ fontSize: 11, padding: "4px 12px", color: dec==='update'?"#000":D.yellow }} onClick={() => setDecisions(p=>({...p,[r.idx]:'update'}))}>Aktualisieren</Btn>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          <div style={{ display: "flex", gap: 10, marginTop: 4 }}>
            <Btn style={{ flex: 1 }} onClick={doImport}
              color={readyToImport ? D.green : D.muted}>
              ‚úì {neuRows.filter(r => wbOverride[r.idx] || r.wohnbereichId).length + dupRows.filter(r=>(decisions[r.idx]||'skip')==='update').length} Bewohner importieren
            </Btn>
            <Btn variant="secondary" onClick={() => setRows(null)}>‚Üê Zur√ºck</Btn>
            <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
          </div>
        </>
      )}
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ BEWOHNER UMZUG MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function BewohnerUmzugModal({ bewohner: b, wohnbereiche, state, onUpdate, onClose }) {
  const [targetWbId, setTargetWbId] = useState('');
  const [neuesZimmer, setNeuesZimmer] = useState(b.zimmer || '');
  const currentWb = wohnbereiche.find(w => w.id === b.wohnbereichId);
  const targetWb  = wohnbereiche.find(w => w.id === targetWbId);

  const doUmzug = () => {
    if (!targetWbId) return;
    const updated = state.bewohner.map(x =>
      x.id === b.id ? { ...x, wohnbereichId: targetWbId, zimmer: neuesZimmer } : x
    );
    onUpdate({ ...state, bewohner: updated });
    onClose();
  };

  return (
    <Modal title={`Umzug: ${b.name}`} onClose={onClose}>
      <div style={{ background: D.surface2, borderRadius: 7, padding: "10px 13px", marginBottom: 16, fontSize: 12 }}>
        <div style={{ color: D.muted, marginBottom: 2 }}>Aktuell</div>
        <div style={{ color: D.text, fontWeight: 600 }}>
          {currentWb ? <span style={{ color: currentWb.color }}>{currentWb.name}</span> : '‚Äì'}
          {b.zimmer && <span style={{ color: D.muted }}> ¬∑ Zi. {b.zimmer}</span>}
        </div>
      </div>
      <Lbl>Neuer Wohnbereich *</Lbl>
      <Sel value={targetWbId} onChange={e => setTargetWbId(e.target.value)}>
        <option value="">‚Äì Wohnbereich w√§hlen ‚Äì</option>
        {wohnbereiche.filter(w => w.id !== b.wohnbereichId).map(w =>
          <option key={w.id} value={w.id}>{w.name}</option>
        )}
      </Sel>
      <Lbl>Neues Zimmer (optional)</Lbl>
      <Inp value={neuesZimmer} onChange={e => setNeuesZimmer(e.target.value)} placeholder="z.B. 24b" />
      {targetWb && (
        <div style={{ background: targetWb.color + '18', border: `1px solid ${targetWb.color}40`, borderRadius: 7, padding: "9px 12px", marginBottom: 14, fontSize: 12, color: targetWb.color }}>
          ‚Üí Zieht in <strong>{targetWb.name}</strong>{neuesZimmer ? `, Zimmer ${neuesZimmer}` : ''}
        </div>
      )}
      <div style={{ display: "flex", gap: 10 }}>
        <Btn style={{ flex: 1 }} color={targetWb?.color || D.blue} onClick={doUmzug} >‚úì Umzug best√§tigen</Btn>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ WOHNBEREICHE VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function WohnbereicheView({ state, onUpdate, role, onCreateTask }) {
  const [activeId, setActiveId] = useState(null);
  const [showAddBW, setShowAddBW] = useState(false);
  const [showAddMA, setShowAddMA] = useState(false);
  const [showImport, setShowImport] = useState(false);
  const [showImportMA, setShowImportMA] = useState(false);
  const [umzugBewohner, setUmzugBewohner] = useState(null);
  const [bwOpen, setBWOpen] = useState(true);   // Bewohner aufgeklappt
  const [maOpen, setMAOpen] = useState(false);  // Mitarbeiter eingeklappt
  const isPDL = role === ROLE_PDL;
  const { wohnbereiche, bewohner, mitarbeiter } = state;

  // For non-PDL, lock to their WB
  const myWbId = roleIsWBL(role)||roleSL(role) ? roleWbId(role) : null;
  const visibleWBs = myWbId ? wohnbereiche.filter(w => w.id === myWbId) : wohnbereiche;
  const wb = wohnbereiche.find(w => w.id === (activeId || myWbId));

  // Auto-open for WBL/SL
  useEffect(() => { if (myWbId && !activeId) setActiveId(myWbId); }, [myWbId]);

  if (!activeId && isPDL) return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:6}}>
        <div style={{fontSize:18,fontWeight:700,color:D.text,...sora}}>Wohnbereiche</div>
      </div>
      <div style={{fontSize:12,color:D.muted,marginBottom:20}}>W√§hle einen Wohnbereich.</div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:12}}>
        {visibleWBs.map(wb=>{
          const bwCount=bewohner.filter(b=>b.wohnbereichId===wb.id).length;
          const maCount=mitarbeiter.filter(m=>m.wohnbereichId===wb.id).length;
          return(
            <div key={wb.id} onClick={()=>setActiveId(wb.id)}
              style={{...surfaceStyle({cursor:"pointer",padding:"18px 20px",borderTop:`3px solid ${wb.color}`})}}>
              <div style={{fontSize:15,fontWeight:700,color:wb.color,marginBottom:12,...sora}}>{wb.name}</div>
              <div style={{display:"flex",gap:16,fontSize:12,color:D.muted,...mono}}>
                <span>üë§ <strong style={{color:D.text}}>{bwCount}</strong> Bewohner</span>
                <span>üë• <strong style={{color:D.text}}>{maCount}</strong> MA</span>
              </div>
              <div style={{display:"flex",gap:8,marginTop:12,flexWrap:"wrap"}}>
                <Btn variant="secondary" style={{fontSize:11,padding:"3px 9px",borderColor:wb.color+"50",color:wb.color}} onClick={e=>{e.stopPropagation();onCreateTask("tpl-hygiene",wb);}}>üßπ Hygiene</Btn>
              </div>
            </div>
          );
        })}
      </div>
      {showImport && <BewohnerImportModal state={state} onUpdate={onUpdate} onClose={() => setShowImport(false)} />}
      {showImportMA && <MitarbeiterImportModal state={state} onUpdate={onUpdate} onClose={() => setShowImportMA(false)} />}
    </div>
  );

  if (!wb) return null;
  const wbBW = bewohner.filter(b => b.wohnbereichId === wb.id);
  const wbMA = mitarbeiter.filter(m => m.wohnbereichId === wb.id);

  return (
    <div>
      {isPDL && (
        <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:20}}>
          <Btn variant="ghost" onClick={()=>setActiveId(null)} style={{color:D.blue,padding:0}}>‚Üê √úbersicht</Btn>
          <div style={{width:10,height:10,borderRadius:"50%",background:wb.color}}/>
          <div style={{fontSize:17,fontWeight:700,color:wb.color,...sora}}>{wb.name}</div>
        </div>
      )}
      {!isPDL && <div style={{fontSize:17,fontWeight:700,color:wb.color,marginBottom:20,...sora}}>{wb.name}</div>}

      <div style={{display:"flex",gap:8,marginBottom:20,flexWrap:"wrap"}}>
        <Btn variant="secondary" style={{fontSize:12,borderColor:wb.color+"50",color:wb.color}} onClick={()=>onCreateTask("tpl-hygiene",wb)}>üßπ Hygienebegehung</Btn>
      </div>

      {/* Mitarbeiter ‚Äî eingeklappt */}
      <div style={{...surfaceStyle({padding:"0",marginBottom:10})}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"14px 18px",cursor:"pointer"}} onClick={()=>setMAOpen(p=>!p)}>
          <SectionTitle>Mitarbeiter ({wbMA.length})</SectionTitle>
          <div style={{display:"flex",gap:6,alignItems:"center"}}>
            <Btn color={wb.color} style={{fontSize:11,padding:"4px 10px"}} onClick={e=>{e.stopPropagation();setShowAddMA(true);}}>Ôºã</Btn>
            <span style={{fontSize:13,color:D.muted}}>{maOpen?'‚ñ≤':'‚ñº'}</span>
          </div>
        </div>
        {maOpen && (
          <div style={{padding:"0 18px 16px"}}>
            <MitarbeiterListe wbMA={wbMA} isPDL={isPDL} wbColor={wb.color} state={state} mitarbeiter={mitarbeiter} onUpdate={onUpdate} />
          </div>
        )}
      </div>

      {/* Bewohner ‚Äî aufgeklappt */}
      <div style={{...surfaceStyle({padding:"0",marginBottom:10})}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"14px 18px",cursor:"pointer"}} onClick={()=>setBWOpen(p=>!p)}>
          <SectionTitle>Bewohner ({wbBW.length})</SectionTitle>
          <div style={{display:"flex",gap:6,alignItems:"center"}}>
            <Btn color={wb.color} style={{fontSize:11,padding:"4px 10px"}} onClick={e=>{e.stopPropagation();setShowAddBW(true);}}>Ôºã</Btn>
            <span style={{fontSize:13,color:D.muted}}>{bwOpen?'‚ñ≤':'‚ñº'}</span>
          </div>
        </div>
        {bwOpen && (
          <div style={{padding:"0 18px 16px"}}>
            {wbBW.length===0
              ? <div style={{fontSize:12,color:D.muted,textAlign:"center",padding:"12px 0"}}>Noch keine Bewohner ‚Äì CSV importieren oder manuell hinzuf√ºgen.</div>
              : wbBW.map(b=>(
                <div key={b.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 0",borderBottom:`1px solid ${D.border}`}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:600,color:D.text}}>{b.name}</div>
                    <div style={{fontSize:10,color:D.muted,marginTop:2,...mono}}>
                      {b.zimmer&&`Zi. ${b.zimmer} ¬∑ `}{b.geburtsjahr&&`*${b.geburtsjahr} ¬∑ `}
                      {b.besonderheiten&&<span style={{color:wb.color}}>{b.besonderheiten}</span>}
                    </div>
                  </div>
                  <div style={{display:"flex",gap:6,alignItems:"center"}}>
                    {b.pflegegrad && <Tag color={wb.color} small>{b.pflegegrad}</Tag>}
                    <Btn variant="secondary" style={{fontSize:10,padding:"3px 8px",borderColor:wb.color+"40",color:wb.color}} onClick={()=>onCreateTask("tpl-pflegevisite",wb,b)}>ü©∫</Btn>
                    {isPDL&&<Btn variant="ghost" style={{fontSize:10,color:D.muted,padding:"3px 7px",border:`1px solid ${D.border}`}} onClick={()=>setUmzugBewohner(b)}>‚Üî Umzug</Btn>}
                    {isPDL&&<Btn variant="ghost" style={{color:D.border,fontSize:18,padding:"0 4px"}} onClick={()=>onUpdate({...state,bewohner:bewohner.filter(x=>x.id!==b.id)})}>√ó</Btn>}
                  </div>
                </div>
              ))
            }
          </div>
        )}
      </div>

      {showAddBW&&<AddBWForm wbId={activeId} wbColor={wb?.color} state={state} bewohner={bewohner} onUpdate={onUpdate} onClose={()=>setShowAddBW(false)} />}
      {showAddMA&&<AddMAForm wbId={activeId} wbColor={wb?.color} state={state} mitarbeiter={mitarbeiter} onUpdate={onUpdate} onClose={()=>setShowAddMA(false)} />}
      {showImport&&<BewohnerImportModal state={state} onUpdate={onUpdate} onClose={()=>setShowImport(false)} />}
      {showImportMA&&<MitarbeiterImportModal state={state} onUpdate={onUpdate} onClose={()=>setShowImportMA(false)} />}
      {umzugBewohner&&<BewohnerUmzugModal bewohner={umzugBewohner} wohnbereiche={wohnbereiche} state={state} onUpdate={onUpdate} onClose={()=>setUmzugBewohner(null)} />}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DashboardView({ state, role, onTabChange, allMessages }) {
  const { tasks, delegations=[], wohnbereiche, bewohner, mitarbeiter } = state;
  const now = todayStr();
  const isPDL = role === ROLE_PDL;
  const wbId = roleIsWBL(role)||roleSL(role) ? roleWbId(role) : null;

  const myTasks = wbId ? tasks.filter(t=>t.wbId===wbId||t.assignedTo===wbId) : tasks;
  const overdue  = myTasks.filter(t=>t.due<now&&t.status!=="done");
  const todayT   = myTasks.filter(t=>t.due===now&&t.status!=="done");
  const weekT    = myTasks.filter(t=>t.due>now&&t.due<=addDays(now,7)&&t.status!=="done");
  const openDeleg= (delegations||[]).filter(d=>d.status!=="erledigt");
  const urgent   = [...overdue,...todayT];

  // Unread messages for PDL (messages from WB)
  const unreadCount = isPDL ? Object.values(allMessages).flat().filter(m=>m.role!==ROLE_PDL).length : 0;
  // Unread for WB (messages from PDL)
  const wbUnread = wbId ? (allMessages[wbId]||[]).filter(m=>m.role===ROLE_PDL).length : 0;

  const wb = wbId ? wohnbereiche.find(w=>w.id===wbId) : null;

  return (
    <div>
      <div style={{marginBottom:24}}>
        <div style={{fontSize:22,fontWeight:700,color:D.text,...sora}}>
          {new Date().getHours()<12?"Guten Morgen":new Date().getHours()<18?"Guten Tag":"Guten Abend"} üëã
        </div>
        <div style={{fontSize:11,color:D.muted,marginTop:4,...mono}}>
          {new Date().toLocaleDateString("de-DE",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}
          {wb&&<span style={{color:wb.color}}> ¬∑ {wb.name}</span>}
          {isPDL&&<span style={{color:D.muted}}> ¬∑ PDL</span>}
        </div>
      </div>

      {/* Stats */}
      <div style={{marginBottom:6}}>
        <div style={{fontSize:10,fontWeight:600,color:D.muted,letterSpacing:1.5,textTransform:"uppercase",...mono,marginBottom:6}}>
          Aufgabenstatus{isPDL?" & Kommunikation":""}
        </div>
        <div style={{display:"grid",gridTemplateColumns:`repeat(${isPDL?4:3},1fr)`,gap:1,background:D.border,borderRadius:10,overflow:"hidden",marginBottom:22}}>
          {[
            {l:"√úberf√§llig",   v:overdue.length,  c:D.red,    tab:"aufgaben", icon:"‚ö†"},
            {l:"Heute f√§llig", v:todayT.length,   c:D.yellow, tab:"aufgaben", icon:"üìÖ"},
            {l:"Diese Woche",  v:weekT.length,    c:D.blue,   tab:"aufgaben", icon:"üìã"},
            ...(isPDL?[{l:"Nachrichten",  v:unreadCount, c:D.purple, tab:"nachrichten", icon:"üí¨"}]:[]),
          ].map(s=>(
            <div key={s.l} onClick={()=>onTabChange(s.tab)} style={{background:D.surface,padding:"16px 14px",cursor:"pointer"}}>
              <div style={{fontSize:26,fontWeight:700,color:s.c,lineHeight:1,...mono}}>{s.v}</div>
              <div style={{fontSize:10,color:D.muted,marginTop:4,textTransform:"uppercase",letterSpacing:1,...mono}}>{s.icon} {s.l}</div>
            </div>
          ))}
        </div>
      </div>

      {/* Neue Nachrichten Banner */}
      {wbUnread>0&&(
        <div onClick={()=>onTabChange("nachrichten")} style={{background:D.purpleDim,border:`1px solid ${D.purple}40`,borderRadius:8,padding:"11px 16px",marginBottom:16,cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{fontSize:13,color:D.purple}}>üí¨ {wbUnread} neue Nachricht{wbUnread>1?"en":""} von der PDL</span>
          <span style={{fontSize:11,color:D.purple,...mono}}>‚Üí √ñffnen</span>
        </div>
      )}

      {/* Heute im Fokus */}
      {urgent.length>0&&(
        <div style={{marginBottom:20}}>
          <SectionTitle>Heute im Fokus</SectionTitle>
          {urgent.slice(0,5).map(t=>{
            const tpl=TEMPLATES.find(x=>x.id===t.templateId);
            const isOv=t.due<now;
            return(
              <div key={t.id} style={{...surfaceStyle({padding:"11px 14px",marginBottom:6,borderLeft:`3px solid ${isOv?D.red:D.yellow}`})}}>
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <span style={{fontSize:17}}>{tpl?.icon||"üìã"}</span>
                  <div style={{flex:1}}>
                    <div style={{fontSize:13,fontWeight:600,color:D.text}}>{t.title}</div>
                    <div style={{fontSize:10,color:isOv?D.red:D.yellow,marginTop:2,...mono}}>{isOv?"‚ö† √úberf√§llig ‚Äì ":"F√§llig heute ‚Äì "}{fmtDate(t.due)}</div>
                  </div>
                  {t.checklist?.length>0&&<div style={{fontSize:10,color:D.muted,...mono}}>{t.checklist.filter(i=>i.done).length}/{t.checklist.length}</div>}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Wohnbereiche (PDL only) */}
      {isPDL&&(
        <>
          <SectionTitle>Wohnbereiche</SectionTitle>
          <div style={{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:10,marginBottom:20}}>
            {wohnbereiche.map(wb=>{
              const msgs=(allMessages[wb.id]||[]).filter(m=>m.role!==ROLE_PDL).length;
              return(
                <div key={wb.id} onClick={()=>onTabChange("wohnbereiche")}
                  style={{...surfaceStyle({padding:"13px 16px",cursor:"pointer",borderLeft:`3px solid ${wb.color}`})}}>
                  <div style={{fontSize:13,fontWeight:700,color:wb.color,marginBottom:5}}>{wb.name}</div>
                  <div style={{display:"flex",gap:12,fontSize:11,color:D.muted,...mono}}>
                    <span>üë§ {bewohner.filter(b=>b.wohnbereichId===wb.id).length}</span>
                    <span>üë• {mitarbeiter.filter(m=>m.wohnbereichId===wb.id).length}</span>
                    {msgs>0&&<span style={{color:D.purple}}>üí¨ {msgs}</span>}
                  </div>
                </div>
              );
            })}
          </div>
        </>
      )}

      {/* Diese Woche */}
      {weekT.length>0&&(
        <>
          <SectionTitle>Diese Woche noch f√§llig</SectionTitle>
          {weekT.slice(0,4).map(t=>{
            const tpl=TEMPLATES.find(x=>x.id===t.templateId);
            return(
              <div key={t.id} style={{...surfaceStyle({padding:"10px 14px",marginBottom:6,display:"flex",alignItems:"center",gap:10})}}>
                <span style={{fontSize:16}}>{tpl?.icon||"üìã"}</span>
                <div style={{flex:1}}>
                  <div style={{fontSize:13,color:D.text}}>{t.title}</div>
                  <div style={{fontSize:10,color:D.muted,marginTop:1,...mono}}>üìÖ {fmtDate(t.due)}</div>
                </div>
              </div>
            );
          })}
        </>
      )}

      {urgent.length===0&&weekT.length===0&&bewohner.length===0&&(
        <div style={{textAlign:"center",padding:"32px 16px"}}>
          <div style={{fontSize:48,marginBottom:14}}>üè•</div>
          <div style={{fontSize:17,fontWeight:700,color:D.text,marginBottom:8,...sora}}>Willkommen im PDL Cockpit</div>
          <div style={{fontSize:12,color:D.muted,marginBottom:20,lineHeight:1.7}}>
            Importiere Daten oder lade Demo-Inhalte<br/>um direkt loszulegen.
          </div>
          <div style={{display:"flex",gap:10,justifyContent:"center",flexWrap:"wrap",marginBottom:20}}>
            <Btn onClick={()=>onTabChange("settings")} style={{background:D.blue}}>‚öôÔ∏è Einstellungen & Demo-Daten</Btn>
            <Btn variant="secondary" onClick={()=>onTabChange("aufgaben")}>üìã Aufgabe anlegen</Btn>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8}}>
            {[
              {icon:"üë§",label:"Bewohner",desc:"CSV importieren"},
              {icon:"üë•",label:"Team",desc:"Mitarbeiter anlegen"},
              {icon:"‚úÖ",label:"Aufgaben",desc:"Checklisten nutzen"},
            ].map(item=>(
              <div key={item.label} style={{...surfaceStyle({padding:"12px 10px"}),textAlign:"center"}}>
                <div style={{fontSize:22,marginBottom:4}}>{item.icon}</div>
                <div style={{fontSize:11,fontWeight:600,color:D.text}}>{item.label}</div>
                <div style={{fontSize:10,color:D.muted,...mono}}>{item.desc}</div>
              </div>
            ))}
          </div>
        </div>
      )}
      {urgent.length===0&&weekT.length===0&&bewohner.length>0&&(
        <div style={{textAlign:"center",padding:"32px 0",color:D.muted}}>
          <div style={{fontSize:32,marginBottom:8}}>üéâ</div>
          <div style={{fontSize:14,fontWeight:600,color:D.green}}>Alles erledigt ‚Äî keine offenen Aufgaben!</div>
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ PIN VERWALTUNG (PDL only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function PINVerwaltung({ pins, wbNames, onSave }) {
  const [localPins, setLocalPins] = useState({ ...pins });
  const [saved, setSaved] = useState(false);
  const [show, setShow] = useState(false);

  const save = () => { onSave(localPins); showToast && showToast("PINs gespeichert"); setSaved(true); setTimeout(() => setSaved(false), 2000); };
  const inputType = show ? "text" : "password";

  const EyeBtn = () => (
    <button onClick={() => setShow(s => !s)}
      style={{ background: "none", border: `1px solid ${D.border}`, borderRadius: 6, padding: "4px 10px", cursor: "pointer", color: show ? D.blue : D.muted, fontSize: 13, fontFamily: "inherit", display: "flex", alignItems: "center", gap: 5 }}>
      {show ? "üôà Verbergen" : "üëÅ Anzeigen"}
    </button>
  );

  return (
    <div style={{ maxWidth: 460 }}>
      <SectionTitle>PIN-Verwaltung</SectionTitle>
      <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
          <Lbl style={{ marginBottom: 0 }}>PDL-PIN</Lbl>
          <EyeBtn />
        </div>
        <Inp type={inputType} value={localPins.pdl} onChange={e => setLocalPins(p => ({ ...p, pdl: e.target.value }))} placeholder="PIN f√ºr PDL" />
        {WB_IDS.map((id, i) => (
          <div key={id} style={{ marginBottom: 14 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: D.wb[i], marginBottom: 8 }}>{wbNames[id] || `Wohnbereich ${i + 2}`}</div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
              <div>
                <Lbl>WBL-PIN</Lbl>
                <Inp type={inputType} value={localPins.wbl[id]} onChange={e => setLocalPins(p => ({ ...p, wbl: { ...p.wbl, [id]: e.target.value } }))} placeholder="WBL-PIN" />
              </div>
              <div>
                <Lbl>Schichtleitung-PIN</Lbl>
                <Inp type={inputType} value={localPins.sl[id]} onChange={e => setLocalPins(p => ({ ...p, sl: { ...p.sl, [id]: e.target.value } }))} placeholder="SL-PIN" />
              </div>
            </div>
          </div>
        ))}
        <Btn onClick={save} style={{ marginTop: 4 }}>{saved ? "‚úì Gespeichert" : "PINs speichern"}</Btn>
      </div>
      <div style={{ fontSize: 11, color: D.muted, ...mono, lineHeight: 1.6 }}>
        Hinweis: PINs werden geteilt gespeichert. W√§hle PINs die nur deinen Mitarbeitenden bekannt sind.
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ DATEN L√ñSCHEN SEKTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DatenLoeschenSektion({ state, onUpdate, onClearMedizin }) {
  const [confirm1, setConfirm1] = useState("");
  const [confirm2, setConfirm2] = useState("");
  const [confirm3, setConfirm3] = useState("");
  const [confirm4, setConfirm4] = useState("");
  const [done, setDone] = useState({});

  const flash = (key) => {
    setDone(p => ({ ...p, [key]: true }));
    setTimeout(() => setDone(p => ({ ...p, [key]: false })), 2500);
  };

  const loeschBewohner = () => {
    if (confirm1 !== "BEWOHNER") return;
    onUpdate({ ...state, bewohner: [] });
    setConfirm1("");
    flash("bw");
  };

  const loeschMitarbeiter = () => {
    if (confirm2 !== "MITARBEITER") return;
    onUpdate({ ...state, mitarbeiter: [] });
    setConfirm2("");
    flash("ma");
  };

  const loeschFortbildung = async () => {
    if (confirm3 !== "FORTBILDUNG") return;
    try { await window.storage.set("pdl-v5-fbdata", [], true); } catch {}
    try { await window.storage.set("pdl-v5-fbarchive", [], true); } catch {}
    setConfirm3("");
    flash("fb");
  };

  const loeschMedizin = () => {
    if (confirm4 !== "MEDIZIN") return;
    if (onClearMedizin) onClearMedizin();
    setConfirm4("");
    flash("med");
  };

  const inputStyle = {
    width: "100%", background: D.surface2, border: `1px solid ${D.border}`,
    borderRadius: 7, color: D.text, padding: "8px 11px", fontSize: 13,
    boxSizing: "border-box", outline: "none", fontFamily: "inherit", marginBottom: 8,
  };

  const sections = [
    {
      key: "bw",
      label: "Bewohner l√∂schen",
      icon: "üè†",
      count: `${state.bewohner.length} Bewohner`,
      color: D.red,
      keyword: "BEWOHNER",
      val: confirm1,
      setVal: setConfirm1,
      action: loeschBewohner,
      desc: "Alle Bewohnerdaten aus allen Wohnbereichen werden unwiderruflich gel√∂scht.",
    },
    {
      key: "ma",
      label: "Mitarbeiter l√∂schen",
      icon: "üë•",
      count: `${state.mitarbeiter.length} Mitarbeiter`,
      color: D.orange || "#f97316",
      keyword: "MITARBEITER",
      val: confirm2,
      setVal: setConfirm2,
      action: loeschMitarbeiter,
      desc: "Alle Mitarbeiterdaten aus allen Wohnbereichen werden unwiderruflich gel√∂scht.",
    },
    {
      key: "fb",
      label: "Fortbildungsdaten l√∂schen",
      icon: "üìö",
      count: "Alle Fortbildungseintr√§ge & Snapshots",
      color: D.yellow,
      keyword: "FORTBILDUNG",
      val: confirm3,
      setVal: setConfirm3,
      action: loeschFortbildung,
      desc: "Alle importierten Fortbildungsdaten und gespeicherten Snapshots werden gel√∂scht.",
    },
    {
      key: "med",
      label: "Medizinprodukte l√∂schen",
      icon: "üîß",
      count: "Ger√§teregister, Einweisungen & Bewohnerger√§te",
      color: D.blue,
      keyword: "MEDIZIN",
      val: confirm4,
      setVal: setConfirm4,
      action: loeschMedizin,
      desc: "Alle importierten Ger√§te, Einweisungsdaten und manuell angelegten Bewohnerger√§te werden gel√∂scht.",
    },
  ];

  return (
    <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
      <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 4 }}>üóë Datens√§tze l√∂schen</div>
      <div style={{ fontSize: 11, color: D.muted, marginBottom: 16, ...mono }}>
        Tippe das angezeigte Schl√ºsselwort ein um den jeweiligen Datensatz zu l√∂schen.
      </div>
      {sections.map(s => (
        <div key={s.key} style={{ borderTop: `1px solid ${D.border}`, paddingTop: 14, marginBottom: 14 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 6 }}>
            <div>
              <div style={{ fontSize: 13, fontWeight: 600, color: D.text }}>{s.icon} {s.label}</div>
              <div style={{ fontSize: 11, color: D.muted, ...mono, marginTop: 2 }}>{s.count}</div>
            </div>
            {done[s.key] && (
              <div style={{ fontSize: 11, color: D.green, fontWeight: 700, ...mono }}>‚úì Gel√∂scht</div>
            )}
          </div>
          <div style={{ fontSize: 11, color: D.muted, marginBottom: 10, lineHeight: 1.5 }}>{s.desc}</div>
          <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <input
              value={s.val}
              onChange={e => s.setVal(e.target.value.toUpperCase())}
              placeholder={`‚Äû${s.keyword}" eingeben`}
              style={{ ...inputStyle, marginBottom: 0, flex: 1, borderColor: s.val === s.keyword ? s.color : D.border }}
            />
            <Btn
              variant="danger"
              style={{ flexShrink: 0, opacity: s.val === s.keyword ? 1 : 0.35, cursor: s.val === s.keyword ? "pointer" : "not-allowed" }}
              onClick={s.action}
            >
              L√∂schen
            </Btn>
          </div>
          {s.val.length > 0 && s.val !== s.keyword && (
            <div style={{ fontSize: 10, color: s.color, marginTop: 4, ...mono }}>
              Erwartet: ‚Äû{s.keyword}"
            </div>
          )}
        </div>
      ))}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ EINSTELLUNGEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function EinstellungenView({ state, onUpdate, role, pins, onSavePins, showToast, onClearMedizin, onImportBewohner, onImportMA, onImportFb, onImportGeraete, onImportEinweisungen, medGeraete, medEinweisungen, medBewohner }) {
  const isPDL = role === ROLE_PDL;
  const [email, setEmail] = useState(state.email || "");
  const [showImportBW, setShowImportBW]     = useState(false);
  const [showImportMA, setShowImportMA]     = useState(false);
  const { theme, setTheme } = React.useContext(ThemeContext);

  return (
    <div style={{ maxWidth: 460 }}>
      <div style={{ fontSize: 18, fontWeight: 700, color: D.text, marginBottom: 20, ...sora }}>Einstellungen</div>
      {isPDL && (
        <>
          {/* CSV Importe */}
          <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 4 }}>üì• Daten importieren</div>
            <div style={{ fontSize: 11, color: D.muted, marginBottom: 14, ...mono }}>Alle CSV-Importe zentral an einem Ort.</div>
            <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 12px", background:D.surface2, borderRadius:8 }}>
                <div>
                  <div style={{ fontSize:12, fontWeight:600, color:D.text }}>üìã Bewohner</div>
                  <div style={{ fontSize:10, color:D.muted, ...mono }}>{state.bewohner.length} importiert</div>
                </div>
                <Btn variant="secondary" style={{ fontSize:11, padding:"5px 12px", color:D.blue, borderColor:D.blue+"40" }}
                  onClick={() => setShowImportBW(true)}>CSV laden</Btn>
              </div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 12px", background:D.surface2, borderRadius:8 }}>
                <div>
                  <div style={{ fontSize:12, fontWeight:600, color:D.text }}>üë• Mitarbeiter</div>
                  <div style={{ fontSize:10, color:D.muted, ...mono }}>{state.mitarbeiter.length} importiert</div>
                </div>
                <Btn variant="secondary" style={{ fontSize:11, padding:"5px 12px", color:D.green, borderColor:D.green+"40" }}
                  onClick={() => setShowImportMA(true)}>CSV laden</Btn>
              </div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 12px", background:D.surface2, borderRadius:8 }}>
                <div>
                  <div style={{ fontSize:12, fontWeight:600, color:D.text }}>üéì Fortbildungen</div>
                  <div style={{ fontSize:10, color:D.muted, ...mono }}>√úber Fortbildungs-Tab importierbar</div>
                </div>
                <Btn variant="secondary" style={{ fontSize:11, padding:"5px 12px", color:D.yellow, borderColor:D.yellow+"40" }}
                  onClick={() => onImportFb && onImportFb()}>CSV laden</Btn>
              </div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 12px", background:D.surface2, borderRadius:8 }}>
                <div>
                  <div style={{ fontSize:12, fontWeight:600, color:D.text }}>üîß Medizinprodukte ‚Äî Ger√§te</div>
                  <div style={{ fontSize:10, color:D.muted, ...mono }}>{medGeraete?.length||0} importiert</div>
                </div>
                <label style={{ cursor:"pointer" }}>
                  <input type="file" accept=".csv" style={{ display:"none" }} onChange={onImportGeraete} />
                  <span style={{ fontSize:11, padding:"5px 12px", color:D.blue, borderColor:D.blue+"40", border:`1px solid ${D.blue}40`, borderRadius:7, background:"transparent", cursor:"pointer" }}>CSV laden</span>
                </label>
              </div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 12px", background:D.surface2, borderRadius:8 }}>
                <div>
                  <div style={{ fontSize:12, fontWeight:600, color:D.text }}>üîß Medizinprodukte ‚Äî Einweisungen</div>
                  <div style={{ fontSize:10, color:D.muted, ...mono }}>{medEinweisungen?.length||0} importiert</div>
                </div>
                <label style={{ cursor:"pointer" }}>
                  <input type="file" accept=".csv" style={{ display:"none" }} onChange={onImportEinweisungen} />
                  <span style={{ fontSize:11, padding:"5px 12px", color:D.blue, borderColor:D.blue+"40", border:`1px solid ${D.blue}40`, borderRadius:7, background:"transparent", cursor:"pointer" }}>CSV laden</span>
                </label>
              </div>
            </div>
          </div>

          <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 4 }}>üé≠ Demo-Daten</div>
            <div style={{ fontSize: 11, color: D.muted, marginBottom: 14, ...mono }}>F√ºllt die App mit realistischen Musterdaten f√ºr Pr√§sentationen.</div>
            <Btn onClick={() => {
              const demoState = generateDemoState();
              onUpdate(demoState);
              showToast && showToast("Demo-Daten geladen! üéâ");
            }} style={{ width: "100%", justifyContent: "center", background: D.green }}>
              ‚ú® Demo-Daten laden
            </Btn>
          </div>

          <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 12 }}>üè• Einrichtung</div>
            <Lbl>Name der Einrichtung</Lbl>
            <Inp value={state.einrichtungsname || ""} onChange={e => onUpdate({ ...state, einrichtungsname: e.target.value })} placeholder="z.B. Seniorenresidenz Musterstadt" />
            <Lbl>Einrichtungsnummer</Lbl>
            <Inp value={state.einrichtungsnummer || ""} onChange={e => onUpdate({ ...state, einrichtungsnummer: e.target.value })} placeholder="z.B. 2140" style={{ marginBottom: 0 }} />
          </div>

          <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 4 }}>üé® Erscheinungsbild</div>
            <div style={{ fontSize: 11, color: D.muted, marginBottom: 14, ...mono }}>Wechsle zwischen hellem und dunklem Design.</div>
            <div style={{ display: "flex", gap: 10 }}>
              {[["dark", "üåô Dark Mode"], ["light", "‚òÄÔ∏è Light Mode"]].map(([t, label]) => (
                <button key={t} onClick={() => setTheme(t)}
                  style={{ flex: 1, padding: "12px 16px", borderRadius: 9, border: `2px solid ${theme === t ? D.blue : D.border}`, background: theme === t ? D.blue + "18" : D.surface2, color: theme === t ? D.blue : D.muted, fontSize: 13, fontWeight: theme === t ? 700 : 400, cursor: "pointer", fontFamily: "inherit", transition: "all .15s" }}>
                  {label}
                </button>
              ))}
            </div>
          </div>

          <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 12 }}>Wohnbereichsnamen</div>
            {state.wohnbereiche.map((wb, i) => (
              <div key={wb.id} style={{ display: "flex", gap: 10, alignItems: "center", marginBottom: 8 }}>
                <div style={{ width: 10, height: 10, borderRadius: "50%", background: wb.color, flexShrink: 0 }} />
                <Inp style={{ marginBottom: 0, flex: 1 }} value={wb.name}
                  onChange={e => onUpdate({ ...state, wohnbereiche: state.wohnbereiche.map(w => w.id === wb.id ? { ...w, name: e.target.value } : w) })} />
              </div>
            ))}
          </div>
          <PINVerwaltung pins={pins} wbNames={Object.fromEntries(state.wohnbereiche.map(w => [w.id, w.name]))} onSave={onSavePins} />
          <div style={{ ...surfaceStyle({ padding: "18px 20px", marginBottom: 12 }) }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: D.text, marginBottom: 12 }}>Daten & Speicher</div>
            {(() => {
              const stateKB = estimateKB(state);
              const pct = Math.round(stateKB / 5120 * 100);
              const barColor = pct > 80 ? D.red : pct > 60 ? D.yellow : D.green;
              return (
                <>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 14 }}>
                    {[
                      ["Aktive Aufgaben", state.tasks.length],
                      ["Aufgaben im Verlauf", (state.taskLog||[]).length],
                      ["Delegationen", (state.delegations||[]).length],
                      ["Mitarbeiter", state.mitarbeiter.length],
                      ["Bewohner", state.bewohner.length],
                    ].map(([l,v]) => (
                      <div key={l} style={{ background: D.surface2, borderRadius: 6, padding: "8px 10px" }}>
                        <div style={{ fontSize: 10, color: D.muted, ...mono }}>{l}</div>
                        <div style={{ fontSize: 18, fontWeight: 700, color: D.text, ...mono }}>{v}</div>
                      </div>
                    ))}
                  </div>
                  <div style={{ marginBottom: 14 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: 11, color: D.muted, marginBottom: 4, ...mono }}>
                      <span>Speicherverbrauch (gesch√§tzt)</span>
                      <span style={{ color: barColor }}>{stateKB} KB / 5120 KB</span>
                    </div>
                    <div style={{ background: D.border, borderRadius: 99, height: 6, overflow: "hidden" }}>
                      <div style={{ width: `${Math.min(pct, 100)}%`, height: "100%", background: barColor, borderRadius: 99, transition: "width .3s" }} />
                    </div>
                    {pct > 70 && <div style={{ fontSize: 11, color: D.yellow, marginTop: 6, ...mono }}>‚ö† Speicher wird knapp ‚Äì √§ltere Daten manuell bereinigen.</div>}
                  </div>
                  <div style={{ fontSize: 11, color: D.muted, ...mono, marginBottom: 14, lineHeight: 1.7 }}>
                    Verlauf: Aufgaben nach 90 Tagen ¬∑ Nachrichten nach 30 Tagen
                  </div>
                </>
              );
            })()}
          </div>
          <DatenLoeschenSektion state={state} onUpdate={onUpdate} onClearMedizin={onClearMedizin} />
          {showImportBW && <BewohnerImportModal state={state} onUpdate={onUpdate} onClose={() => setShowImportBW(false)} />}
          {showImportMA && <MitarbeiterImportModal state={state} onUpdate={onUpdate} onClose={() => setShowImportMA(false)} />}
        </>
      )}
      {!isPDL && (
        <div style={{ ...surfaceStyle({ padding: "24px 20px", textAlign: "center" }) }}>
          <div style={{ fontSize: 32, marginBottom: 10 }}>üîí</div>
          <div style={{ fontSize: 13, color: D.muted }}>Einstellungen sind nur f√ºr die PDL zug√§nglich.</div>
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NAV_PDL = [
  { k: "dashboard",    icon: "üè†", label: "√úbersicht"      },
  { k: "wohnbereiche", icon: "üè•", label: "Wohnbereiche"   },
  { k: "aufgaben",     icon: "üìã", label: "Aufgaben"        },
  { k: "delegation",   icon: "üë•", label: "Delegation"      },
  { k: "prozesse",     icon: "üìù", label: "Prozesse"        },
  { k: "nachrichten",  icon: "üí¨", label: "Nachrichten"     },
  { k: "fortbildung",  icon: "üéì", label: "Fortbildung"     },
  { k: "medizin",      icon: "üîß", label: "Medizinprodukte" },
  { k: "settings",     icon: "‚öô",  label: "Einstellungen"  },
];
const NAV_WBL = [
  { k: "dashboard",    icon: "üè†", label: "√úbersicht"      },
  { k: "wohnbereiche", icon: "üè•", label: "Mein Bereich"   },
  { k: "aufgaben",     icon: "üìã", label: "Aufgaben"        },
  { k: "prozesse",     icon: "üìù", label: "Prozesse"        },
  { k: "nachrichten",  icon: "üí¨", label: "Nachrichten"     },
  { k: "fortbildung",  icon: "üéì", label: "Fortbildung"     },
  { k: "medizin",      icon: "üîß", label: "Medizinprodukte" },
];
const NAV_SL = [
  { k: "dashboard",    icon: "üè†", label: "√úbersicht"   },
  { k: "wohnbereiche", icon: "üè•", label: "Mein Bereich" },
  { k: "aufgaben",     icon: "üìã", label: "Aufgaben"     },
  { k: "prozesse",     icon: "üìù", label: "Prozesse"      },
  { k: "nachrichten",  icon: "üí¨", label: "Nachrichten"  },
];

// ‚îÄ‚îÄ‚îÄ MEDIZINPRODUKTE (MPBetreibV) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function parseGeraeteCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = lines[0].split(';').map(h => h.replace(/^"|"$/g,'').trim().toLowerCase().replace(/ /g,'_'));
  return lines.slice(1).map(line => {
    const cols = line.split(';').map(c => c.replace(/^"|"$/g,'').trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i] || '');
    return obj;
  }).filter(r => r.geraet_id);
}

function parseEinweisungenCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = lines[0].split(';').map(h => h.replace(/^"|"$/g,'').trim().toLowerCase().replace(/ /g,'_'));
  return lines.slice(1).map(line => {
    const cols = line.split(';').map(c => c.replace(/^"|"$/g,'').trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i] || '');
    return obj;
  }).filter(r => r.einweisung_id);
}

function ampelStatus(datumStr) {
  if (!datumStr) return 'grau';
  const d = new Date(datumStr);
  const now = new Date();
  const diffDays = Math.round((d - now) / 86400000);
  if (diffDays < 0)   return 'rot';
  if (diffDays <= 60) return 'gelb';
  return 'gruen';
}

function ampelColor(status) {
  if (status === 'rot')   return D.red;
  if (status === 'gelb')  return D.yellow;
  if (status === 'gruen') return D.green;
  return D.muted;
}

function ampelLabel(datumStr) {
  if (!datumStr) return '‚Äì';
  const d = new Date(datumStr);
  const now = new Date();
  const diffDays = Math.round((d - now) / 86400000);
  if (diffDays < 0)   return `√úberf√§llig (${Math.abs(diffDays)}d)`;
  if (diffDays === 0) return 'Heute f√§llig';
  if (diffDays <= 60) return `In ${diffDays} Tagen`;
  return fmtDate(datumStr);
}

// Demo-Daten f√ºr Bewohnerger√§te
function bewohnerGeraeteDemoData() {
  const t = (d) => { const x = new Date(); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); };
  return [
    // WB2 ‚Äì gr√ºn
    { id:uid(), bewohnerName:'M√ºller, Erich',    zimmer:'201', wbId:'wb2', wbName:'Wohnbereich 2', geraet:'Wechseldruckmatratze', kategorie:'Wechseldruckmatratze', sanitaetshaus:'Sanit√§tshaus Weber GmbH', ersteinweisungDatum:t(-200), ersteinweiserName:'Hr. Weber (Techniker)', multiplikatorName:'M√ºller Anna', multiplikatorDatum:t(-198), letzteWiederholung:t(-200), naechsteFaelligkeit:t(165), belegort:'Bewohnerakte Zi. 201', bemerkung:'Verordnung Dr. Schmidt 03/2024' },
    { id:uid(), bewohnerName:'M√ºller, Erich',    zimmer:'201', wbId:'wb2', wbName:'Wohnbereich 2', geraet:'Rollstuhl Spezialanpassung', kategorie:'Rollstuhl', sanitaetshaus:'Sanit√§tshaus Weber GmbH', ersteinweisungDatum:t(-180), ersteinweiserName:'Hr. Weber (Techniker)', multiplikatorName:'Schmidt Peter', multiplikatorDatum:t(-178), letzteWiederholung:t(-180), naechsteFaelligkeit:t(185), belegort:'Bewohnerakte Zi. 201', bemerkung:'Elektrischer Antrieb, Spezialsteuerung' },
    { id:uid(), bewohnerName:'Braun, Hildegard', zimmer:'205', wbId:'wb2', wbName:'Wohnbereich 2', geraet:'Sondenpumpe Applix TF', kategorie:'Sondenpumpe', sanitaetshaus:'Fresenius Kabi Technik', ersteinweisungDatum:t(-150), ersteinweiserName:'Fr. Klein (Fresenius)', multiplikatorName:'Wagner Lisa', multiplikatorDatum:t(-148), letzteWiederholung:t(-150), naechsteFaelligkeit:t(215), belegort:'Bewohnerakte Zi. 205', bemerkung:'PEG-Sonde seit 02/2024' },
    // WB3 ‚Äì gelb (bald f√§llig)
    { id:uid(), bewohnerName:'Fischer, Heinrich', zimmer:'301', wbId:'wb3', wbName:'Wohnbereich 3', geraet:'Wechseldruckmatratze', kategorie:'Wechseldruckmatratze', sanitaetshaus:'Reha-Aktiv GmbH', ersteinweisungDatum:t(-330), ersteinweiserName:'Hr. Bauer (Reha-Aktiv)', multiplikatorName:'Fischer Thomas', multiplikatorDatum:t(-328), letzteWiederholung:t(-330), naechsteFaelligkeit:t(35), belegort:'Bewohnerakte Zi. 301', bemerkung:'Dekubitus Grad 2 ‚Äì Verordnung erneuert' },
    { id:uid(), bewohnerName:'Fischer, Heinrich', zimmer:'301', wbId:'wb3', wbName:'Wohnbereich 3', geraet:'Rollator mit Sitzfl√§che Spezial', kategorie:'Rollator', sanitaetshaus:'Reha-Aktiv GmbH', ersteinweisungDatum:t(-340), ersteinweiserName:'Hr. Bauer (Reha-Aktiv)', multiplikatorName:'Weber Sandra', multiplikatorDatum:t(-338), letzteWiederholung:t(-340), naechsteFaelligkeit:t(25), belegort:'Bewohnerakte Zi. 301', bemerkung:'H√∂henanpassung, Bremssystem angepasst' },
    { id:uid(), bewohnerName:'Hoffmann, Gertrud', zimmer:'308', wbId:'wb3', wbName:'Wohnbereich 3', geraet:'Sondenpumpe Applix TF', kategorie:'Sondenpumpe', sanitaetshaus:'Fresenius Kabi Technik', ersteinweisungDatum:t(-345), ersteinweiserName:'Fr. Klein (Fresenius)', multiplikatorName:'Meyer J√∂rg', multiplikatorDatum:t(-343), letzteWiederholung:t(-345), naechsteFaelligkeit:t(20), belegort:'Bewohnerakte Zi. 308', bemerkung:'' },
    // WB4 ‚Äì rot (√ºberf√§llig)
    { id:uid(), bewohnerName:'Klein, Werner',    zimmer:'402', wbId:'wb4', wbName:'Wohnbereich 4', geraet:'Wechseldruckmatratze', kategorie:'Wechseldruckmatratze', sanitaetshaus:'MediCare Hilfsmittel', ersteinweisungDatum:t(-400), ersteinweiserName:'Hr. Richter (MediCare)', multiplikatorName:'Richter Eva', multiplikatorDatum:t(-398), letzteWiederholung:t(-400), naechsteFaelligkeit:t(-35), belegort:'Ordner WB4 ‚Äì Haustechnik', bemerkung:'Wiederholung √ºberf√§llig!' },
    { id:uid(), bewohnerName:'Wolf, Margarethe', zimmer:'410', wbId:'wb4', wbName:'Wohnbereich 4', geraet:'Sondenpumpe Applix TF', kategorie:'Sondenpumpe', sanitaetshaus:'Fresenius Kabi Technik', ersteinweisungDatum:t(-380), ersteinweiserName:'Fr. Klein (Fresenius)', multiplikatorName:'Klein Michael', multiplikatorDatum:t(-378), letzteWiederholung:t(-380), naechsteFaelligkeit:t(-20), belegort:'Bewohnerakte Zi. 410', bemerkung:'Nachweis fehlt ‚Äì neu anfordern!' },
    { id:uid(), bewohnerName:'Wolf, Margarethe', zimmer:'410', wbId:'wb4', wbName:'Wohnbereich 4', geraet:'Rollstuhl Spezialanpassung', kategorie:'Rollstuhl', sanitaetshaus:'MediCare Hilfsmittel', ersteinweisungDatum:t(-370), ersteinweiserName:'Hr. Richter (MediCare)', multiplikatorName:'Sch√§fer Bernd', multiplikatorDatum:t(-368), letzteWiederholung:t(-370), naechsteFaelligkeit:t(-10), belegort:'Bewohnerakte Zi. 410', bemerkung:'' },
    // WB5 ‚Äì gemischt
    { id:uid(), bewohnerName:'Lange, Elfriede',  zimmer:'502', wbId:'wb5', wbName:'Wohnbereich 5', geraet:'Wechseldruckmatratze', kategorie:'Wechseldruckmatratze', sanitaetshaus:'Sanit√§tshaus Nord GmbH', ersteinweisungDatum:t(-90), ersteinweiserName:'Fr. Schneider (Sanit√§tshaus Nord)', multiplikatorName:'Zimmermann Lars', multiplikatorDatum:t(-88), letzteWiederholung:t(-90), naechsteFaelligkeit:t(275), belegort:'Bewohnerakte Zi. 502', bemerkung:'' },
  ];
}

function NeuBewohnerGeraetModal({ state, wbId, onSave, onClose }) {
  const bewohner = wbId ? state.bewohner.filter(b => b.wohnbereichId === wbId) : state.bewohner;
  const wohnbereiche = state.wohnbereiche;
  const [selectedWb, setSelectedWb] = useState(wbId || '');
  const [form, setForm] = useState({
    bewohnerName:'', zimmer:'', wbId:wbId||'', wbName:'',
    geraet:'', kategorie:'Wechseldruckmatratze',
    sanitaetshaus:'', ersteinweisungDatum:todayStr(),
    ersteinweiserName:'', multiplikatorName:'',
    multiplikatorDatum:todayStr(), letzteWiederholung:todayStr(),
    naechsteFaelligkeit:addMonths(todayStr(),12),
    belegort:'', bemerkung:'',
  });
  const f = (k,v) => setForm(p => ({...p,[k]:v}));
  const wbBewohner = selectedWb ? state.bewohner.filter(b => b.wohnbereichId === selectedWb) : [];

  const handleBewohner = (id) => {
    const b = state.bewohner.find(x => x.id === id);
    if (b) { f('bewohnerName', b.name); f('zimmer', b.zimmer||''); }
  };
  const handleWb = (id) => {
    setSelectedWb(id);
    const wb = wohnbereiche.find(w => w.id === id);
    f('wbId', id); f('wbName', wb?.name||'');
    f('bewohnerName',''); f('zimmer','');
  };
  const canSave = form.bewohnerName && form.geraet && form.sanitaetshaus && form.ersteinweisungDatum && form.ersteinweiserName;

  return (
    <Modal title="Bewohnerger√§t anlegen" onClose={onClose}>
      {!wbId && <>
        <Lbl>Wohnbereich *</Lbl>
        <Sel value={selectedWb} onChange={e => handleWb(e.target.value)}>
          <option value="">‚Äì Wohnbereich w√§hlen ‚Äì</option>
          {wohnbereiche.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
        </Sel>
      </>}
      <Lbl>Bewohner *</Lbl>
      {wbBewohner.length > 0
        ? <Sel value="" onChange={e => handleBewohner(e.target.value)}>
            <option value="">‚Äì Bewohner w√§hlen ‚Äì</option>
            {wbBewohner.map(b => <option key={b.id} value={b.id}>{b.name}{b.zimmer?` ¬∑ Zi. ${b.zimmer}`:''}</option>)}
          </Sel>
        : <Inp value={form.bewohnerName} onChange={e => f('bewohnerName',e.target.value)} placeholder="Nachname, Vorname" />
      }
      {form.bewohnerName && <div style={{fontSize:12,color:D.green,marginTop:4}}>‚úì {form.bewohnerName}{form.zimmer?` ¬∑ Zi. ${form.zimmer}`:''}</div>}
      <Lbl>Zimmer</Lbl>
      <Inp value={form.zimmer} onChange={e => f('zimmer',e.target.value)} placeholder="z.B. 201" />
      <Lbl>Ger√§t *</Lbl>
      <Inp value={form.geraet} onChange={e => f('geraet',e.target.value)} placeholder="z.B. Wechseldruckmatratze, Sondenpumpe Applix TF" />
      <Lbl>Kategorie</Lbl>
      <Sel value={form.kategorie} onChange={e => f('kategorie',e.target.value)}>
        {['Wechseldruckmatratze','Sondenpumpe','Rollstuhl','Rollator','Orthese','Sonstiges'].map(k => <option key={k}>{k}</option>)}
      </Sel>
      <Lbl>Sanit√§tshaus / Lieferant *</Lbl>
      <Inp value={form.sanitaetshaus} onChange={e => f('sanitaetshaus',e.target.value)} placeholder="z.B. Sanit√§tshaus Weber GmbH" />
      <Lbl>Ersteinweisung Datum *</Lbl>
      <Inp type="date" value={form.ersteinweisungDatum} onChange={e => { f('ersteinweisungDatum',e.target.value); f('letzteWiederholung',e.target.value); f('naechsteFaelligkeit',addMonths(e.target.value,12)); }} />
      <Lbl>Ersteinweiser (Name + Funktion) *</Lbl>
      <Inp value={form.ersteinweiserName} onChange={e => f('ersteinweiserName',e.target.value)} placeholder="z.B. Hr. Weber (Techniker Sanit√§tshaus)" />
      <Lbl>Multiplikator (Mitarbeiter der einweisen darf)</Lbl>
      <Inp value={form.multiplikatorName} onChange={e => f('multiplikatorName',e.target.value)} placeholder="z.B. M√ºller Anna (WBL)" />
      <Lbl>N√§chste Wiederholung f√§llig</Lbl>
      <Inp type="date" value={form.naechsteFaelligkeit} onChange={e => f('naechsteFaelligkeit',e.target.value)} />
      <Lbl>Belegort (Papiernachweis)</Lbl>
      <Inp value={form.belegort} onChange={e => f('belegort',e.target.value)} placeholder="z.B. Bewohnerakte Zi. 201" />
      <Lbl>Bemerkung</Lbl>
      <Inp value={form.bemerkung} onChange={e => f('bemerkung',e.target.value)} placeholder="z.B. PEG-Sonde seit 03/2024" />
      <div style={{marginTop:16, display:'flex', gap:8, justifyContent:'flex-end'}}>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
        <Btn onClick={() => canSave && onSave({...form, id:uid()})} style={{opacity:canSave?1:.5}}>Speichern</Btn>
      </div>
    </Modal>
  );
}

function MedizinView({ state, role, geraete, setGeraete, einweisungen, setEinweisungen, bewohnerGeraete, setBewohnerGeraete }) {
  const [subTab, setSubTab]                 = useState('geraete');
  const [filterWb, setFilterWb]             = useState('alle');
  const [filterKat, setFilterKat]           = useState('alle');
  const [filterAmpel, setFilterAmpel]       = useState('alle');
  const [selectedGeraet, setSelectedGeraet] = useState(null);
  const [search, setSearch]                 = useState('');
  const [showNeu, setShowNeu]               = useState(false);
  const [editItem, setEditItem]             = useState(null);
  const [deleteConfirm, setDeleteConfirm]   = useState(null);

  const isPDL = role === ROLE_PDL;
  const wbId  = roleIsWBL(role) ? roleWbId(role) : null;

  const importGeraete = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const rows = parseGeraeteCSV(ev.target.result);
      setGeraete(rows);
    };
    reader.readAsText(file, 'utf-8');
    e.target.value = '';
  };

  const importEinweisungen = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const rows = parseEinweisungenCSV(ev.target.result);
      setEinweisungen(rows);
    };
    reader.readAsText(file, 'utf-8');
    e.target.value = '';
  };

  // Filter nach WB-Rolle
  const myGeraete = wbId ? geraete.filter(g => g.standort_wbid === wbId) : geraete;
  const myEinweisungen = wbId ? einweisungen.filter(e => e.standort_wbid === wbId) : einweisungen;

  const kategorien = [...new Set(myGeraete.map(g => g.kategorie))].filter(Boolean);
  const wohnbereiche = [...new Set(myGeraete.map(g => g.standort_wbid))].filter(Boolean);

  const filteredGeraete = myGeraete.filter(g => {
    if (filterWb !== 'alle' && g.standort_wbid !== filterWb) return false;
    if (filterKat !== 'alle' && g.kategorie !== filterKat) return false;
    if (search && !g.name.toLowerCase().includes(search.toLowerCase()) && !g.kategorie.toLowerCase().includes(search.toLowerCase())) return false;
    if (filterAmpel !== 'alle') {
      const status = ampelStatus(g.naechste_pruefung);
      if (status !== filterAmpel) return false;
    }
    return true;
  });

  // Einweisungen f√ºr ausgew√§hltes Ger√§t
  const geraetEinweisungen = selectedGeraet
    ? myEinweisungen.filter(e => e.geraet_id === selectedGeraet.geraet_id)
    : [];

  // Statistiken
  const rot   = myGeraete.filter(g => ampelStatus(g.naechste_pruefung) === 'rot').length;
  const gelb  = myGeraete.filter(g => ampelStatus(g.naechste_pruefung) === 'gelb').length;
  const gruen = myGeraete.filter(g => ampelStatus(g.naechste_pruefung) === 'gruen').length;

  const einwRot  = myEinweisungen.filter(e => ampelStatus(e.naechste_faelligkeit) === 'rot').length;
  const einwGelb = myEinweisungen.filter(e => ampelStatus(e.naechste_faelligkeit) === 'gelb').length;

  // PDF Export ‚Äî als Blob-URL in Modal (kein window.open das die App verl√§sst)
  const [pdfHtml, setPdfHtml] = useState(null);

  const exportPDF = () => {
    const wbName = wbId ? state.wohnbereiche.find(w => w.id === wbId)?.name : 'Alle Wohnbereiche';
    const datum = new Date().toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' });

    const rows = filteredGeraete.map(g => {
      const einwCount = myEinweisungen.filter(e => e.geraet_id === g.geraet_id).length;
      const multis    = myEinweisungen.filter(e => e.geraet_id === g.geraet_id && e.multiplikator === 'ja').length;
      const status    = ampelStatus(g.naechste_pruefung);
      const col       = status === 'rot' ? '#ef4444' : status === 'gelb' ? '#eab308' : '#22c55e';
      return '<tr><td>' + g.geraet_id + '</td><td><strong>' + g.name + '</strong><br/><small>' + g.hersteller + ' ' + g.modell + '</small></td><td>' + g.kategorie + '</td><td>' + (g.standort_name || g.standort_wbid) + '</td><td style="text-align:center"><span style="background:' + (g.risikoklasse==='IIb'||g.risikoklasse==='III'?'#ef444420':'#3b82f620') + ';color:' + (g.risikoklasse==='IIb'||g.risikoklasse==='III'?'#ef4444':'#3b82f6') + ';padding:2px 7px;border-radius:4px;font-size:11px">' + g.risikoklasse + '</span></td><td>' + g.pruefzustaendig + '</td><td style="color:' + col + ';font-weight:600">' + ampelLabel(g.naechste_pruefung) + '</td><td style="text-align:center">' + einwCount + ' (' + multis + ' Mult.)</td></tr>';
    }).join('');

    setPdfHtml(`<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"/>
    <style>
      body { font-family: Arial, sans-serif; font-size: 12px; color: #1a1a2e; margin: 24px; }
      h1 { font-size: 16px; margin-bottom: 4px; }
      .meta { color: #666; font-size: 11px; margin-bottom: 14px; }
      .hinweis { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px 12px; font-size: 11px; color: #856404; margin-bottom: 16px; }
      table { width: 100%; border-collapse: collapse; font-size: 11px; }
      th { background: #1a1d27; color: #fff; padding: 7px 9px; text-align: left; }
      td { padding: 6px 9px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
      tr:nth-child(even) td { background: #f9fafb; }
      .footer { margin-top: 24px; font-size: 10px; color: #999; border-top: 1px solid #e5e7eb; padding-top: 8px; }
    </style></head><body>
    <h1>üîß Medizinprodukte ‚Äì Pr√ºf- & Einweisungsnachweis</h1>
    <div class="meta">${wbName} &nbsp;|&nbsp; ${datum} &nbsp;|&nbsp; ${filteredGeraete.length} Ger√§te</div>
    <div class="hinweis">‚ö† <strong>Demo-Ansicht</strong> ‚Äî F√ºr den rechtsverbindlichen Einsatz ist eine serverseitige Datensicherung erforderlich.</div>
    <table><thead><tr><th>ID</th><th>Ger√§t</th><th>Kategorie</th><th>Standort</th><th>Klasse</th><th>Pr√ºfzust√§ndig</th><th>N√§chste Pr√ºfung</th><th>Einweisungen</th></tr></thead>
    <tbody>${rows}</tbody></table>
    <div class="footer">PDL Cockpit ¬∑ MPBetreibV ¬∑ ${datum}</div>
    </body></html>`);
  };

  return (
    <div>
      {/* PDF Vorschau Modal */}
      {pdfHtml && (
        <div style={{ position:"fixed", inset:0, background:"#000a", zIndex:1000, display:"flex", flexDirection:"column" }}>
          <div style={{ background:D.surface, padding:"12px 16px", display:"flex", justifyContent:"space-between", alignItems:"center", borderBottom:`1px solid ${D.border}` }}>
            <div style={{ fontSize:14, fontWeight:700, color:D.text }}>üìÑ PDF Vorschau</div>
            <div style={{ display:"flex", gap:8 }}>
              <Btn onClick={() => {
                const blob = new Blob([pdfHtml], {type:'text/html'});
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href = url; a.download = 'medizinprodukte.html'; a.click();
                URL.revokeObjectURL(url);
              }} style={{ fontSize:11 }}>‚¨á Herunterladen</Btn>
              <Btn variant="secondary" onClick={() => setPdfHtml(null)} style={{ fontSize:11 }}>‚úï Schlie√üen</Btn>
            </div>
          </div>
          <iframe srcDoc={pdfHtml} style={{ flex:1, border:"none", background:"#fff" }} title="PDF Vorschau" />
        </div>
      )}

      {/* Demo-Banner */}
      <div style={{ background:"#85490822", border:`1px solid ${D.yellow}40`, borderRadius:8, padding:"10px 14px", marginBottom:18, display:"flex", gap:10, alignItems:"flex-start" }}>
        <span style={{ fontSize:16, flexShrink:0 }}>‚ö†</span>
        <div>
          <div style={{ fontSize:12, fontWeight:700, color:D.yellow }}>Demo-Ansicht ‚Äî MPBetreibV Modul</div>
          <div style={{ fontSize:11, color:D.muted, marginTop:2 }}>Dieses Modul zeigt den geplanten Funktionsumfang. F√ºr den produktiven Einsatz ist eine serverseitige Datensicherung erforderlich. Daten werden aktuell nur f√ºr diese Sitzung gespeichert.</div>
        </div>
      </div>

      {/* Header */}
      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:20 }}>
        <div>
          <div style={{ fontSize:18, fontWeight:700, color:D.text, ...sora }}>Medizinprodukte</div>
          <div style={{ fontSize:11, color:D.muted, marginTop:2 }}>MPBetreibV ¬∑ Ger√§teregister ¬∑ Einweisungsnachweis</div>
        </div>
        <div style={{ display:"flex", gap:8 }}>
          {geraete.length > 0 && <Btn onClick={exportPDF} style={{ fontSize:11 }}>üìÑ PDF Export</Btn>}
        </div>
      </div>

      {/* Import Bereich wenn noch keine Daten */}
      {geraete.length === 0 && (
        <div style={{ ...surfaceStyle({ padding:"30px 24px", textAlign:"center", marginBottom:20 }) }}>
          <div style={{ fontSize:36, marginBottom:12 }}>üîß</div>
          <div style={{ fontSize:14, fontWeight:600, color:D.text, marginBottom:6 }}>Ger√§teregister importieren</div>
          <div style={{ fontSize:12, color:D.muted, marginBottom:20 }}>Lade die geraete.csv und einweisungen.csv hoch um zu starten</div>
          <div style={{ display:"flex", gap:12, justifyContent:"center", flexWrap:"wrap" }}>
            <label style={{ cursor:"pointer" }}>
              <input type="file" accept=".csv" onChange={importGeraete} style={{ display:"none" }} />
              <div style={{ background:D.blue+"20", border:`1px solid ${D.blue}`, borderRadius:8, padding:"10px 18px", color:D.blue, fontSize:12, fontWeight:600 }}>üìã geraete.csv importieren</div>
            </label>
            <label style={{ cursor:"pointer" }}>
              <input type="file" accept=".csv" onChange={importEinweisungen} style={{ display:"none" }} />
              <div style={{ background:D.green+"20", border:`1px solid ${D.green}`, borderRadius:8, padding:"10px 18px", color:D.green, fontSize:12, fontWeight:600 }}>üë§ einweisungen.csv importieren</div>
            </label>
          </div>
        </div>
      )}

      {geraete.length > 0 && (
        <>
          {/* Ampel-Statistik */}
          <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:10, marginBottom:18 }}>
            {[
              { label:"Pr√ºfung √ºberf√§llig",  count:rot,   color:D.red,   icon:"üî¥" },
              { label:"Bald f√§llig (60 Tage)",count:gelb, color:D.yellow, icon:"üü°" },
              { label:"Pr√ºfung aktuell",      count:gruen, color:D.green,  icon:"üü¢" },
            ].map(s => (
              <div key={s.label} onClick={() => setFilterAmpel(filterAmpel === s.color.replace('#','') ? 'alle' : s.label === 'Pr√ºfung √ºberf√§llig' ? 'rot' : s.label.includes('Bald') ? 'gelb' : 'gruen')}
                style={{ ...surfaceStyle({ padding:"14px 16px", borderLeft:`3px solid ${s.color}`, cursor:"pointer" }) }}>
                <div style={{ fontSize:22, fontWeight:700, color:s.color }}>{s.count}</div>
                <div style={{ fontSize:11, color:D.muted, marginTop:2 }}>{s.label}</div>
              </div>
            ))}
          </div>

          {/* Tabs */}
          <div style={{ display:"flex", gap:0, borderBottom:`1px solid ${D.border}`, marginBottom:16 }}>
            {[["geraete","Ger√§teregister"],["einweisungen","Einweisungen"],["matrix","Matrix"],["bewohner","Bewohnerger√§te"]].map(([k,l]) => (
              <button key={k} onClick={() => setSubTab(k)}
                style={{ padding:"9px 18px", fontSize:13, fontWeight:600, cursor:"pointer", border:"none", borderBottom:`2px solid ${subTab===k?D.blue:"transparent"}`, color:subTab===k?D.blue:D.muted, background:"transparent", marginBottom:-1, fontFamily:"inherit" }}>{l}</button>
            ))}
            <div style={{ flex:1 }} />
            {/* Import Buttons wenn Daten vorhanden */}
            <label style={{ cursor:"pointer", display:"flex", alignItems:"center" }}>
              <input type="file" accept=".csv" onChange={importGeraete} style={{ display:"none" }} />
              <span style={{ fontSize:10, color:D.muted, padding:"4px 8px", border:`1px solid ${D.border}`, borderRadius:6, marginRight:6 }}>üìã Ger√§te</span>
            </label>
            <label style={{ cursor:"pointer", display:"flex", alignItems:"center" }}>
              <input type="file" accept=".csv" onChange={importEinweisungen} style={{ display:"none" }} />
              <span style={{ fontSize:10, color:D.muted, padding:"4px 8px", border:`1px solid ${D.border}`, borderRadius:6 }}>üë§ Einweisungen</span>
            </label>
          </div>

          {/* Filter */}
          <div style={{ display:"flex", gap:6, flexWrap:"wrap", marginBottom:14 }}>
            {isPDL && wohnbereiche.map(wb => {
              const wbObj = state.wohnbereiche.find(w => w.id === wb);
              return (
                <button key={wb} onClick={() => setFilterWb(filterWb === wb ? 'alle' : wb)}
                  style={{ padding:"4px 10px", fontSize:11, borderRadius:6, border:`1px solid ${filterWb===wb?(wbObj?.color||D.blue):D.border}`, background:filterWb===wb?(wbObj?.color||D.blue)+"20":"transparent", color:filterWb===wb?(wbObj?.color||D.blue):D.muted, cursor:"pointer", fontFamily:"inherit", fontWeight:600 }}>
                  {wbObj?.name || wb}
                </button>
              );
            })}
            {kategorien.map(k => (
              <button key={k} onClick={() => setFilterKat(filterKat === k ? 'alle' : k)}
                style={{ padding:"4px 10px", fontSize:11, borderRadius:6, border:`1px solid ${filterKat===k?D.blue:D.border}`, background:filterKat===k?D.blue+"20":"transparent", color:filterKat===k?D.blue:D.muted, cursor:"pointer", fontFamily:"inherit" }}>
                {k}
              </button>
            ))}
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Suche‚Ä¶"
              style={{ padding:"4px 10px", fontSize:11, borderRadius:6, border:`1px solid ${D.border}`, background:D.surface2, color:D.text, fontFamily:"inherit", width:120 }} />
          </div>

          {/* Ger√§teregister Tab */}
          {subTab === "geraete" && (
            <div>
              {filteredGeraete.length === 0
                ? <div style={{ textAlign:"center", padding:"40px 0", color:D.muted }}>Keine Ger√§te gefunden</div>
                : filteredGeraete.map(g => {
                  const status = ampelStatus(g.naechste_pruefung);
                  const col    = ampelColor(status);
                  const einwCount = myEinweisungen.filter(e => e.geraet_id === g.geraet_id).length;
                  const multis    = myEinweisungen.filter(e => e.geraet_id === g.geraet_id && e.multiplikator === 'ja').length;
                  const isSelected = selectedGeraet?.geraet_id === g.geraet_id;
                  return (
                    <div key={g.geraet_id}>
                      <div onClick={() => setSelectedGeraet(isSelected ? null : g)}
                        style={{ ...surfaceStyle({ padding:"11px 14px", marginBottom:isSelected?0:6, cursor:"pointer", borderLeft:`3px solid ${col}`, borderBottomLeftRadius:isSelected?0:10, borderBottomRightRadius:isSelected?0:10 }) }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", gap:10 }}>
                          <div style={{ flex:1, minWidth:0 }}>
                            <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
                              <span style={{ fontSize:13, fontWeight:600, color:D.text }}>{g.name}</span>
                              <Tag color={g.risikoklasse==='IIb'||g.risikoklasse==='III'?D.red:D.blue} small>{g.risikoklasse}</Tag>
                              <Tag color={D.muted} small>{g.kategorie}</Tag>
                            </div>
                            <div style={{ fontSize:10, color:D.muted, marginTop:3, ...mono }}>
                              {g.hersteller} {g.modell} ¬∑ {g.standort_name||g.standort_wbid} ¬∑ Pr√ºfung: {g.pruefzustaendig}
                            </div>
                          </div>
                          <div style={{ display:"flex", gap:8, alignItems:"center", flexShrink:0 }}>
                            {einwCount > 0 && <span style={{ fontSize:10, color:D.muted, ...mono }}>üë§ {einwCount} ({multis} Mult.)</span>}
                            <span style={{ fontSize:11, fontWeight:600, color:col }}>{ampelLabel(g.naechste_pruefung)}</span>
                            <span style={{ fontSize:12, color:D.muted }}>{isSelected?'‚ñ≤':'‚ñº'}</span>
                          </div>
                        </div>
                      </div>
                      {/* Aufgeklappt: Einweisungen */}
                      {isSelected && (
                        <div style={{ background:D.surface2, border:`1px solid ${D.border}`, borderTop:"none", borderRadius:"0 0 10px 10px", padding:"12px 14px", marginBottom:6 }}>
                          <div style={{ fontSize:11, fontWeight:700, color:D.muted, ...mono, marginBottom:10, textTransform:"uppercase", letterSpacing:1 }}>Eingewiesene Mitarbeiter</div>
                          {geraetEinweisungen.length === 0
                            ? <div style={{ fontSize:12, color:D.muted }}>Keine Einweisungen hinterlegt</div>
                            : geraetEinweisungen.map((e,i) => {
                              const es = ampelStatus(e.naechste_faelligkeit);
                              const ec = ampelColor(es);
                              return (
                                <div key={i} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"6px 0", borderBottom:`1px solid ${D.border}10`, gap:10 }}>
                                  <div style={{ display:"flex", gap:8, alignItems:"center", flex:1 }}>
                                    <span style={{ fontSize:13 }}>{e.multiplikator==='ja'?'‚≠ê':'üë§'}</span>
                                    <div>
                                      <div style={{ fontSize:12, fontWeight:600, color:D.text }}>{e.mitarbeiter_name}</div>
                                      <div style={{ fontSize:10, color:D.muted, ...mono }}>Eingewiesen: {fmtDate(e.datum)} ¬∑ durch {e.einweiser_name} ({e.einweiser_typ})</div>
                                    </div>
                                  </div>
                                  <div style={{ textAlign:"right", flexShrink:0 }}>
                                    {e.multiplikator==='ja' && <Tag color={D.yellow} small>Multiplikator</Tag>}
                                    <div style={{ fontSize:11, color:ec, fontWeight:600, marginTop:3 }}>{ampelLabel(e.naechste_faelligkeit)}</div>
                                  </div>
                                </div>
                              );
                            })
                          }
                        </div>
                      )}
                    </div>
                  );
                })
              }
            </div>
          )}

          {/* Einweisungen Tab */}
          {subTab === "einweisungen" && (
            <div>
              {/* √úberf√§llige zuerst */}
              {['rot','gelb','gruen'].map(ampel => {
                const items = myEinweisungen.filter(e => {
                  const s = ampelStatus(e.naechste_faelligkeit);
                  if (s !== ampel) return false;
                  if (filterWb !== 'alle' && e.standort_wbid !== filterWb) return false;
                  return true;
                });
                if (items.length === 0) return null;
                const col = ampelColor(ampel);
                const label = ampel==='rot'?'√úberf√§llig':ampel==='gelb'?'Bald f√§llig':'Aktuell';
                return (
                  <div key={ampel} style={{ marginBottom:16 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:col, letterSpacing:1, textTransform:"uppercase", ...mono, marginBottom:8, paddingBottom:5, borderBottom:`1px solid ${D.border}` }}>
                      {label} ‚Äî {items.length} Einweisungen
                    </div>
                    {items.slice(0,20).map((e,i) => (
                      <div key={i} style={{ ...surfaceStyle({ padding:"9px 12px", marginBottom:4, borderLeft:`3px solid ${col}` }) }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", gap:10 }}>
                          <div style={{ flex:1, minWidth:0 }}>
                            <div style={{ fontSize:12, fontWeight:600, color:D.text }}>{e.mitarbeiter_name} ¬∑ <span style={{ color:D.muted, fontWeight:400 }}>{e.geraet_name}</span></div>
                            <div style={{ fontSize:10, color:D.muted, marginTop:2, ...mono }}>
                              {e.standort_name} ¬∑ Eingewiesen {fmtDate(e.datum)} ¬∑ {e.einweiser_typ}
                            </div>
                          </div>
                          <div style={{ flexShrink:0, textAlign:"right" }}>
                            {e.multiplikator==='ja' && <Tag color={D.yellow} small>‚≠ê Multiplikator</Tag>}
                            <div style={{ fontSize:11, color:col, fontWeight:600, marginTop:2 }}>{ampelLabel(e.naechste_faelligkeit)}</div>
                          </div>
                        </div>
                      </div>
                    ))}
                    {items.length > 20 && <div style={{ fontSize:11, color:D.muted, textAlign:"center", marginTop:6, ...mono }}>+{items.length-20} weitere</div>}
                  </div>
                );
              })}
            </div>
          )}

          {/* Matrix Tab */}
          {subTab === "matrix" && (() => {
            const wbFilter = filterWb !== 'alle' ? filterWb : (wbId || null);
            const geraeteForMatrix = wbFilter ? myGeraete.filter(g => g.standort_wbid === wbFilter) : myGeraete.slice(0,20);
            const maNames = [...new Set(myEinweisungen.filter(e => !wbFilter || e.standort_wbid === wbFilter).map(e => e.mitarbeiter_name))].sort();

            return (
              <div style={{ overflowX:"auto" }}>
                <div style={{ fontSize:11, color:D.muted, marginBottom:10, ...mono }}>
                  ‚≠ê = Multiplikator &nbsp;¬∑&nbsp; üü¢ = Aktuell &nbsp;¬∑&nbsp; üü° = Bald f√§llig &nbsp;¬∑&nbsp; üî¥ = √úberf√§llig &nbsp;¬∑&nbsp; ‚Äì = Nicht eingewiesen
                </div>
                <table style={{ borderCollapse:"collapse", fontSize:11, width:"100%" }}>
                  <thead>
                    <tr>
                      <th style={{ textAlign:"left", padding:"6px 8px", background:D.surface2, color:D.muted, fontWeight:600, position:"sticky", left:0, zIndex:1 }}>Ger√§t</th>
                      {maNames.map(ma => (
                        <th key={ma} style={{ padding:"6px 8px", background:D.surface2, color:D.muted, fontWeight:600, textAlign:"center", whiteSpace:"nowrap", fontSize:10 }}>
                          {ma.split(' ')[0]}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {geraeteForMatrix.slice(0,30).map(g => (
                      <tr key={g.geraet_id}>
                        <td style={{ padding:"5px 8px", borderBottom:`1px solid ${D.border}`, background:D.surface, position:"sticky", left:0, fontWeight:600, fontSize:11, color:D.text, whiteSpace:"nowrap" }}>
                          {g.name}<br/><span style={{ color:D.muted, fontWeight:400 }}>{g.standort_name||g.standort_wbid}</span>
                        </td>
                        {maNames.map(ma => {
                          const einw = myEinweisungen.find(e => e.geraet_id === g.geraet_id && e.mitarbeiter_name === ma);
                          if (!einw) return <td key={ma} style={{ textAlign:"center", padding:"5px 6px", borderBottom:`1px solid ${D.border}`, color:D.border }}>‚Äì</td>;
                          const s = ampelStatus(einw.naechste_faelligkeit);
                          const emoji = s==='rot'?'üî¥':s==='gelb'?'üü°':'üü¢';
                          return (
                            <td key={ma} style={{ textAlign:"center", padding:"5px 6px", borderBottom:`1px solid ${D.border}` }}>
                              {einw.multiplikator==='ja' ? '‚≠ê' : emoji}
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
                {geraeteForMatrix.length > 30 && <div style={{ fontSize:11, color:D.muted, textAlign:"center", marginTop:8, ...mono }}>F√ºr vollst√§ndige Matrix bitte WB-Filter setzen</div>}
              </div>
            );
          })()}

          {/* ‚îÄ‚îÄ Bewohnerger√§te Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          {subTab === "bewohner" && (
            <div>
              {/* Demo + Neu Buttons */}
              <div style={{ display:"flex", gap:8, marginBottom:16, flexWrap:"wrap" }}>
                <Btn onClick={() => setShowNeu(true)}>Ôºã Ger√§t anlegen</Btn>
                {bewohnerGeraete.length === 0 && (
                  <Btn variant="secondary" onClick={() => setBewohnerGeraete(bewohnerGeraeteDemoData())}
                    style={{ borderColor:D.yellow+"60", color:D.yellow }}>
                    üé≠ Demodaten laden
                  </Btn>
                )}
                {bewohnerGeraete.length > 0 && (
                  <span style={{ fontSize:11, color:D.muted, alignSelf:"center", ...mono }}>
                    {bewohnerGeraete.length} Ger√§te ¬∑ {bewohnerGeraete.filter(g=>ampelStatus(g.naechsteFaelligkeit)==='rot').length} √ºberf√§llig
                  </span>
                )}
              </div>

              {bewohnerGeraete.length === 0 ? (
                <div style={{ ...surfaceStyle({ padding:"40px 24px", textAlign:"center" }) }}>
                  <div style={{ fontSize:36, marginBottom:12 }}>üë§</div>
                  <div style={{ fontSize:14, fontWeight:600, color:D.text, marginBottom:6 }}>Keine Bewohnerger√§te erfasst</div>
                  <div style={{ fontSize:12, color:D.muted }}>Lege Ger√§te manuell an oder lade Demodaten f√ºr die Pr√§sentation.</div>
                </div>
              ) : (
                (() => {
                  // Gruppiere nach Bewohner
                  const myBG = wbId ? bewohnerGeraete.filter(g => g.wbId === wbId) : bewohnerGeraete;
                  // Nach Ampel-Dringlichkeit sortieren
                  const sorted = [...myBG].sort((a,b) => {
                    const order = { rot:0, gelb:1, grau:2, gruen:3 };
                    return (order[ampelStatus(a.naechsteFaelligkeit)]||2) - (order[ampelStatus(b.naechsteFaelligkeit)]||2);
                  });
                  // Gruppiere nach Bewohner
                  const byBewohner = {};
                  sorted.forEach(g => {
                    const key = g.bewohnerName + '|' + g.wbId;
                    if (!byBewohner[key]) byBewohner[key] = { name:g.bewohnerName, zimmer:g.zimmer, wbName:g.wbName, geraete:[] };
                    byBewohner[key].geraete.push(g);
                  });

                  return Object.entries(byBewohner).map(([key, bw]) => {
                    const worstStatus = bw.geraete.reduce((worst, g) => {
                      const order = { rot:0, gelb:1, grau:2, gruen:3 };
                      const s = ampelStatus(g.naechsteFaelligkeit);
                      return (order[s]||2) < (order[worst]||2) ? s : worst;
                    }, 'gruen');
                    const col = ampelColor(worstStatus);

                    return (
                      <div key={key} style={{ ...surfaceStyle({ marginBottom:10, borderLeft:`3px solid ${col}` }) }}>
                        {/* Bewohner-Header */}
                        <div style={{ padding:"11px 14px 8px", display:"flex", justifyContent:"space-between", alignItems:"center", borderBottom:`1px solid ${D.border}` }}>
                          <div>
                            <span style={{ fontSize:13, fontWeight:700, color:D.text }}>üë§ {bw.name}</span>
                            <span style={{ fontSize:11, color:D.muted, marginLeft:10, ...mono }}>
                              {bw.zimmer ? `Zi. ${bw.zimmer} ¬∑ ` : ''}{bw.wbName}
                            </span>
                          </div>
                          <Tag color={col} small>{bw.geraete.length} Ger√§t{bw.geraete.length!==1?'e':''}</Tag>
                        </div>

                        {/* Ger√§te des Bewohners */}
                        {bw.geraete.map((g,i) => {
                          const s  = ampelStatus(g.naechsteFaelligkeit);
                          const gc = ampelColor(s);
                          return (
                            <div key={g.id} style={{ padding:"10px 14px", borderBottom: i < bw.geraete.length-1 ? `1px solid ${D.border}20` : "none" }}>
                              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", gap:10 }}>
                                <div style={{ flex:1, minWidth:0 }}>
                                  <div style={{ display:"flex", gap:8, alignItems:"center", flexWrap:"wrap" }}>
                                    <span style={{ fontSize:12, fontWeight:600, color:D.text }}>üîß {g.geraet}</span>
                                    <Tag color={D.blue} small>{g.kategorie}</Tag>
                                  </div>
                                  <div style={{ fontSize:10, color:D.muted, marginTop:4, ...mono, lineHeight:1.6 }}>
                                    üè™ {g.sanitaetshaus}<br/>
                                    üìÖ Ersteinweisung: {fmtDate(g.ersteinweisungDatum)} ¬∑ {g.ersteinweiserName}<br/>
                                    {g.multiplikatorName && <span>‚≠ê Multiplikator: {g.multiplikatorName}<br/></span>}
                                    {g.belegort && <span>üìÅ Beleg: {g.belegort}<br/></span>}
                                    {g.bemerkung && <span style={{ color:D.yellow }}>üí¨ {g.bemerkung}</span>}
                                  </div>
                                </div>
                                <div style={{ flexShrink:0, textAlign:"right" }}>
                                  <div style={{ fontSize:11, fontWeight:700, color:gc }}>{ampelLabel(g.naechsteFaelligkeit)}</div>
                                  <div style={{ fontSize:10, color:D.muted, marginTop:2 }}>Wiederholung f√§llig</div>
                                  <div style={{ display:"flex", gap:4, marginTop:6, justifyContent:"flex-end" }}>
                                    <Btn variant="ghost" style={{ fontSize:10, padding:"3px 7px", color:D.muted, border:`1px solid ${D.border}` }}
                                      onClick={() => setEditItem(g)}>‚úè</Btn>
                                    <Btn variant="ghost" style={{ fontSize:10, padding:"3px 7px", color:D.red, border:`1px solid ${D.border}` }}
                                      onClick={() => setDeleteConfirm(g.id)}>‚úï</Btn>
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    );
                  });
                })()
              )}

              {/* Neu-Modal */}
              {showNeu && <NeuBewohnerGeraetModal state={state} wbId={wbId}
                onSave={g => { setBewohnerGeraete(p => [g,...p]); setShowNeu(false); }}
                onClose={() => setShowNeu(false)} />}

              {/* Edit-Modal */}
              {editItem && (
                <Modal title="Ger√§t bearbeiten" onClose={() => setEditItem(null)}>
                  <Lbl>N√§chste Wiederholung f√§llig</Lbl>
                  <Inp type="date" value={editItem.naechsteFaelligkeit}
                    onChange={e => setEditItem(p => ({...p, naechsteFaelligkeit:e.target.value}))} />
                  <Lbl>Belegort</Lbl>
                  <Inp value={editItem.belegort} onChange={e => setEditItem(p => ({...p, belegort:e.target.value}))} />
                  <Lbl>Bemerkung</Lbl>
                  <Inp value={editItem.bemerkung} onChange={e => setEditItem(p => ({...p, bemerkung:e.target.value}))} />
                  <div style={{ marginTop:16, display:"flex", gap:8, justifyContent:"flex-end" }}>
                    <Btn variant="secondary" onClick={() => setEditItem(null)}>Abbrechen</Btn>
                    <Btn onClick={() => {
                      setBewohnerGeraete(p => p.map(g => g.id === editItem.id ? editItem : g));
                      setEditItem(null);
                    }}>Speichern</Btn>
                  </div>
                </Modal>
              )}

              {/* L√∂schen-Best√§tigung */}
              {deleteConfirm && (
                <Modal title="Ger√§t l√∂schen?" onClose={() => setDeleteConfirm(null)}>
                  <div style={{ fontSize:13, color:D.muted, marginBottom:16 }}>Dieser Eintrag wird unwiderruflich gel√∂scht.</div>
                  <div style={{ display:"flex", gap:8, justifyContent:"flex-end" }}>
                    <Btn variant="secondary" onClick={() => setDeleteConfirm(null)}>Abbrechen</Btn>
                    <Btn style={{ background:D.red+"20", color:D.red, borderColor:D.red+"40" }}
                      onClick={() => { setBewohnerGeraete(p => p.filter(g => g.id !== deleteConfirm)); setDeleteConfirm(null); }}>
                      L√∂schen
                    </Btn>
                  </div>
                </Modal>
              )}
            </div>
          )}
        </>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ DELEGATION (PDL only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DelegForm({ state, mitarbeiter, delegations, now, onUpdate, onClose }) {
  const [f, setF] = useState({ id: uid(), title: "", assignee: "", due: addDays(now, 3), priority: "normal", notes: "", status: "offen" });
  return (
    <Modal title="Aufgabe delegieren" onClose={onClose}>
      <Lbl>Aufgabe *</Lbl><Inp value={f.title} onChange={e=>setF(p=>({...p,title:e.target.value}))} placeholder="Was soll erledigt werden?" />
      <Lbl>An wen *</Lbl>
      {mitarbeiter.length>0
        ? <Sel value={f.assignee} onChange={e=>setF(p=>({...p,assignee:e.target.value}))}><option value="">‚Äì Person ‚Äì</option>{mitarbeiter.map(m=><option key={m.id} value={m.name}>{m.name}</option>)}</Sel>
        : <Inp value={f.assignee} onChange={e=>setF(p=>({...p,assignee:e.target.value}))} placeholder="Name‚Ä¶" />
      }
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
        <div><Lbl>Bis wann</Lbl><Inp type="date" value={f.due} onChange={e=>setF(p=>({...p,due:e.target.value}))}/></div>
        <div><Lbl>Priorit√§t</Lbl><Sel value={f.priority} onChange={e=>setF(p=>({...p,priority:e.target.value}))}>{Object.entries(PRIO).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</Sel></div>
      </div>
      <Lbl>Hinweise</Lbl>
      <textarea value={f.notes} onChange={e=>setF(p=>({...p,notes:e.target.value}))} placeholder="Kontext‚Ä¶"
        style={{width:"100%",background:D.surface2,border:`1px solid ${D.border}`,borderRadius:7,color:D.text,padding:"8px 11px",fontSize:13,boxSizing:"border-box",outline:"none",fontFamily:"inherit",marginBottom:14,height:60,resize:"vertical"}} />
      <div style={{display:"flex",gap:10}}>
        <Btn style={{flex:1}} onClick={()=>{if(f.title&&f.assignee){onUpdate({...state,delegations:[f,...delegations]});onClose();}}}>Delegieren</Btn>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
      </div>
    </Modal>
  );
}

function DelegationView({ state, onUpdate, role }) {
  const { delegations = [], mitarbeiter, wohnbereiche } = state;
  const [showForm, setShowForm] = useState(false);
  const now = todayStr();

  const open = delegations.filter(d=>d.status!=="erledigt");
  const done = delegations.filter(d=>d.status==="erledigt");

  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <div style={{fontSize:18,fontWeight:700,color:D.text,...sora}}>Delegation</div>
        <Btn onClick={()=>setShowForm(true)}>Ôºã Delegieren</Btn>
      </div>
      {delegations.length===0&&<div style={{textAlign:"center",padding:"60px 0",color:D.muted}}><div style={{fontSize:40}}>üë•</div><div style={{fontWeight:600,marginTop:8,color:D.text}}>Noch keine Delegationen</div></div>}
      {open.length>0&&<><SectionTitle>Offen ({open.length})</SectionTitle>{open.map(d=><DelegCard key={d.id} d={d}/>)}</>}
      {done.length>0&&<><SectionTitle>Erledigt ({done.length})</SectionTitle>{done.map(d=><DelegCard key={d.id} d={d}/>)}</>}
      {showForm&&<DelegForm state={state} mitarbeiter={mitarbeiter} delegations={delegations} now={now} onUpdate={onUpdate} onClose={()=>setShowForm(false)} />}
    </div>
  );

  function DelegCard({d}) {
    const isOv=d.due<now&&d.status!=="erledigt";
    const p=PRIO[d.priority]||PRIO.normal;
    return(
      <div style={{...surfaceStyle({padding:"13px 16px",marginBottom:7,borderLeft:`3px solid ${p.color}`})}}>
        <div style={{display:"flex",justifyContent:"space-between",gap:10}}>
          <div style={{flex:1}}>
            <div style={{fontSize:13,fontWeight:700,color:D.text}}>{d.title}</div>
            <div style={{display:"flex",gap:12,marginTop:4,fontSize:11,color:D.muted,flexWrap:"wrap",...mono}}>
              <span>üë§ {d.assignee}</span>
              <span style={{color:isOv?D.red:D.muted}}>üìÖ {fmtDate(d.due)}{isOv?" ‚ö†":""}</span>
              <Tag color={p.color} small>{p.label}</Tag>
            </div>
            {d.notes&&<div style={{fontSize:11,color:D.muted,marginTop:7,background:D.surface2,borderRadius:6,padding:"6px 10px"}}>{d.notes}</div>}
          </div>
          <div style={{display:"flex",flexDirection:"column",gap:5,flexShrink:0}}>
            <Sel style={{marginBottom:0,width:"auto",fontSize:11,padding:"4px 8px"}} value={d.status} onChange={e=>onUpdate({...state,delegations:delegations.map(x=>x.id===d.id?{...x,status:e.target.value}:x)})}>
              <option value="offen">Offen</option>
              <option value="in arbeit">In Arbeit</option>
              <option value="erwartet r√ºckmeldung">R√ºckmeldung</option>
              <option value="erledigt">Erledigt</option>
            </Sel>
            <Btn variant="ghost" style={{color:D.muted,fontSize:11}} onClick={()=>onUpdate({...state,delegations:delegations.filter(x=>x.id!==d.id)})}>l√∂schen</Btn>
          </div>
        </div>
      </div>
    );
  }
}


// ‚îÄ‚îÄ‚îÄ PROZESSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Neuaufnahme, Wiederaufnahme, Onboarding

const VERFUEGUNG_OPTS = ["Liegt vor", "Liegt nicht vor", "Wurde angefragt", "Nicht vorhanden"];

const NEUAUFNAHME_ITEMS = [
  // Phase 1 ‚Äì Vorbereitung
  { phase: "Vorbereitung", id: "na-01", text: "Pflegegrad liegt vor" },
  { phase: "Vorbereitung", id: "na-02", text: "Letzter Arztbericht liegt vor" },
  { phase: "Vorbereitung", id: "na-03", text: "Zimmer: Grundreinigung abgeschlossen" },
  { phase: "Vorbereitung", id: "na-04", text: "Zimmer: Renovierung abgeschlossen / gepr√ºft" },
  // Phase 2 ‚Äì Ankunftstag
  { phase: "Ankunftstag", id: "na-05", text: "Inaugenscheinnahme durchgef√ºhrt" },
  { phase: "Ankunftstag", id: "na-06", text: "Mitgegebene Berichte gepr√ºft" },
  { phase: "Ankunftstag", id: "na-07", text: "Mitgegebene Medikamente gepr√ºft und abgeglichen" },
  { phase: "Ankunftstag", id: "na-08", text: "Vitalzeichenkontrolle durchgef√ºhrt" },
  { phase: "Ankunftstag", id: "na-09", text: "Gewicht erfasst" },
  { phase: "Ankunftstag", id: "na-10", text: "K√∂rpergr√∂√üe erfasst" },
  { phase: "Ankunftstag", id: "na-11", text: "Schmerzprotokoll gestartet" },
  { phase: "Ankunftstag", id: "na-12", text: "Ern√§hrungsprotokoll gestartet (7 Tage)" },
  // Phase 3 ‚Äì Angeh√∂rige & Rechtliches
  { phase: "Angeh√∂rige & Rechtliches", id: "na-13", text: "Angeh√∂rige / Betreuer √ºber Aufnahme informiert" },
  { phase: "Angeh√∂rige & Rechtliches", id: "na-14", text: "Notfallkontakt dokumentiert" },
  // Phase 4 ‚Äì Medizinische Anbindung
  { phase: "Medizinische Anbindung", id: "na-15", text: "Hausarzt: Anmeldung erfolgt" },
  { phase: "Medizinische Anbindung", id: "na-16", text: "Hausarzt: Medikamentenplan √ºbermittelt" },
  { phase: "Medizinische Anbindung", id: "na-17", text: "Hausarzt: Krankenkassenkarte weitergeleitet" },
  { phase: "Medizinische Anbindung", id: "na-18", text: "Hausarzt: Rezepte angefordert (falls notwendig)" },
  { phase: "Medizinische Anbindung", id: "na-19", text: "Vertragsapotheke: Bewohner angemeldet" },
  // Optionale Versorger
  { phase: "Medizinische Anbindung", id: "na-20", text: "Versorger Harnableitung: angemeldet", optional: true },
  { phase: "Medizinische Anbindung", id: "na-21", text: "Versorger Diabetikerversorgung: angemeldet", optional: true },
  { phase: "Medizinische Anbindung", id: "na-22", text: "Versorger Sondenkost: angemeldet", optional: true },
  // Phase 5 ‚Äì Pflegeplanung
  { phase: "Pflegeplanung (SIS)", id: "na-23", text: "SIS Risikomatrix ausgef√ºllt" },
  { phase: "Pflegeplanung (SIS)", id: "na-24", text: "Ma√ünahmen zu allen Risiken angelegt" },
];

const WIEDERAUFNAHME_ITEMS = [
  // Phase 1 ‚Äì Ankunft
  { phase: "Ankunft", id: "wa-01", text: "Entlassungsbericht liegt vor" },
  { phase: "Ankunft", id: "wa-02", text: "Medikamente gepr√ºft und abgeglichen" },
  { phase: "Ankunft", id: "wa-03", text: "Vitalzeichenkontrolle durchgef√ºhrt" },
  { phase: "Ankunft", id: "wa-04", text: "Gewicht erfasst" },
  { phase: "Ankunft", id: "wa-05", text: "Inaugenscheinnahme durchgef√ºhrt" },
  { phase: "Ankunft", id: "wa-06", text: "Wunden / neue Versorgungsbedarfe dokumentiert" },
  // Phase 2 ‚Äì Medizinische Anbindung
  { phase: "Medizinische Anbindung", id: "wa-07", text: "Hausarzt: Wiederaufnahme gemeldet" },
  { phase: "Medizinische Anbindung", id: "wa-08", text: "Hausarzt: Entlassungsbericht √ºbermittelt" },
  { phase: "Medizinische Anbindung", id: "wa-09", text: "Hausarzt: R√ºckmeldung zur neuen Medikation angefordert" },
  { phase: "Medizinische Anbindung", id: "wa-10", text: "Neuer Medikamentenplan vom Hausarzt erhalten" },
  { phase: "Medizinische Anbindung", id: "wa-11", text: "Medikamentenplan an Apotheke weitergeleitet" },
  { phase: "Medizinische Anbindung", id: "wa-12", text: "Medikation umgestellt gem√§√ü Krankenhausbericht" },
  // Phase 3 ‚Äì Protokolle (mit Pflichtabfrage)
  { phase: "Protokolle", id: "wa-13", text: "Schmerzerfassung gestartet", requiresProtCheck: true },
  { phase: "Protokolle", id: "wa-14", text: "Ern√§hrungsprotokoll gestartet (7 Tage)", requiresProtCheck: true },
  { phase: "Protokolle", id: "wa-15", text: "Trinkprotokoll gestartet (7 Tage)", requiresProtCheck: true },
  { phase: "Protokolle", id: "wa-16", text: "Auswertung nach 7 Tagen ‚Äì Info an Hausarzt geplant", requiresProtCheck: true },
  // Phase 4 ‚Äì Pflegeplanung
  { phase: "Pflegeplanung aktualisieren", id: "wa-17", text: "Pflegeplanung auf neue Situation angepasst" },
  { phase: "Pflegeplanung aktualisieren", id: "wa-18", text: "Neue Risiken eingesch√§tzt" },
  { phase: "Pflegeplanung aktualisieren", id: "wa-19", text: "Ma√ünahmen aktualisiert" },
];

// Onboarding items per Qualifikation
const ONBOARDING_ITEMS = {
  gemeinsam: [
    { phase: "Vor dem ersten Arbeitstag", id: "ob-01", text: "Gesundheitszeugnis liegt vor" },
    { phase: "Vor dem ersten Arbeitstag", id: "ob-02", text: "Impfnachweise gepr√ºft (Masern, Hepatitis B)" },
    { phase: "Vor dem ersten Arbeitstag", id: "ob-03", text: "Zug√§nge DAN eingerichtet" },
    { phase: "Vor dem ersten Arbeitstag", id: "ob-04", text: "Geb√§udezugang eingerichtet" },
    { phase: "Vor dem ersten Arbeitstag", id: "ob-05", text: "Einarbeitungsplan erstellt" },
    { phase: "Vor dem ersten Arbeitstag", id: "ob-06", text: "Einarbeitungsperson festgelegt" },
    { phase: "Erster Arbeitstag", id: "ob-07", text: "Einweisung Brandschutz durchgef√ºhrt" },
    { phase: "Erster Arbeitstag", id: "ob-08", text: "Einweisung Hausordnung durchgef√ºhrt" },
    { phase: "Erster Arbeitstag", id: "ob-09", text: "Einweisung Hygieneplan durchgef√ºhrt" },
    { phase: "Erster Arbeitstag", id: "ob-10", text: "Schl√ºssel / Chipkarte ausgeh√§ndigt" },
    { phase: "Erster Arbeitstag", id: "ob-11", text: "Dienstkleidung ausgeh√§ndigt" },
    { phase: "Erster Arbeitstag", id: "ob-12", text: "Vorstellung im Team erfolgt" },
  ],
  pflegefachkraft: [
    { phase: "Fachliche Einarbeitung", id: "ob-pk-01", text: "Vollst√§ndige Einarbeitung DAN (Dokumentationssystem)" },
    { phase: "Fachliche Einarbeitung", id: "ob-pk-02", text: "Mail- und Faxsystem erkl√§rt" },
    { phase: "Fachliche Einarbeitung", id: "ob-pk-03", text: "Einweisung Medikamentengabe durchgef√ºhrt" },
    { phase: "Fachliche Einarbeitung", id: "ob-pk-04", text: "Einweisung Notfallsituationen durchgef√ºhrt" },
  ],
  pflegefachassistent: [
    { phase: "Fachliche Einarbeitung", id: "ob-pa-01", text: "Einarbeitung DAN (Grundfunktionen)" },
    { phase: "Fachliche Einarbeitung", id: "ob-pa-02", text: "Delegation Behandlungspflege erteilt und dokumentiert" },
    { phase: "Fachliche Einarbeitung", id: "ob-pa-03", text: "Einweisung Notfallsituationen durchgef√ºhrt" },
    { phase: "Fachliche Einarbeitung", id: "ob-pa-04", text: "Grundpflegerische Einarbeitung (teilweise)" },
  ],
  pflegehilfskraft: [
    { phase: "Fachliche Einarbeitung", id: "ob-hk-01", text: "Schwerpunkt grundpflegerische Einarbeitung abgeschlossen" },
    { phase: "Fachliche Einarbeitung", id: "ob-hk-02", text: "DAN: Dokumentation Grundpflege (minimal)" },
    { phase: "Fachliche Einarbeitung", id: "ob-hk-03", text: "Einweisung Notfallsituationen durchgef√ºhrt" },
  ],
  praktikant: [
    { phase: "Fachliche Einarbeitung", id: "ob-pr-01", text: "Grundpflegerische Begleitung eingewiesen" },
    { phase: "Fachliche Einarbeitung", id: "ob-pr-02", text: "Hinweise zur Schweigepflicht erteilt" },
  ],
};

const QUALIFIKATION_LABELS = {
  pflegefachkraft: "Pflegefachkraft",
  pflegefachassistent: "Pflegefachassistent",
  pflegehilfskraft: "Pflegehilfskraft",
  praktikant: "Praktikant/in",
};

const QUALIFIKATION_COLORS = {
  pflegefachkraft: "#3b82f6",
  pflegefachassistent: "#22c55e",
  pflegehilfskraft: "#f59e0b",
  praktikant: "#a855f7",
};

// ‚îÄ‚îÄ Prozess-Detail Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ProzessDetailModal({ prozess, state, onUpdate, onClose, role }) {
  const [p, setP] = useState(prozess);
  const [newNotiz, setNewNotiz] = useState("");
  const isPDL = role === ROLE_PDL;

  const save = (updated) => {
    setP(updated);
    const all = (state.prozesse || []).map(x => x.id === updated.id ? updated : x);
    onUpdate({ ...state, prozesse: all });
  };

  const addNotiz = () => {
    const text = newNotiz.trim();
    if (!text) return;
    const eintrag = {
      id: uid(),
      text,
      autor: role,
      autorLabel: role === ROLE_PDL ? "PDL" : `WBL ¬∑ ${p.wbName || ""}`,
      ts: new Date().toISOString(),
    };
    const notizLog = [...(p.notizLog || []), eintrag];
    // Altes notizen-Feld migrieren falls vorhanden
    save({ ...p, notizLog, notizen: "" });
    setNewNotiz("");
  };

  const deleteNotiz = (id) => {
    if (!isPDL) return;
    const notizLog = (p.notizLog || []).filter(n => n.id !== id);
    save({ ...p, notizLog });
  };

  const setCheck = (itemId, val) => {
    const checks = { ...(p.checks || {}), [itemId]: val };
    save({ ...p, checks });
  };

  const setVerfuegung = (key, val) => {
    const verfuegungen = { ...(p.verfuegungen || {}), [key]: val };
    save({ ...p, verfuegungen });
  };

  const toggleOptional = (itemId) => {
    const aktiveOptional = { ...(p.aktiveOptional || {}) };
    aktiveOptional[itemId] = !aktiveOptional[itemId];
    save({ ...p, aktiveOptional });
  };

  // Get items based on type
  let items = [];
  if (p.typ === "neuaufnahme") items = NEUAUFNAHME_ITEMS;
  if (p.typ === "wiederaufnahme") items = WIEDERAUFNAHME_ITEMS;
  if (p.typ === "onboarding") {
    items = [
      ...ONBOARDING_ITEMS.gemeinsam,
      ...(ONBOARDING_ITEMS[p.qualifikation] || []),
    ];
  }

  // Filter out optionals that are not activated
  const visibleItems = items.filter(item => {
    if (!item.optional) return true;
    return !!(p.aktiveOptional || {})[item.id];
  });

  const optionalItems = items.filter(i => i.optional);
  const phases = [...new Set(visibleItems.map(i => i.phase))];
  const done = visibleItems.filter(i => (p.checks || {})[i.id] === true).length;
  const pct = visibleItems.length ? Math.round(done / visibleItems.length * 100) : 0;

  // Protokoll check for Wiederaufnahme
  const protItems = items.filter(i => i.requiresProtCheck);
  const protAnswered = p.typ === "wiederaufnahme" ? p.protokolleBeantwortet === true : true;

  const typLabel = p.typ === "neuaufnahme" ? "Neuaufnahme" : p.typ === "wiederaufnahme" ? "Wiederaufnahme" : "Onboarding";
  const typColor = p.typ === "neuaufnahme" ? D.blue : p.typ === "wiederaufnahme" ? D.orange : D.green;

  return (
    <Modal title={p.titel || typLabel} onClose={onClose} wide>
      {/* Header info */}
      <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 14 }}>
        <Tag color={typColor}>{typLabel}</Tag>
        {p.wbName && <Tag color={D.muted}>{p.wbName}</Tag>}
        {p.qualifikation && <Tag color={QUALIFIKATION_COLORS[p.qualifikation]}>{QUALIFIKATION_LABELS[p.qualifikation]}</Tag>}
        <Tag color={D.muted}>üìÖ {fmtDate(p.datum)}</Tag>
        {p.status === "abgeschlossen" && <Tag color={D.green}>‚úì Abgeschlossen</Tag>}
      </div>

      {/* Progress */}
      <ProgressBar items={visibleItems.map(i => ({ done: !!(p.checks || {})[i.id] }))} height={6} />

      <div style={{ marginTop: 16 }}>

        {/* Optionale Versorger toggle (Neuaufnahme) */}
        {p.typ === "neuaufnahme" && optionalItems.length > 0 && (
          <div style={{ background: D.surface2, borderRadius: 7, padding: "10px 13px", marginBottom: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: D.muted, ...mono, marginBottom: 8 }}>OPTIONALE VERSORGER AKTIVIEREN</div>
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
              {optionalItems.map(item => {
                const active = !!(p.aktiveOptional || {})[item.id];
                return (
                  <button key={item.id} onClick={() => toggleOptional(item.id)}
                    style={{ background: active ? D.blue + "30" : D.surface, border: `1px solid ${active ? D.blue : D.border}`, borderRadius: 6, padding: "5px 10px", fontSize: 11, color: active ? D.blue : D.muted, cursor: "pointer", fontFamily: "inherit" }}>
                    {active ? "‚úì " : "+ "}{item.text.replace(": angemeldet", "")}
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Verf√ºgungen (Neuaufnahme) */}
        {p.typ === "neuaufnahme" && (
          <div style={{ background: D.surface2, borderRadius: 7, padding: "10px 13px", marginBottom: 14 }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: D.muted, ...mono, marginBottom: 10 }}>VERF√úGUNGEN</div>
            {[["patientenverfuegung", "Patientenverf√ºgung"], ["betreuungsverfuegung", "Betreuungsverf√ºgung"]].map(([key, label]) => (
              <div key={key} style={{ marginBottom: 10 }}>
                <div style={{ fontSize: 12, color: D.text, marginBottom: 5 }}>{label}</div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                  {VERFUEGUNG_OPTS.map(opt => {
                    const selected = (p.verfuegungen || {})[key] === opt;
                    return (
                      <button key={opt} onClick={() => setVerfuegung(key, opt)}
                        style={{ background: selected ? D.blue + "30" : D.surface, border: `1px solid ${selected ? D.blue : D.border}`, borderRadius: 6, padding: "4px 10px", fontSize: 11, color: selected ? D.blue : D.muted, cursor: "pointer", fontFamily: "inherit" }}>
                        {selected ? "‚óè " : "‚óã "}{opt}
                      </button>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Protokoll-Pflichtabfrage (Wiederaufnahme) */}
        {p.typ === "wiederaufnahme" && (() => {
          const prot = p.protokolle || {};
          const answered = p.protokolleBeantwortet === true;
          const anyLauft = prot.ernaehrung || prot.trinken || prot.schmerz;

          const toggle = (key) => {
            const next = { ...prot, [key]: !prot[key] };
            save({ ...p, protokolle: next, protokolleBeantwortet: true,
              // R√ºckw√§rtskompatibilit√§t
              protokollLauft: next.ernaehrung || next.trinken || next.schmerz });
          };

          const PROTS = [
            { key: "ernaehrung", label: "Ern√§hrungsprotokoll",  icon: "üçΩ",  color: D.orange || "#f97316" },
            { key: "trinken",    label: "Trinkprotokoll",        icon: "üíß",  color: D.blue },
            { key: "schmerz",    label: "Schmerzprotokoll",      icon: "‚öï",  color: D.red },
          ];

          return (
            <div style={{ background: !answered ? D.yellowDim : D.surface2, border: `1px solid ${!answered ? D.yellow : D.border}`, borderRadius: 7, padding: "12px 14px", marginBottom: 14 }}>
              <div style={{ fontSize: 12, fontWeight: 700, color: !answered ? D.yellow : D.text, marginBottom: 4 }}>
                {!answered ? "‚ö† Pflichtabfrage: " : ""}Laufen bereits aktive Protokolle?
              </div>
              <div style={{ fontSize: 11, color: D.muted, marginBottom: 12 }}>
                Bitte f√ºr jedes Protokoll einzeln angeben ob es bereits l√§uft.
              </div>
              <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                {PROTS.map(({ key, label, icon, color }) => {
                  const lauft = prot[key] === true;
                  const nein  = prot[key] === false;
                  return (
                    <div key={key} style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <span style={{ fontSize: 16, width: 22 }}>{icon}</span>
                      <span style={{ fontSize: 12, color: D.text, flex: 1, fontWeight: 600 }}>{label}</span>
                      {[
                        { val: true,  label: "L√§uft bereits", col: D.green },
                        { val: false, label: "Neu starten",   col: color   },
                      ].map(opt => {
                        const active = prot[key] === opt.val;
                        return (
                          <button key={String(opt.val)}
                            onClick={() => {
                              const next = { ...prot, [key]: opt.val };
                              const anyL = Object.values(next).some(v => v === true);
                              save({ ...p, protokolle: next, protokolleBeantwortet: true, protokollLauft: anyL });
                            }}
                            style={{ padding: "5px 11px", fontSize: 11, fontWeight: 600, borderRadius: 6, border: `1px solid ${active ? opt.col : D.border}`, background: active ? opt.col + "30" : "transparent", color: active ? opt.col : D.muted, cursor: "pointer", fontFamily: "inherit" }}>
                            {active ? "‚óè " : "‚óã "}{opt.label}
                          </button>
                        );
                      })}
                    </div>
                  );
                })}
              </div>
              {answered && (
                <div style={{ fontSize: 11, color: D.muted, marginTop: 10, paddingTop: 8, borderTop: `1px solid ${D.border}` }}>
                  {anyLauft
                    ? `‚úì Laufende Protokolle ber√ºcksichtigt: ${[prot.ernaehrung && "Ern√§hrung", prot.trinken && "Trinken", prot.schmerz && "Schmerz"].filter(Boolean).join(", ")}`
                    : "‚úì Alle Protokolle werden neu gestartet."}
                </div>
              )}
            </div>
          );
        })()}

        {/* Checkliste nach Phasen */}
        {phases.map(phase => {
          const phaseItems = visibleItems.filter(i => i.phase === phase);
          // Skip Protokoll items if specific protocol bereits l√§uft
          const prot = p.protokolle || {};
          const filteredItems = phase === "Protokolle"
            ? phaseItems.filter(i => {
                if (!i.requiresProtCheck) return true;
                // Spezifisch ausblenden wenn dieses Protokoll bereits l√§uft
                if (i.id === "wa-13" && prot.schmerz === true) return false;
                if (i.id === "wa-14" && prot.ernaehrung === true) return false;
                if (i.id === "wa-15" && prot.trinken === true) return false;
                // wa-16 (Auswertung) nur ausblenden wenn alle drei laufen
                if (i.id === "wa-16" && prot.schmerz === true && prot.ernaehrung === true && prot.trinken === true) return false;
                return true;
              })
            : phaseItems;
          if (filteredItems.length === 0) return null;

          const phaseDone = filteredItems.filter(i => (p.checks || {})[i.id]).length;
          return (
            <div key={phase} style={{ marginBottom: 16 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", fontSize: 10, fontWeight: 600, color: D.muted, letterSpacing: 1, textTransform: "uppercase", ...mono, marginBottom: 8, paddingBottom: 5, borderBottom: `1px solid ${D.border}` }}>
                <span>{phase}</span>
                <span>{phaseDone}/{filteredItems.length}</span>
              </div>
              {filteredItems.map(item => (
                <label key={item.id} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "7px 0", cursor: "pointer", borderBottom: `1px solid ${D.border}10` }}>
                  <input type="checkbox" checked={!!(p.checks || {})[item.id]}
                    onChange={() => setCheck(item.id, !(p.checks || {})[item.id])}
                    style={{ accentColor: D.blue, marginTop: 2, flexShrink: 0 }} />
                  <span style={{ fontSize: 13, color: (p.checks || {})[item.id] ? D.muted : D.text, textDecoration: (p.checks || {})[item.id] ? "line-through" : "none", lineHeight: 1.4 }}>{item.text}</span>
                </label>
              ))}
            </div>
          );
        })}

        {/* Notizen-Log */}
        <div style={{ marginTop: 16 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
            <Lbl style={{ marginBottom: 0 }}>üìã Notizen-Log</Lbl>
            <span style={{ fontSize: 10, color: D.muted, ...mono }}>Eintr√§ge k√∂nnen nicht bearbeitet werden</span>
          </div>

          {/* Bestehende Eintr√§ge (migriert aus altem Freitextfeld) */}
          {p.notizen && !p.notizLog?.length && (
            <div style={{ background: D.surface2, borderRadius: 7, padding: "10px 12px", marginBottom: 6, borderLeft: `3px solid ${D.muted}` }}>
              <div style={{ fontSize: 13, color: D.text, lineHeight: 1.5, whiteSpace: "pre-wrap" }}>{p.notizen}</div>
              <div style={{ fontSize: 10, color: D.muted, marginTop: 5, ...mono }}>
                √úbernommen aus √§lterer Version ¬∑ {new Date().toLocaleDateString("de-DE", { day:"2-digit", month:"2-digit", year:"numeric" })}
              </div>
            </div>
          )}

          {/* Log-Eintr√§ge */}
          {(p.notizLog || []).length === 0 && !p.notizen && (
            <div style={{ fontSize: 12, color: D.muted, padding: "10px 0", ...mono }}>Noch keine Notizen vorhanden.</div>
          )}
          {(p.notizLog || []).map((n, i) => (
            <div key={n.id} style={{ background: D.surface2, borderRadius: 7, padding: "10px 12px", marginBottom: 6, borderLeft: `3px solid ${D.blue}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: 8 }}>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, color: D.text, lineHeight: 1.5, whiteSpace: "pre-wrap" }}>{n.text}</div>
                  <div style={{ fontSize: 10, color: D.muted, marginTop: 5, ...mono }}>
                    {n.autorLabel || n.autor} ¬∑ {fmtDateTime(n.ts)}
                  </div>
                </div>
                {isPDL && (
                  <button onClick={() => { if (window.confirm("Eintrag l√∂schen?")) deleteNotiz(n.id); }}
                    style={{ background: "none", border: "none", color: D.muted, cursor: "pointer", fontSize: 14, padding: "0 2px", flexShrink: 0, opacity: 0.5 }}
                    title="Nur PDL kann Eintr√§ge l√∂schen">
                    üóë
                  </button>
                )}
              </div>
            </div>
          ))}

          {/* Neue Notiz eingeben */}
          {p.status !== "abgeschlossen" && (
            <div style={{ marginTop: 8 }}>
              <textarea value={newNotiz} onChange={e => setNewNotiz(e.target.value)}
                placeholder="Neue Notiz hinzuf√ºgen‚Ä¶ (wird dauerhaft gespeichert)"
                style={{ width: "100%", background: D.surface2, border: `1px solid ${D.border}`, borderRadius: 7, color: D.text, padding: "8px 11px", fontSize: 13, boxSizing: "border-box", outline: "none", fontFamily: "inherit", height: 60, resize: "vertical" }} />
              <Btn onClick={addNotiz} style={{ marginTop: 6, opacity: newNotiz.trim() ? 1 : 0.4 }}>
                Ôºã Notiz speichern
              </Btn>
            </div>
          )}
        </div>

        {/* Abschlie√üen */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 16 }}>
          <div style={{ fontSize: 12, color: D.muted }}>
            {pct === 100 ? <span style={{ color: D.green }}>‚úì Alle Punkte erledigt</span> : `${done} von ${visibleItems.length} erledigt`}
          </div>
          <div style={{ display: "flex", gap: 8 }}>
            {p.status !== "abgeschlossen" && pct === 100 && (
              <Btn color={D.green} onClick={() => save({ ...p, status: "abgeschlossen", abgeschlossenAm: new Date().toISOString() })}>
                ‚úì Abschlie√üen
              </Btn>
            )}
            {isPDL && <Btn variant="danger" onClick={() => {
              onUpdate({ ...state, prozesse: (state.prozesse || []).filter(x => x.id !== p.id) });
              onClose();
            }}>üóë L√∂schen</Btn>}
          </div>
        </div>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ Neuer Prozess Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NeuProzessModal({ state, onUpdate, role, onClose }) {
  const [typ, setTyp] = useState("neuaufnahme");
  const [wbId, setWbId] = useState(roleIsWBL(role) || roleSL(role) ? roleWbId(role) : "");
  const [qualifikation, setQualifikation] = useState("pflegefachkraft");
  const [mitarbeiterName, setMitarbeiterName] = useState("");
  const [bewohnerId, setBewohnerId] = useState("");
  const [bewohnerName, setBewohnerName] = useState("");
  const [datum, setDatum] = useState(todayStr());
  const now = todayStr();

  // Bewohner im gew√§hlten WB filtern
  const bewohnerImWB = wbId
    ? (state.bewohner || []).filter(b => b.wohnbereichId === wbId)
    : (state.bewohner || []);

  const handleBewohnerChange = (id) => {
    setBewohnerId(id);
    const b = (state.bewohner || []).find(b => b.id === id);
    setBewohnerName(b ? b.name : "");
  };

  const create = () => {
    const wb = state.wohnbereiche.find(w => w.id === wbId);
    const base = { id: uid(), typ, datum, wbId, wbName: wb?.name || "", status: "offen", checks: {}, notizen: "", createdAt: new Date().toISOString() };

    let prozess;
    if (typ === "onboarding") {
      if (!mitarbeiterName.trim()) return;
      prozess = { ...base, titel: `Onboarding: ${mitarbeiterName}`, qualifikation, mitarbeiterName };

      const gespraeche = [
        { label: "Erstgespr√§ch", days: 7 },
        { label: "Zwischengespr√§ch", days: 28 },
        { label: "Zwischengespr√§ch", days: 56 },
        { label: "Abschlussgespr√§ch Probezeit", days: 183 },
      ];
      const autoTasks = gespraeche.map(g => ({
        id: uid(), title: `${g.label} ‚Äì ${mitarbeiterName}`,
        due: addDays(datum, g.days), recur: "none", notes: `Automatisch erstellt ¬∑ Onboarding ${mitarbeiterName}`,
        status: "open", checklist: [], templateId: "", wbId: wbId || "", assignedTo: "",
      }));
      const newTasks = [...autoTasks, ...(state.tasks || [])];
      const qualLabel = QUALIFIKATION_LABELS[qualifikation] || qualifikation;
      const neuerMA = { id: uid(), name: mitarbeiterName, qualifikation: qualLabel, schicht: "", wohnbereichId: wbId || "", eintrittsdatum: datum, status: "aktiv", angelegtDurch: "onboarding" };
      const maExists = (state.mitarbeiter || []).some(m => m.name.toLowerCase() === mitarbeiterName.toLowerCase());
      const newMA = maExists ? state.mitarbeiter : [...(state.mitarbeiter || []), neuerMA];
      onUpdate({ ...state, prozesse: [...(state.prozesse || []), prozess], tasks: newTasks, mitarbeiter: newMA });
      onClose();
      return;
    } else if (typ === "offboarding") {
      if (!mitarbeiterName.trim()) return;
      prozess = { ...base, titel: `Offboarding: ${mitarbeiterName}`, mitarbeiterName };
      const updatedMA = (state.mitarbeiter || []).map(m =>
        m.name.toLowerCase() === mitarbeiterName.toLowerCase() ? { ...m, status: "inaktiv", austrittsdatum: datum } : m
      );
      onUpdate({ ...state, prozesse: [...(state.prozesse || []), prozess], mitarbeiter: updatedMA });
      onClose();
      return;
    } else if (typ === "neuaufnahme") {
      prozess = { ...base, titel: `Neuaufnahme ‚Äì ${fmtDate(datum)}`, verfuegungen: {}, aktiveOptional: {} };
    } else {
      // Wiederaufnahme ‚Äì Bewohner Pflicht
      if (!bewohnerName.trim()) return;
      prozess = { ...base, titel: `Wiederaufnahme ‚Äì ${bewohnerName}`, bewohnerId, bewohnerName, protokollLauft: undefined };
    }

    onUpdate({ ...state, prozesse: [...(state.prozesse || []), prozess] });
    onClose();
  };

  const canCreate = () => {
    if (typ === "onboarding")      return mitarbeiterName.trim().length > 0;
    if (typ === "offboarding")     return mitarbeiterName.trim().length > 0;
    if (typ === "wiederaufnahme")  return bewohnerName.trim().length > 0 && wbId;
    if (typ === "neuaufnahme")     return !!wbId;
    return true;
  };

  return (
    <Modal title="Neuen Prozess starten" onClose={onClose}>
      <Lbl>Art des Prozesses</Lbl>
      <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 14 }}>
        {[
          ["neuaufnahme",    "üè† Neuaufnahme",    D.blue,   true],
          ["wiederaufnahme", "üè• Wiederaufnahme", D.orange, true],
          ["onboarding",     "üë§ Onboarding",     D.green,  !roleSL(role)],
          ["offboarding",    "üëã Offboarding",    D.muted,  !roleSL(role)],
        ].filter(([,,, show]) => show).map(([k, l, c]) => (
          <button key={k} onClick={() => setTyp(k)}
            style={{ flex: 1, minWidth: 120, background: typ === k ? c + "30" : D.surface2, border: `1px solid ${typ === k ? c : D.border}`, borderRadius: 7, padding: "9px 8px", fontSize: 12, fontWeight: 600, color: typ === k ? c : D.muted, cursor: "pointer", fontFamily: "inherit" }}>
            {l}
          </button>
        ))}
      </div>

      <Lbl>Datum</Lbl>
      <Inp type="date" value={datum} onChange={e => setDatum(e.target.value)} />

      {(typ === "neuaufnahme" || typ === "wiederaufnahme") && (
        <>
          <Lbl>Wohnbereich</Lbl>
          <Sel value={wbId} onChange={e => { setWbId(e.target.value); setBewohnerId(""); setBewohnerName(""); }}>
            <option value="">‚Äì Wohnbereich w√§hlen ‚Äì</option>
            {state.wohnbereiche.map(wb => <option key={wb.id} value={wb.id}>{wb.name}</option>)}
          </Sel>
        </>
      )}

      {/* Wiederaufnahme: Bewohner ausw√§hlen */}
      {typ === "wiederaufnahme" && (
        <>
          <Lbl>Bewohner *</Lbl>
          {bewohnerImWB.length > 0 ? (
            <>
              <Sel value={bewohnerId} onChange={e => handleBewohnerChange(e.target.value)}>
                <option value="">‚Äì Bewohner w√§hlen ‚Äì</option>
                {bewohnerImWB.map(b => (
                  <option key={b.id} value={b.id}>{b.name}{b.zimmer ? ` ¬∑ Zi. ${b.zimmer}` : ""}</option>
                ))}
              </Sel>
              {bewohnerName && (
                <div style={{ background: D.orangeDim || D.yellowDim, border: `1px solid ${D.orange || D.yellow}40`, borderRadius: 7, padding: "9px 12px", fontSize: 12, color: D.orange || D.yellow, marginBottom: 10 }}>
                  üè• Wiederaufnahme wird angelegt f√ºr: <strong>{bewohnerName}</strong>
                </div>
              )}
            </>
          ) : (
            <>
              <Inp value={bewohnerName} onChange={e => setBewohnerName(e.target.value)} placeholder="Name des Bewohners" />
              {!wbId && <div style={{ fontSize: 11, color: D.muted, marginBottom: 8, ...mono }}>Zuerst Wohnbereich w√§hlen um Bewohnerliste zu laden.</div>}
              {wbId && bewohnerImWB.length === 0 && <div style={{ fontSize: 11, color: D.muted, marginBottom: 8, ...mono }}>Keine Bewohner in diesem WB importiert ‚Äì Name manuell eingeben.</div>}
            </>
          )}
        </>
      )}

      {typ === "onboarding" && (
        <>
          <Lbl>Name des Mitarbeitenden *</Lbl>
          <Inp value={mitarbeiterName} onChange={e => setMitarbeiterName(e.target.value)} placeholder="Nachname, Vorname" />
          <Lbl>Qualifikation</Lbl>
          <Sel value={qualifikation} onChange={e => setQualifikation(e.target.value)}>
            {Object.entries(QUALIFIKATION_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
          </Sel>
          <div style={{ background: D.blueDim, border: `1px solid ${D.blue}40`, borderRadius: 7, padding: "9px 12px", fontSize: 12, color: D.blue, marginBottom: 10 }}>
            üí° Mitarbeiter wird automatisch in der Wohnbereich-Liste angelegt. Es werden 4 Gespr√§chstermine als Aufgaben erstellt (Woche 1, 4, 8, Monat 6).
          </div>
        </>
      )}

      {typ === "offboarding" && (
        <>
          <Lbl>Name des Mitarbeitenden *</Lbl>
          <Sel value={mitarbeiterName} onChange={e => setMitarbeiterName(e.target.value)}>
            <option value="">‚Äì Person w√§hlen ‚Äì</option>
            {(state.mitarbeiter || []).filter(m => m.status !== "inaktiv").map(m => (
              <option key={m.id} value={m.name}>{m.name} {m.qualifikation ? "¬∑ " + m.qualifikation : ""}</option>
            ))}
          </Sel>
          <div style={{ background: D.yellowDim, border: `1px solid ${D.yellow}40`, borderRadius: 7, padding: "9px 12px", fontSize: 12, color: D.yellow, marginBottom: 10 }}>
            ‚ö† Der Mitarbeiter wird automatisch auf inaktiv gesetzt. Die Fortbildungsdaten bleiben erhalten.
            <br/><span style={{ opacity: .7, marginTop: 4, display: "block" }}>Checkliste Offboarding: Inhalt folgt in einer sp√§teren Version.</span>
          </div>
        </>
      )}

      <div style={{ display: "flex", gap: 10, marginTop: 8 }}>
        <Btn style={{ flex: 1, opacity: canCreate() ? 1 : 0.4, cursor: canCreate() ? "pointer" : "not-allowed" }} onClick={create}>Starten</Btn>
        <Btn variant="secondary" onClick={onClose}>Abbrechen</Btn>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ Hauptansicht ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ProzesseView({ state, onUpdate, role }) {
  const [showNew, setShowNew] = useState(false);
  const [detail, setDetail] = useState(null);
  const [filterTyp, setFilterTyp] = useState("alle");
  const isPDL = role === ROLE_PDL;
  const isWBL = roleIsWBL(role);
  const isSL  = roleSL(role);
  const wbId = isWBL || isSL ? roleWbId(role) : null;

  const alle = (state.prozesse || []);

  // SL sieht nur Neuaufnahme & Wiederaufnahme ‚Äî kein Onboarding/Offboarding
  const myProzesse = (wbId ? alle.filter(p => p.wbId === wbId || !p.wbId) : alle)
    .filter(p => isSL ? (p.typ === "neuaufnahme" || p.typ === "wiederaufnahme") : true);

  const canCreateOnboarding = isPDL || isWBL;
  const canCreateOffboarding = isPDL || isWBL;

  const filtered = myProzesse.filter(p => {
    if (filterTyp === "alle") return true;
    return p.typ === filterTyp;
  });

  const offen = filtered.filter(p => p.status !== "abgeschlossen");
  const abgeschlossen = filtered.filter(p => p.status === "abgeschlossen");

  const typColor = (typ) => typ === "neuaufnahme" ? D.blue : typ === "wiederaufnahme" ? D.orange : typ === "offboarding" ? D.muted : D.green;
  const typIcon  = (typ) => typ === "neuaufnahme" ? "üè†" : typ === "wiederaufnahme" ? "üè•" : typ === "offboarding" ? "üëã" : "üë§";
  const typLabel = (typ) => typ === "neuaufnahme" ? "Neuaufnahme" : typ === "wiederaufnahme" ? "Wiederaufnahme" : typ === "offboarding" ? "Offboarding" : "Onboarding";

  const ProzessCard = ({ p }) => {
    const items = p.typ === "neuaufnahme" ? NEUAUFNAHME_ITEMS.filter(i => !i.optional || (p.aktiveOptional || {})[i.id])
      : p.typ === "wiederaufnahme" ? WIEDERAUFNAHME_ITEMS.filter(i => {
          if (i.requiresProtCheck && p.protokollLauft === true) return false;
          return true;
        })
      : [...ONBOARDING_ITEMS.gemeinsam, ...(ONBOARDING_ITEMS[p.qualifikation] || [])];
    const done = items.filter(i => (p.checks || {})[i.id]).length;
    const pct = items.length ? Math.round(done / items.length * 100) : 0;
    const color = typColor(p.typ);
    const isOv = p.status !== "abgeschlossen" && p.datum < todayStr() && pct < 100;

    return (
      <div onClick={() => setDetail(p)}
        style={{ ...surfaceStyle({ padding: "13px 16px", marginBottom: 7, cursor: "pointer", borderLeft: `3px solid ${p.status === "abgeschlossen" ? D.green : color}` }) }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 }}>
          <div style={{ display: "flex", gap: 10, alignItems: "center", flex: 1 }}>
            <span style={{ fontSize: 20 }}>{typIcon(p.typ)}</span>
            <div>
              <div style={{ fontSize: 13, fontWeight: 600, color: D.text }}>{p.titel}</div>
              <div style={{ fontSize: 10, color: D.muted, marginTop: 2, ...mono }}>
                {p.wbName && <span style={{ color }}>{p.wbName} ¬∑ </span>}
                üìÖ {fmtDate(p.datum)}
                {p.qualifikation && <span style={{ color: QUALIFIKATION_COLORS[p.qualifikation] }}> ¬∑ {QUALIFIKATION_LABELS[p.qualifikation]}</span>}
              </div>
            </div>
          </div>
          <div style={{ display: "flex", gap: 6, alignItems: "center", flexShrink: 0 }}>
            {p.status === "abgeschlossen" ? <Tag color={D.green} small>‚úì Fertig</Tag> : <Tag color={color} small>{pct}%</Tag>}
          </div>
        </div>
        {items.length > 0 && p.status !== "abgeschlossen" && (
          <div style={{ marginTop: 9 }}>
            <ProgressBar items={items.map(i => ({ done: !!(p.checks || {})[i.id] }))} />
          </div>
        )}
      </div>
    );
  };

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <div>
          <div style={{ fontSize: 18, fontWeight: 700, color: D.text, ...sora }}>Prozesse</div>
          <div style={{ fontSize: 11, color: D.muted, marginTop: 2 }}>Neuaufnahmen ¬∑ Wiederaufnahmen ¬∑ Onboarding</div>
        </div>
        <Btn onClick={() => setShowNew(true)}>Ôºã Neuer Prozess</Btn>
      </div>

      {/* Filter */}
      <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
        {[
          ["alle",           "Alle",               myProzesse.length,                                          true],
          ["neuaufnahme",    "üè† Neuaufnahmen",    myProzesse.filter(p => p.typ === "neuaufnahme").length,     true],
          ["wiederaufnahme", "üè• Wiederaufnahmen", myProzesse.filter(p => p.typ === "wiederaufnahme").length,  true],
          ["onboarding",     "üë§ Onboarding",      myProzesse.filter(p => p.typ === "onboarding").length,      !isSL],
          ["offboarding",    "üëã Offboarding",     myProzesse.filter(p => p.typ === "offboarding").length,     !isSL],
        ].filter(([,,, show]) => show).map(([k, l, n]) => (
          <Btn key={k} variant={filterTyp === k ? "primary" : "secondary"} style={{ padding: "5px 11px", fontSize: 11 }} onClick={() => setFilterTyp(k)}>
            {l}{n > 0 && <span style={{ opacity: .6 }}> ({n})</span>}
          </Btn>
        ))}
      </div>

      {offen.length === 0 && abgeschlossen.length === 0 && (
        <div style={{ textAlign: "center", padding: "60px 0", color: D.muted }}>
          <div style={{ fontSize: 40, marginBottom: 10 }}>üìù</div>
          <div style={{ fontSize: 14, fontWeight: 600, color: D.text, marginBottom: 4 }}>Keine Prozesse vorhanden</div>
          <div style={{ fontSize: 12 }}>Starte eine Neuaufnahme, Wiederaufnahme oder ein Onboarding.</div>
        </div>
      )}

      {offen.length > 0 && (
        <>
          <SectionTitle>Laufend ({offen.length})</SectionTitle>
          {offen.map(p => <ProzessCard key={p.id} p={p} />)}
        </>
      )}

      {abgeschlossen.length > 0 && (
        <>
          <SectionTitle>Abgeschlossen ({abgeschlossen.length})</SectionTitle>
          {abgeschlossen.map(p => <ProzessCard key={p.id} p={p} />)}
        </>
      )}

      {showNew && <NeuProzessModal state={state} onUpdate={onUpdate} role={role} onClose={() => setShowNew(false)} />}
      {detail && <ProzessDetailModal prozess={detail} state={state} onUpdate={(s) => { onUpdate(s); setDetail(s.prozesse?.find(x => x.id === detail.id) || null); }} onClose={() => setDetail(null)} role={role} />}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ NACHRICHTEN VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NachrichtenView({ role, state, allMessages, onSend, wbId, myWb }) {
  const [taskContext, setTaskContext] = useState(null);
  if (role === ROLE_PDL) return <PDLChatOverview state={state} allMessages={allMessages} onSend={onSend} role={role} />;
  return (
    <div style={{ height: 560 }}>
      <div style={{ fontSize: 18, fontWeight: 700, color: D.text, marginBottom: 16, ...sora }}>Nachrichten</div>
      <ChatView role={role} wbId={wbId} wbName={myWb?.name || ""} wbColor={myWb?.color}
        allMessages={allMessages} onSend={onSend} taskContext={taskContext} onClearTaskContext={() => setTaskContext(null)} />
    </div>
  );
}


// ‚îÄ‚îÄ‚îÄ DEMO DATA GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateDemoState() {
  const wbs = [
    { id:"wb2", name:"Wohnbereich 2", color:"#2563eb" },
    { id:"wb3", name:"Wohnbereich 3", color:"#16a34a" },
    { id:"wb4", name:"Wohnbereich 4", color:"#d97706" },
    { id:"wb5", name:"Wohnbereich 5", color:"#7c3aed" },
  ];

  const bewohnerNames = [
    "M√ºller, Heinrich","Schmidt, Elfriede","Weber, Gertrude","Fischer, Werner","Meyer, Inge",
    "Wagner, Horst","Becker, Hildegard","Schulz, Erich","Hoffmann, Marianne","Koch, Friedrich",
    "Bauer, Rosa","Richter, Karl","Klein, Lieselotte","Wolf, Hans","Schr√∂der, Martha",
    "Neumann, Willi","Schwarz, Helga","Zimmermann, Otto","Braun, Ursula","Kr√ºger, Rudolf",
  ];

  const maNames = [
    ["Huber, Maria","Pflegefachkraft"],["Braun, Thomas","Pflegefachkraft"],
    ["Keller, Sandra","Wohnbereichsleitung"],["Vogel, Klaus","Pflegehelfer/in"],
    ["Hartmann, Petra","Pflegefachkraft"],["Lange, Andreas","Pflegehelfer/in"],
    ["Werner, Nicole","Pflegefachkraft"],["Krause, Stefan","Sozialdienst"],
    ["Lehmann, Julia","Pflegefachkraft"],["K√∂hler, Michael","Hauswirtschaft"],
    ["Maier, Sabine","Pflegefachkraft"],["Frank, Christian","Pflegehelfer/in"],
    ["Berger, Lisa","Wohnbereichsleitung"],["Roth, Markus","Pflegefachkraft"],
    ["Simon, Anna","Pflegefachkraft"],["K√∂nig, Peter","Pflegehelfer/in"],
  ];

  const bewohner = bewohnerNames.map((name, i) => ({
    id: uid(), name,
    wohnbereichId: wbs[i % 4].id,
    zimmer: String(200 + Math.floor(i/4)*100 + (i%4)*5 + 1),
    pflegegrad: ["PG 2","PG 3","PG 3","PG 4","PG 5"][i % 5],
    geburtsjahr: String(1930 + (i * 3) % 40),
    besonderheiten: i % 5 === 0 ? "Junge Pflege, erh√∂hter Kommunikationsbedarf" : i % 7 === 0 ? "Demenz, Weglauftendenz" : "",
  }));

  const mitarbeiter = maNames.map(([name, qual], i) => ({
    id: uid(), name, qualifikation: qual,
    wohnbereichId: wbs[i % 4].id,
    schicht: ["Fr√ºhdienst","Sp√§tdienst","Tagdienst"][i % 3],
    email: "",
  }));

  const now = todayStr();
  const tasks = [
    { id:uid(), title:"Pflegevisite ‚Äì M√ºller, Heinrich", due:now, recur:"monthly", notes:"Wohnbereich 2 ¬∑ Zi. 201 ¬∑ PG 3", status:"open", templateId:"tpl-pflegevisite", wbId:"wb2", assignedTo:"", checklist: TEMPLATES.find(t=>t.id==="tpl-pflegevisite").items.map(i=>({text:i.text,group:i.group,done:false})) },
    { id:uid(), title:"Hygienebegehung ‚Äì Wohnbereich 3", due:now, recur:"monthly", notes:"Wohnbereich 3", status:"open", templateId:"tpl-hygiene", wbId:"wb3", assignedTo:"", checklist: TEMPLATES.find(t=>t.id==="tpl-hygiene").items.map(i=>({text:i.text,group:i.group,done:false})) },
    { id:uid(), title:"Wunddokumentation pr√ºfen ‚Äì Wohnbereich 4", due:addDays(now,-2), recur:"weekly", notes:"Wohnbereich 4", status:"open", templateId:"tpl-wunddoku", wbId:"wb4", assignedTo:"", checklist: TEMPLATES.find(t=>t.id==="tpl-wunddoku").items.map(i=>({text:i.text,group:i.group,done:Math.random()>0.5})) },
    { id:uid(), title:"MDK-Vorbereitung", due:addDays(now,5), recur:"none", notes:"Alle Wohnbereiche", status:"open", templateId:"tpl-mdk", wbId:"wb2", assignedTo:"", checklist: TEMPLATES.find(t=>t.id==="tpl-mdk").items.map(i=>({text:i.text,group:i.group,done:false})) },
    { id:uid(), title:"Dekubitusprophylaxe ‚Äì Schmidt, Elfriede", due:addDays(now,-1), recur:"monthly", notes:"Wohnbereich 2 ¬∑ Zi. 206 ¬∑ PG 4", status:"open", templateId:"tpl-dekubitus", wbId:"wb2", assignedTo:"", checklist: TEMPLATES.find(t=>t.id==="tpl-dekubitus").items.map(i=>({text:i.text,group:i.group,done:Math.random()>0.6})) },
    { id:uid(), title:"Pflegevisite ‚Äì Weber, Gertrude", due:addDays(now,3), recur:"monthly", notes:"Wohnbereich 3 ¬∑ Zi. 311 ¬∑ PG 2", status:"open", templateId:"tpl-pflegevisite", wbId:"wb3", assignedTo:"", checklist: TEMPLATES.find(t=>t.id==="tpl-pflegevisite").items.map(i=>({text:i.text,group:i.group,done:false})) },
  ];

  const prozesse = [
    { id:uid(), typ:"wiederaufnahme", status:"offen", bewohnerName:"Fischer, Werner", wbId:"wb4", wbName:"Wohnbereich 4", erstellt:new Date(Date.now()-86400000*2).toISOString(), faellig:addDays(now,1), schritte:[ {id:"s1",label:"Krankenhaus kontaktiert",done:true,doneAt:new Date(Date.now()-86400000).toISOString()},{id:"s2",label:"Entlassdatum best√§tigt",done:false},{id:"s3",label:"Zimmer vorbereitet",done:false},{id:"s4",label:"Arzt informiert",done:false},{id:"s5",label:"Bewohner empfangen",done:false} ], notizen:"R√ºckkehr aus St. Marien Krankenhaus nach H√ºft-OP.", notizLog:[], autorLabel:"PDL", protokoll:[] },
    { id:uid(), typ:"aufnahme", status:"offen", bewohnerName:"K√∂nig, Elisabeth", wbId:"wb5", wbName:"Wohnbereich 5", erstellt:new Date(Date.now()-86400000*1).toISOString(), faellig:addDays(now,3), schritte:[ {id:"s1",label:"Erstgespr√§ch gef√ºhrt",done:true,doneAt:new Date().toISOString()},{id:"s2",label:"SIS erstellt",done:false},{id:"s3",label:"Pflegeplanung begonnen",done:false},{id:"s4",label:"Arzt vorgestellt",done:false},{id:"s5",label:"Angeh√∂rige informiert",done:false} ], notizen:"Neuaufnahme PG 3. Familie sehr engagiert.", notizLog:[], autorLabel:"WBL WB5", protokoll:[] },
  ];

  const delegations = [
    { id:uid(), title:"Dienstplan KW "+String(Math.ceil(new Date().getDate()/7)+1)+" pr√ºfen", assignedTo:"wb2", assignedToName:"WBL Wohnbereich 2", dueDate:addDays(now,2), priority:"high", notes:"Bitte auf L√ºcken im Sp√§tdienst achten.", status:"offen", createdAt:new Date().toISOString(), wbColor:"#2563eb" },
    { id:uid(), title:"Hygieneprotokoll Quartal einreichen", assignedTo:"wb3", assignedToName:"WBL Wohnbereich 3", dueDate:addDays(now,7), priority:"normal", notes:"", status:"offen", createdAt:new Date().toISOString(), wbColor:"#16a34a" },
  ];

  return {
    wohnbereiche: wbs,
    bewohner, mitarbeiter, tasks, delegations, prozesse,
    taskLog: [],
    fbData: [],
    einrichtungsname: "Seniorenresidenz Musterstadt",
    einrichtungsnummer: "2140",
  };
}

// ‚îÄ‚îÄ‚îÄ ROOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


// ‚îÄ‚îÄ‚îÄ PWA SETUP (plain JS, not JSX ‚Äî avoids Babel SVG template issue) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupPWA() {
  document.title = "PDL Cockpit";
  var metas = [
    ["apple-mobile-web-app-capable", "yes"],
    ["apple-mobile-web-app-status-bar-style", "black-translucent"],
    ["apple-mobile-web-app-title", "PDL Cockpit"],
    ["theme-color", "#1a1d27"],
  ];
  metas.forEach(function(pair) {
    var m = document.querySelector('meta[name="' + pair[0] + '"]');
    if (!m) { m = document.createElement("meta"); m.name = pair[0]; document.head.appendChild(m); }
    m.content = pair[1];
  });
  var svgIcon = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 180"><rect width="180" height="180" rx="40" fill="#1a1d27"/><text y="125" x="90" text-anchor="middle" font-size="100" font-family="system-ui">üè•</text></svg>');
  var icon = document.querySelector('link[rel="apple-touch-icon"]');
  if (!icon) { icon = document.createElement("link"); icon.rel = "apple-touch-icon"; document.head.appendChild(icon); }
  icon.href = svgIcon;
  var manifest = JSON.stringify({ name:"PDL Cockpit", short_name:"PDL Cockpit", display:"standalone", background_color:"#0f1117", theme_color:"#1a1d27" });
  var blob = new Blob([manifest], { type:"application/json" });
  var mlink = document.querySelector('link[rel="manifest"]');
  if (!mlink) { mlink = document.createElement("link"); mlink.rel = "manifest"; document.head.appendChild(mlink); }
  mlink.href = URL.createObjectURL(blob);
}

// ‚îÄ‚îÄ‚îÄ DYNAMIC STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DynamicStyles() {
  const hover = D.isDark ? "#ffffff0e" : "#00000009";
  const selBg = D.isDark ? "#ffffff14" : "#00000012";
  const inputCs = D.isDark ? "dark" : "light";
  const sidebarBg = D.surface;
  const sidebarBorder = D.border;
  const css = [
    "* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }",
    "body { background:" + D.bg + "!important; color:" + D.text + "; transition:background .25s,color .25s; }",
    "::-webkit-scrollbar { width:4px; } ::-webkit-scrollbar-thumb { background:" + D.border + "; border-radius:99px; }",
    "input,select,textarea { font-family:inherit; font-size:16px!important; color-scheme:" + inputCs + "; }",
    "input:focus,select:focus,textarea:focus { border-color:" + D.blue + "!important; outline:none; box-shadow:0 0 0 3px " + D.blueDim + "; }",
    "button { touch-action:manipulation; }",
    "button:active { opacity:.75; transform:scale(0.97); }",
    ".nav-item:hover { background:" + hover + "!important; }",
    ".nav-item-active { background:" + selBg + "!important; }",
    ".nav-item { min-height:48px; }",
    ".surface-card { background:" + D.surface + "; border:1px solid " + D.border + "; }",
    "@media(max-width:900px) and (min-width:481px) { .sidebar { width:64px!important; } .sidebar-label { display:none!important; } .sidebar-title { display:none!important; } .nav-item { justify-content:center!important; padding:12px 0!important; } .content-pad { padding:20px 14px!important; } }",
    "@media(max-width:480px) { .sidebar { display:none!important; } .mobile-nav { display:flex!important; } .content-pad { padding:16px 12px 80px!important; } }",
    "@media(min-width:481px) { .mobile-nav { display:none!important; } }",
    "@keyframes slideIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }",
  ].join(" ");
  return <style dangerouslySetInnerHTML={{ __html: css }} />;
}

function AppInner() {
  const { show: showToast, ToastContainer } = useToast();
  const [role, setRole]           = useState(null);
  const [state, setState]         = useState(null);
  const [pins, setPins]           = useState(DEFAULT_PINS());
  const [allMessages, setAllMessages] = useState({});
  const [sharedFbData, setSharedFbData] = useState([]);
  const [fbArchive, setFbArchive] = useState([]);
  const [tab, setTab]             = useState("dashboard");
  const [loading, setLoading]     = useState(true);
  const [wbNames, setWbNames]     = useState(WB_NAMES_DEFAULT);
  // Medizinprodukte-State (lokal, Demo-Zwecke)
  const [medGeraete, setMedGeraete]           = useState([]);
  const [medEinweisungen, setMedEinweisungen] = useState([]);
  const [medBewohner, setMedBewohner]         = useState([]);

  // Load all shared data on mount
  useEffect(() => {
    (async () => {
      try {
        const [s, p, msgs, fbD, fbA] = await Promise.all([
          sharedGet(SK_STATE), sharedGet(SK_PINS), sharedGet(SK_MSGS), sharedGet("pdl-v5-fbdata"), sharedGet(SK_FB_ARC)
        ]);
        if (s) {
          const prunedLog = pruneOlderThan(s.taskLog || [], LOG_DAYS, "doneAt");
          setState({ ...s, taskLog: prunedLog });
        } else {
          setState(defaultState());
        }
        if (p) setPins(p);
        if (msgs) setAllMessages(pruneMessages(msgs));
        if (fbD) setSharedFbData(fbD);
        if (fbA) setFbArchive(fbA);
      } catch (err) {
        console.warn("Storage init failed, using defaults:", err);
        setState(defaultState());
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // Update wbNames when state changes
  useEffect(() => {
    if (state) setWbNames(Object.fromEntries(state.wohnbereiche.map(w => [w.id, w.name])));
  }, [state]);

  // Poll for updates every 30s when logged in
  useEffect(() => {
    if (!role) return;
    const interval = setInterval(async () => {
      const [s, msgs, fbD] = await Promise.all([sharedGet(SK_STATE), sharedGet(SK_MSGS), sharedGet("pdl-v5-fbdata")]);
      if (s) setState(s);
      if (msgs) setAllMessages(msgs);
      if (fbD) setSharedFbData(fbD);
    }, 30000);
    return () => clearInterval(interval);
  }, [role]);

  const persist = useCallback(async (next) => { setState(next); await sharedSet(SK_STATE, next); }, []);
  const persistWithToast = useCallback(async (next, msg = "Gespeichert ‚úì") => {
    setState(next); await sharedSet(SK_STATE, next); showToast(msg);
  }, [showToast]);
  const persistPins = useCallback(async (p) => { setPins(p); await sharedSet(SK_PINS, p); }, []);

  const persistMessages = useCallback(async (msgs) => {
    setAllMessages(msgs);
    await sharedSet(SK_MSGS, msgs);
  }, []);

  const handleSendMessage = useCallback(async (msg) => {
    setAllMessages(prev => {
      const channel = pruneOlderThan([...(prev[msg.channelId] || []), msg], MSG_DAYS);
      const updated = pruneMessages({ ...prev, [msg.channelId]: channel });
      sharedSet(SK_MSGS, updated);
      return updated;
    });
  }, []);

  const handleUpdateFbData = useCallback(async (rows) => {
    setSharedFbData(rows);
    await sharedSet("pdl-v5-fbdata", rows);
  }, []);

  const handleUpdateArchive = useCallback(async (arc) => {
    setFbArchive(arc);
    await sharedSet(SK_FB_ARC, arc);
  }, []);

  const handleCreateTask = useCallback((tplId, wb, bewohner) => {
    if (!state) return;
    const tpl = TEMPLATES.find(t => t.id === tplId);
    if (!tpl) return;
    const title = bewohner ? `${tpl.title} ‚Äì ${bewohner.name}` : `${tpl.title} ‚Äì ${wb.name}`;
    const notes = bewohner ? `${wb.name} ¬∑ Zi. ${bewohner.zimmer||"‚Äì"} ¬∑ ${bewohner.pflegegrad}` : wb.name;
    const task = { id: uid(), title, due: todayStr(), recur: tpl.recur, notes, status: "open", templateId: tpl.id, wbId: wb.id, assignedTo: "", checklist: tpl.items.map(i => ({ text: i.text, group: i.group, done: false })) };
    persist({ ...state, tasks: [task, ...state.tasks] });
    setTab("aufgaben");
  }, [state, persist]);

  // PWA setup runs once on mount
  useEffect(() => { setupPWA(); }, []);

  // Fonts werden im HTML-Head geladen ‚Äî kein useEffect n√∂tig

  if (loading) return (
    <div style={{ background: D.bg, minHeight: "100vh", display: "flex", flexDirection:"column", alignItems: "center", justifyContent: "center", gap:12 }}>
      <div style={{ fontSize:36 }}>üè•</div>
      <div style={{ color: D.muted, fontSize: 13, ...mono }}>PDL Cockpit l√§dt‚Ä¶</div>
    </div>
  );

  if (!role) return <LoginScreen onLogin={setRole} wbNames={wbNames} pins={pins} />;

  const NAV = role === ROLE_PDL ? NAV_PDL : roleIsWBL(role) ? NAV_WBL : NAV_SL;
  const wbId = roleIsWBL(role) || roleSL(role) ? roleWbId(role) : null;
  const myWb = wbId ? state.wohnbereiche.find(w => w.id === wbId) : null;

  return (
    <div style={{ display: "flex", minHeight: "100vh", background: D.bg, fontFamily: "Inter, Segoe UI, sans-serif", color: D.text }}>
      <DynamicStyles />

      {/* Sidebar */}
      <div className="sidebar" style={{ width:220, background:D.surface, borderRight:`1px solid ${D.border}`, display:"flex", flexDirection:"column", flexShrink:0, position:"sticky", top:0, height:"100vh", overflowY:"auto", transition:"width .2s, background .25s" }}>
        <div style={{ padding:"20px 16px 16px", borderBottom:`1px solid ${D.border}`, display:"flex", alignItems:"center", gap:10 }}>
          <span style={{ fontSize:22, flexShrink:0 }}>üè•</span>
          <div className="sidebar-title">
            <div style={{ fontSize:14, fontWeight:700, color:D.text, ...sora, lineHeight:1.2 }}>PDL Cockpit</div>
            <div style={{ fontSize:10, color:D.muted, marginTop:2, ...mono }}>
              {role === ROLE_PDL ? "Pflegedienstleitung" : roleIsWBL(role) ? `WBL ¬∑ ${myWb?.name||""}` : `SL ¬∑ ${myWb?.name||""}`}
            </div>
          </div>
        </div>
        <nav style={{ padding:"8px 6px", flex:1 }}>
          {NAV.map(n => {
            const msgBadge = n.k==="nachrichten" && role===ROLE_PDL
              ? Object.values(allMessages).flat().filter(m=>m.role!==ROLE_PDL).length
              : n.k==="nachrichten" && wbId ? (allMessages[wbId]||[]).filter(m=>m.role===ROLE_PDL).length : 0;
            return (
              <button key={n.k} className="nav-item" onClick={() => setTab(n.k)}
                style={{ display:"flex", alignItems:"center", gap:10, width:"100%", padding:"11px 14px", borderRadius:9, border:"none", cursor:"pointer", marginBottom:2, background:tab===n.k?(D.isDark?"#ffffff14":"#00000012"):"transparent", color:tab===n.k?D.text:D.muted, fontSize:13, fontFamily:"inherit", fontWeight:tab===n.k?600:400, textAlign:"left", position:"relative" }}>
                <span style={{ fontSize:19, flexShrink:0 }}>{n.icon}</span>
                <span className="sidebar-label" style={{ flex:1 }}>{n.label}</span>
                {msgBadge>0 && <span className="sidebar-label" style={{ background:D.purple, color:"#fff", borderRadius:99, fontSize:9, fontWeight:700, padding:"1px 6px", ...mono }}>{msgBadge}</span>}
                {msgBadge>0 && <span style={{ position:"absolute", top:8, right:8, width:8, height:8, background:D.purple, borderRadius:"50%" }} className="badge-dot" />}
              </button>
            );
          })}
        </nav>
        <div style={{ padding:"10px 6px", borderTop:`1px solid ${D.border}` }}>
          <button onClick={() => { setRole(null); setTab("dashboard"); }}
            style={{ width:"100%", display:"flex", alignItems:"center", justifyContent:"center", gap:8, background:"none", border:"none", color:D.muted, fontSize:12, cursor:"pointer", padding:"12px", borderRadius:9, fontFamily:"inherit", minHeight:48 }}>
            <span style={{ fontSize:16 }}>‚éã</span>
            <span className="sidebar-label">Abmelden</span>
          </button>
        </div>
      </div>

      {/* Content */}
      <div style={{ flex:1, overflowY:"auto" }}>
        <div className="content-pad" style={{ maxWidth:900, margin:"0 auto", padding:"28px 24px" }}>
          {tab === "dashboard"    && <DashboardView    state={state} role={role} onTabChange={setTab} allMessages={allMessages} />}
          {tab === "wohnbereiche" && <WohnbereicheView state={state} onUpdate={persist} role={role} onCreateTask={handleCreateTask} />}
          {tab === "aufgaben"     && <AufgabenView     state={state} onUpdate={persist} role={role} allMessages={allMessages} onSend={handleSendMessage} wbColor={myWb?.color} onTabChange={setTab} />}
          {tab === "delegation"   && role === ROLE_PDL && <DelegationView state={state} onUpdate={persist} role={role} />}
          {tab === "prozesse"     && <ProzesseView state={state} onUpdate={persist} role={role} />}
          {tab === "nachrichten"  && <NachrichtenView role={role} state={state} allMessages={allMessages} onSend={handleSendMessage} wbId={wbId} myWb={myWb} />}
          {tab === "fortbildung"  && canSeeFortbildung(role) && <FortbildungView role={role} state={state} onUpdate={persist} sharedFbData={sharedFbData} onUpdateFbData={handleUpdateFbData} fbArchive={fbArchive} onUpdateArchive={handleUpdateArchive} />}
          {tab === "medizin"      && <MedizinView state={state} role={role} geraete={medGeraete} setGeraete={setMedGeraete} einweisungen={medEinweisungen} setEinweisungen={setMedEinweisungen} bewohnerGeraete={medBewohner} setBewohnerGeraete={setMedBewohner} />}
          {tab === "settings"     && <EinstellungenView state={state} onUpdate={persist} role={role} pins={pins} onSavePins={persistPins} showToast={showToast} onClearMedizin={() => { setMedGeraete([]); setMedEinweisungen([]); setMedBewohner([]); }} medGeraete={medGeraete} medEinweisungen={medEinweisungen} medBewohner={medBewohner}
            onImportGeraete={e => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>setMedGeraete(parseGeraeteCSV(ev.target.result)); r.readAsText(f,'utf-8'); e.target.value=''; }}
            onImportEinweisungen={e => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>setMedEinweisungen(parseEinweisungenCSV(ev.target.result)); r.readAsText(f,'utf-8'); e.target.value=''; }}
          />
        </div>
      </div>

      <ToastContainer />
      {/* Mobile Bottom-Nav (nur Handy < 481px) */}
      <div className="mobile-nav" style={{ display:"none", position:"fixed", bottom:0, left:0, right:0, background:D.surface, borderTop:`1px solid ${D.border}`, zIndex:100 }}>
        {NAV.slice(0,5).map(n => {
          const msgBadge = n.k==="nachrichten" ? (wbId ? (allMessages[wbId]||[]).filter(m=>m.role===ROLE_PDL).length : Object.values(allMessages).flat().filter(m=>m.role!==ROLE_PDL).length) : 0;
          return (
            <button key={n.k} onClick={() => setTab(n.k)}
              style={{ flex:1, display:"flex", flexDirection:"column", alignItems:"center", gap:3, padding:"10px 0", background:"none", border:"none", cursor:"pointer", color:tab===n.k?D.text:D.muted, minHeight:56, position:"relative" }}>
              <span style={{ fontSize:20 }}>{n.icon}</span>
              <span style={{ fontSize:9, fontWeight:tab===n.k?700:400, ...mono }}>{n.label}</span>
              {msgBadge>0 && <span style={{ position:"absolute", top:6, right:"calc(50% - 14px)", width:8, height:8, background:D.purple, borderRadius:"50%" }} />}
            </button>
          );
        })}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ THEME PROVIDER + ROOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App() {
  const stored = (() => { try { return localStorage.getItem('pdl-theme') || 'dark'; } catch { return 'dark'; } })();
  const [theme, setThemeState] = useState(stored);

  // Sync D object whenever theme changes
  const setTheme = (t) => {
    D = { ...THEMES[t] };
    setThemeState(t);
    try { localStorage.setItem('pdl-theme', t); } catch {}
  };

  // Apply theme on mount and change
  useEffect(() => {
    D = { ...THEMES[theme] };
    document.body.style.background = THEMES[theme].bg;
    document.body.style.colorScheme = theme;
  }, [theme]);

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      <AppInner key={theme} />
    </ThemeContext.Provider>
  );
}

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>